<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spock实例 | jbrrgbxf-</title><meta name="author" content="jbrr_gbxf"><meta name="copyright" content="jbrr_gbxf"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Spock开发实例2. Spock测试所使用的Groovy语言2.1 Groovy 类的风格1234567891011121314151617181920212223242526272829&#x2F;**  Person.groovy的文件内容**&#x2F;class Person &amp;#123;   &#x2F;&#x2F;字段是私有的，并且不需要分号 String firstName  String lastName int ag">
<meta property="og:type" content="article">
<meta property="og:title" content="Spock实例">
<meta property="og:url" content="https://www.jbrrgbxf.com/2020/10/10/SPOCK_FUNCTIONALITY/index.html">
<meta property="og:site_name" content="jbrrgbxf-">
<meta property="og:description" content="Spock开发实例2. Spock测试所使用的Groovy语言2.1 Groovy 类的风格1234567891011121314151617181920212223242526272829&#x2F;**  Person.groovy的文件内容**&#x2F;class Person &amp;#123;   &#x2F;&#x2F;字段是私有的，并且不需要分号 String firstName  String lastName int ag">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-10-10T01:49:09.346Z">
<meta property="article:modified_time" content="2020-10-26T07:05:38.302Z">
<meta property="article:author" content="jbrr_gbxf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.jbrrgbxf.com/2020/10/10/SPOCK_FUNCTIONALITY/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-10-26 15:05:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清單</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音樂</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 電影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 關於</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">jbrrgbxf-</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清單</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音樂</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 電影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 關於</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Spock实例</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-10T01:49:09.346Z" title="发表于 2020-10-10 09:49:09">2020-10-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-10-26T07:05:38.302Z" title="更新于 2020-10-26 15:05:38">2020-10-26</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Spock开发实例"><a href="#Spock开发实例" class="headerlink" title="Spock开发实例"></a>Spock开发实例</h1><h2 id="2-Spock测试所使用的Groovy语言"><a href="#2-Spock测试所使用的Groovy语言" class="headerlink" title="2. Spock测试所使用的Groovy语言"></a>2. Spock测试所使用的Groovy语言</h2><h3 id="2-1-Groovy-类的风格"><a href="#2-1-Groovy-类的风格" class="headerlink" title="2.1 Groovy 类的风格"></a>2.1 Groovy 类的风格</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Person.groovy的文件内容</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span> </span><br><span class="line"> </span><br><span class="line"> <span class="comment">//字段是私有的，并且不需要分号</span></span><br><span class="line"> String firstName </span><br><span class="line"> String lastName</span><br><span class="line"> <span class="keyword">int</span> age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  GettersSettersDemo.groovy的文件内容</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GettersSettersDemo</span> &#123;</span> </span><br><span class="line"> <span class="comment">//main方法的写法类似于java</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) </span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">//可以用java的方式创建类</span></span><br><span class="line"> Person person = <span class="keyword">new</span> Person() </span><br><span class="line"> <span class="comment">//使用自动生成的Set方法赋值</span></span><br><span class="line"> person.setFirstName(<span class="string">&quot;Lyta&quot;</span>) </span><br><span class="line"> person.setLastName(<span class="string">&quot;Alexander&quot;</span>)</span><br><span class="line"> <span class="comment">//使用自动生成的Get方法赋值</span></span><br><span class="line"> System.out.println(<span class="string">&quot;Person first name is </span></span><br><span class="line"><span class="string"> &quot;</span>+person.getFirstName()) </span><br><span class="line"> System.out.println(<span class="string">&quot;Person last name is &quot;</span>+person.getLastName())</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Groovy类的约定"><a href="#2-2-Groovy类的约定" class="headerlink" title="2.2 Groovy类的约定"></a>2.2 Groovy类的约定</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GettersSettersDemo2</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args)    </span><br><span class="line">    &#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person()</span><br><span class="line">        <span class="comment">//这里还是会调用person.setFirstName()        </span></span><br><span class="line">        person.firstName = <span class="string">&quot;Marcus&quot;</span></span><br><span class="line">        person.lastName = <span class="string">&quot;Cole&quot;</span></span><br><span class="line">        <span class="comment">//这里会调用person.getFirstName()</span></span><br><span class="line">        println(<span class="string">&quot;Person first name is &quot;</span>+person.firstName)</span><br><span class="line">        <span class="comment">//println方法会将消息输出到控制台</span></span><br><span class="line">        println(<span class="string">&quot;Person last name is &quot;</span>+person.lastName)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-一个简单的Grogy脚本"><a href="#2-3-一个简单的Grogy脚本" class="headerlink" title="2.3 一个简单的Grogy脚本"></a>2.3 一个简单的Grogy脚本</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span> </span><br><span class="line">    String firstName</span><br><span class="line">    String lastName</span><br><span class="line">    <span class="keyword">int</span> age</span><br><span class="line">    String rank</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//以下的所有代码等同于在java的main方法中</span></span><br><span class="line">Person person = <span class="keyword">new</span> Person()</span><br><span class="line">person.firstName = <span class="string">&quot;Susan &quot;</span></span><br><span class="line">person.lastName = <span class="string">&quot;Ivanova&quot;</span></span><br><span class="line">person.rank = <span class="string">&quot;Commander &quot;</span></span><br><span class="line"><span class="comment">//符号$像jsp一样执行字符串插值</span></span><br><span class="line"><span class="comment">//println方法后面的括号是可选的</span></span><br><span class="line">println <span class="string">&quot;Person first name is $person.firstName&quot;</span></span><br><span class="line">println <span class="string">&quot;Person last name is $person.lastName&quot;</span></span><br><span class="line">println <span class="string">&quot;Person rank is $person.rank&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-用Groovy代码编写的一个Spock测试"><a href="#2-4-用Groovy代码编写的一个Spock测试" class="headerlink" title="2.4 用Groovy代码编写的一个Spock测试"></a>2.4 用Groovy代码编写的一个Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;Testing getters and setters&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;a person has both first name and last name&quot;</span></span><br><span class="line">        SimplePerson person = <span class="keyword">new</span> SimplePerson()</span><br><span class="line">        <span class="comment">//向字段分配值</span></span><br><span class="line">        person.firstName = <span class="string">&quot;Susan&quot;</span></span><br><span class="line">        person.lastName = <span class="string">&quot;Ivanova&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;its title should be surname, name&quot;</span></span><br><span class="line">        <span class="comment">//Spock的断言</span></span><br><span class="line">        person.createTitle() == <span class="string">&quot;Ivanova, Susan&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimplePerson</span> &#123;</span></span><br><span class="line">    String firstName</span><br><span class="line">    String lastName</span><br><span class="line">    <span class="comment">//将被测试的方法</span></span><br><span class="line">    String createTitle()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;$lastName, $firstName&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-创建并使用Groovy中的Java类"><a href="#2-5-创建并使用Groovy中的Java类" class="headerlink" title="2.5 创建并使用Groovy中的Java类"></a>2.5 创建并使用Groovy中的Java类</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//被测试的类是Java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MilitaryPerson</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> String rank;</span><br><span class="line">    <span class="comment">//该方法将会被测试</span></span><br><span class="line">    <span class="keyword">public</span> String createTitle()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> lastName+<span class="string">&quot;, &quot;</span>+firstName +<span class="string">&quot; (&quot;</span>+rank+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String getFirstName() &#123;</span><br><span class="line">        <span class="keyword">return</span> firstName;</span><br><span class="line">    &#125;</span><br><span class="line">    ...more getters and setters here..</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MilitaryPersonSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;Testing getters and setters of a Java class&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;a person has both first, last name and rank&quot;</span></span><br><span class="line">        <span class="comment">//用Groovy创建一个Java类</span></span><br><span class="line">        MilitaryPerson person = <span class="keyword">new</span> MilitaryPerson()</span><br><span class="line">        <span class="comment">//用Groovy的方式给字段赋值</span></span><br><span class="line">        person.firstName = <span class="string">&quot;Susan&quot;</span></span><br><span class="line">        person.lastName = <span class="string">&quot;Ivanova&quot;</span></span><br><span class="line">        <span class="comment">//同样可以用java的Set方法给字段赋值</span></span><br><span class="line">        person.setRank(<span class="string">&quot;Commander&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;its title should be surname, name (rank)&quot;</span></span><br><span class="line">        <span class="comment">//用Groovy的方式调用一个java方法</span></span><br><span class="line">        person.createTitle() == <span class="string">&quot;Ivanova, Susan (Commander)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-Groovy的def来定义变量"><a href="#2-6-Groovy的def来定义变量" class="headerlink" title="2.6 Groovy的def来定义变量"></a>2.6 Groovy的def来定义变量</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用java的方式定义</span></span><br><span class="line">String firstName = <span class="string">&quot;Susan&quot;</span> </span><br><span class="line"><span class="comment">//用Groovy的方式定义</span></span><br><span class="line"><span class="keyword">def</span> lastName = <span class="string">&quot;Ivanova&quot;</span></span><br><span class="line"><span class="keyword">def</span> fullName = <span class="string">&quot;$firstName $lastName&quot;</span></span><br><span class="line">println fullName</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; groovy DefDemo.groovy</span><br><span class="line">Susan Ivanova</span><br></pre></td></tr></table></figure>



<h3 id="2-7-Groovy的def来定义方法"><a href="#2-7-Groovy的def来定义方法" class="headerlink" title="2.7 Groovy的def来定义方法"></a>2.7 Groovy的def来定义方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用def来定义方法的返回类型</span></span><br><span class="line"><span class="keyword">def</span> createName(String firstName,String lastName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$lastName, $firstName&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//用def来定义参数类型</span></span><br><span class="line"><span class="keyword">def</span> createMilitaryName(<span class="keyword">def</span> firstName,<span class="keyword">def</span> lastName, <span class="keyword">def</span> rank)</span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$lastName, $firstName ($rank)&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> fullName = createName <span class="string">&quot;Susan&quot;</span>,<span class="string">&quot;Ivanova&quot;</span></span><br><span class="line">println fullName</span><br><span class="line"><span class="comment">//如果使用至少一个参数，则括号是可选的</span></span><br><span class="line"><span class="keyword">def</span> militaryName = createMilitaryName <span class="string">&quot;Susan&quot;</span>,<span class="string">&quot;Ivanova&quot;</span>,<span class="string">&quot;Commander&quot;</span></span><br><span class="line">println militaryName</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; groovy DefDemo2.groovy</span><br><span class="line">Ivanova, Susan</span><br><span class="line">Ivanova, Susan (Commander)</span><br></pre></td></tr></table></figure>



<h3 id="2-8-在Spock测试中使用动态类型"><a href="#2-8-在Spock测试中使用动态类型" class="headerlink" title="2.8 在Spock测试中使用动态类型"></a>2.8 在Spock测试中使用动态类型</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefDemoSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="comment">//用java的方式来声明方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> trivialSum1() &#123;</span><br><span class="line">        <span class="comment">//仍然使用分号</span></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;number is one&quot;</span>  <span class="keyword">int</span> number =<span class="number">1</span>;</span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;number plus number is two&quot;</span></span><br><span class="line">        number + number ==<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用Groovy来声明方法</span></span><br><span class="line">    <span class="keyword">def</span> trivialSum2() &#123; </span><br><span class="line">        <span class="comment">//分号可选</span></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;number is one&quot;</span></span><br><span class="line">        <span class="keyword">int</span> number = <span class="number">1</span></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;number plus number is two&quot;</span></span><br><span class="line">        number + number ==<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//用一个字符串来作为方法名</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;Testing a trivial sum&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;number is one&quot;</span></span><br><span class="line">        <span class="keyword">def</span> number =<span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;number plus number is two&quot;</span></span><br><span class="line">        number + number ==<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-9-在Groovy中万物皆可boolean"><a href="#2-9-在Groovy中万物皆可boolean" class="headerlink" title="2.9 在Groovy中万物皆可boolean"></a>2.9 在Groovy中万物皆可boolean</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//就像java中一样可以使用boolean变量</span></span><br><span class="line"><span class="keyword">assert</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">assert</span> !<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="literal">true</span> || <span class="literal">false</span></span><br><span class="line"><span class="keyword">assert</span> <span class="literal">true</span> &amp;&amp; !<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//非空的字符串是true</span></span><br><span class="line">String firstName = <span class="string">&quot;Susan&quot;</span></span><br><span class="line"><span class="keyword">assert</span> firstName  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> lastName = <span class="string">&quot;Ivanova&quot;</span></span><br><span class="line"><span class="keyword">assert</span> lastName  </span><br><span class="line"></span><br><span class="line"><span class="comment">//空的字符串是false</span></span><br><span class="line">String empty = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">assert</span> !empty</span><br><span class="line"></span><br><span class="line">Person person = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="comment">//一个有效的引用是true</span></span><br><span class="line"><span class="keyword">assert</span> person;</span><br><span class="line"></span><br><span class="line">Person nullReference = <span class="literal">null</span></span><br><span class="line"><span class="comment">//一个为null的引用是false</span></span><br><span class="line"><span class="keyword">assert</span> !nullReference;</span><br><span class="line"></span><br><span class="line"><span class="comment">//一个非零的数字是true</span></span><br><span class="line"><span class="keyword">int</span> answerToEverything = <span class="number">42</span></span><br><span class="line"><span class="keyword">assert</span> answerToEverything</span><br><span class="line"></span><br><span class="line"><span class="comment">//数字0是false</span></span><br><span class="line"><span class="keyword">int</span> zero=<span class="number">0</span> </span><br><span class="line"><span class="keyword">assert</span> !zero</span><br><span class="line"></span><br><span class="line"><span class="comment">//一个非空的集合是true</span></span><br><span class="line">Object[] array= <span class="keyword">new</span> Object[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">assert</span> array</span><br><span class="line"></span><br><span class="line"><span class="comment">//一个空的集合是false</span></span><br><span class="line">Object[] emptyArray= <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">assert</span> !emptyArray</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果正则表达式至少匹配一次，则为true</span></span><br><span class="line">Pattern myRegex = <span class="regexp">~/needle/</span></span><br><span class="line"><span class="keyword">assert</span> myRegex.matcher(<span class="string">&quot;needle in haystack&quot;</span>)</span><br><span class="line"><span class="keyword">assert</span> !myRegex.matcher(<span class="string">&quot;Wrong haystack&quot;</span>)</span><br><span class="line"></span><br><span class="line">println <span class="string">&quot;Script has finished because all asserts pass&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-10-在Spock测试中使用java的boolean"><a href="#2-10-在Spock测试中使用java的boolean" class="headerlink" title="2.10 在Spock测试中使用java的boolean"></a>2.10 在Spock测试中使用java的boolean</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroovyTruthSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;demo for Groovy truth&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;a line of text is processed&quot;</span></span><br><span class="line">        <span class="comment">//用java创建一个类</span></span><br><span class="line">        WordDetector wordDetector = <span class="keyword">new</span> WordDetector();</span><br><span class="line">        <span class="comment">//用java调用一个方法</span></span><br><span class="line">        wordDetector.parseText(<span class="string">&quot;Understanding is a three edged sword:</span></span><br><span class="line"><span class="string">        your side, their side, and the truth&quot;</span>); </span><br><span class="line">                               </span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;word frequency should be correct&quot;</span> </span><br><span class="line">        <span class="comment">//使用类似Java的断言并明确转换为布尔值</span></span><br><span class="line">        wordDetector.wordsFound() &gt; <span class="number">0</span></span><br><span class="line">        wordDetector.duplicatesFound().size() &gt; <span class="number">0</span> </span><br><span class="line">        <span class="comment">//任何正数将自动变为true</span></span><br><span class="line">        wordDetector.wordsFound()</span><br><span class="line">        <span class="comment">//任何非空集合将自动变为true</span></span><br><span class="line">        wordDetector.duplicatesFound()</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-11-具有多个对象创建语句的JUnit测试"><a href="#2-11-具有多个对象创建语句的JUnit测试" class="headerlink" title="2.11 具有多个对象创建语句的JUnit测试"></a>2.11 具有多个对象创建语句的JUnit测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用作测试输入的java对象</span></span><br><span class="line">Employee trainee = <span class="keyword">new</span> Employee();</span><br><span class="line">trainee.setAge(<span class="number">22</span>);  </span><br><span class="line">trainee.setFirstName(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">trainee.setLastName(<span class="string">&quot;Olson&quot;</span>);  </span><br><span class="line">trainee.setInTraining(<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//用于测试输入的第二个java对象</span></span><br><span class="line">Employee seasoned = <span class="keyword">new</span> Employee();    </span><br><span class="line">seasoned.setAge(<span class="number">45</span>);        </span><br><span class="line">seasoned.setFirstName(<span class="string">&quot;Alex&quot;</span>);  </span><br><span class="line">seasoned.setMiddleName(<span class="string">&quot;Jones&quot;</span>); </span><br><span class="line">seasoned.setLastName(<span class="string">&quot;Corwin&quot;</span>);  </span><br><span class="line"></span><br><span class="line">List&lt;Employee&gt; people = Arrays.asList(trainee,seasoned);</span><br><span class="line"></span><br><span class="line">Department department = <span class="keyword">new</span> Department(); </span><br><span class="line"><span class="comment">//测试数据将被用到</span></span><br><span class="line">department.assign(people);    </span><br><span class="line">[...rest of test]</span><br></pre></td></tr></table></figure>

<h3 id="2-12-测试基于MAP构造方法的Spock测试"><a href="#2-12-测试基于MAP构造方法的Spock测试" class="headerlink" title="2.12 测试基于MAP构造方法的Spock测试"></a>2.12 测试基于MAP构造方法的Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">when:</span></span><br><span class="line"><span class="comment">//用java的方式创建对象</span></span><br><span class="line">Employee trainee = <span class="keyword">new</span>    </span><br><span class="line">    Employee(<span class="attr">age:</span><span class="number">22</span>,<span class="attr">firstName:</span><span class="string">&quot;Alice&quot;</span>,<span class="attr">lastName:</span><span class="string">&quot;Olson&quot;</span>,<span class="attr">inTraining:</span><span class="literal">true</span>)</span><br><span class="line">Employee seasoned = <span class="keyword">new</span>  </span><br><span class="line">    Employee(<span class="attr">middleName:</span><span class="string">&quot;Jones&quot;</span>,<span class="attr">lastName:</span><span class="string">&quot;Corwin&quot;</span>,<span class="attr">age:</span><span class="number">45</span>,<span class="attr">firstName:</span><span class="string">&quot;Alex&quot;</span>)</span><br><span class="line"></span><br><span class="line">List&lt;Employee&gt; people = Arrays.asList(trainee,seasoned)</span><br><span class="line"></span><br><span class="line">Department department = <span class="keyword">new</span> Department()    </span><br><span class="line"><span class="comment">//测试数据将被用到</span></span><br><span class="line">department.assign(people)          </span><br><span class="line">[...rest of test]</span><br></pre></td></tr></table></figure>

<h3 id="2-13-Groovy对比上个例子"><a href="#2-13-Groovy对比上个例子" class="headerlink" title="2.13 Groovy对比上个例子"></a>2.13 Groovy对比上个例子</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Integer&gt; wordCounts = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">wordCounts.put(<span class="string">&quot;Hello&quot;</span>,<span class="number">1</span>); </span><br><span class="line">wordCounts.put(<span class="string">&quot;Java&quot;</span>,<span class="number">1</span>); </span><br><span class="line">wordCounts.put(<span class="string">&quot;World&quot;</span>,<span class="number">2</span>);   </span><br><span class="line"></span><br><span class="line"><span class="comment">//groovy可以创建和输出话map</span></span><br><span class="line">Map&lt;String,Integer&gt; wordCounts2 = [<span class="string">&quot;Hello&quot;</span>:<span class="number">1</span>,<span class="string">&quot;Groovy&quot;</span>:<span class="number">1</span>,<span class="string">&quot;World&quot;</span>:<span class="number">2</span>]</span><br></pre></td></tr></table></figure>

<h3 id="2-14-Groovy-Map类的使用"><a href="#2-14-Groovy-Map类的使用" class="headerlink" title="2.14 Groovy Map类的使用"></a>2.14 Groovy Map类的使用</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用java来实现</span></span><br><span class="line">Employee person1 = <span class="keyword">new</span></span><br><span class="line">    Employee(<span class="attr">firstName:</span><span class="string">&quot;Alice&quot;</span>,<span class="attr">lastName:</span><span class="string">&quot;Olson&quot;</span>,<span class="attr">age:</span><span class="number">30</span>)</span><br><span class="line">Employee person2 = <span class="keyword">new</span>  </span><br><span class="line">    Employee(<span class="attr">firstName:</span><span class="string">&quot;Jones&quot;</span>,<span class="attr">lastName:</span><span class="string">&quot;Corwin&quot;</span>,<span class="attr">age:</span><span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">Address address1 = <span class="keyword">new</span> Address(<span class="attr">street:</span><span class="string">&quot;Marley&quot;</span>,<span class="attr">number:</span><span class="number">25</span>)   </span><br><span class="line">Address address2 = <span class="keyword">new</span> Address(<span class="attr">street:</span><span class="string">&quot;Barnam&quot;</span>,<span class="attr">number:</span><span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">Map&lt;Employee,Address&gt; staffAddresses = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">staffAddresses.put(person1, address1);  </span><br><span class="line">staffAddresses.put(person2, address2);  </span><br><span class="line"></span><br><span class="line"><span class="comment">//用groovy来实现</span></span><br><span class="line">Map&lt;Employee,Address&gt; staffAddresses2 =  </span><br><span class="line">    [(person1):address1,(person2):address2]</span><br></pre></td></tr></table></figure>

<h3 id="2-15-Groovy对比java列表"><a href="#2-15-Groovy对比java列表" class="headerlink" title="2.15 Groovy对比java列表"></a>2.15 Groovy对比java列表</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用java来创建列表</span></span><br><span class="line">List&lt;String&gt; races = Arrays.asList(<span class="string">&quot;Drazi&quot;</span>, <span class="string">&quot;Minbari&quot;</span>, <span class="string">&quot;Humans&quot;</span>)</span><br><span class="line"><span class="comment">//用Groovy来创建列表</span></span><br><span class="line">List&lt;String&gt; races2 = [<span class="string">&quot;Drazi&quot;</span>, <span class="string">&quot;Minbari&quot;</span>, <span class="string">&quot;Humans&quot;</span>]   </span><br><span class="line"></span><br><span class="line"><span class="comment">//这里的==运算符是断言，而不是java中判断相等性身份的运算符</span></span><br><span class="line"><span class="keyword">assert</span> races == races2                </span><br><span class="line"></span><br><span class="line"><span class="comment">//在这里java是有效的，groovy是无效的</span></span><br><span class="line">String[] racesArray = [<span class="string">&quot;Drazi&quot;</span>, <span class="string">&quot;Minbari&quot;</span>, <span class="string">&quot;Humans&quot;</span>]  </span><br><span class="line">String[] racesArrayJava = &#123;<span class="string">&quot;Drazi&quot;</span>, <span class="string">&quot;Minbari&quot;</span>, <span class="string">&quot;Humans&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-16-创建Groovy列表和Map的测试代码"><a href="#2-16-创建Groovy列表和Map的测试代码" class="headerlink" title="2.16 创建Groovy列表和Map的测试代码"></a>2.16 创建Groovy列表和Map的测试代码</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用groovy来初始化</span></span><br><span class="line">List&lt;Employee&gt; people = [    </span><br><span class="line">    <span class="keyword">new</span> Employee(<span class="attr">age:</span><span class="number">22</span>,<span class="attr">firstName:</span><span class="string">&quot;Alice&quot;</span>,<span class="attr">lastName:</span><span class="string">&quot;Olson&quot;</span>,     </span><br><span class="line">                 <span class="symbol">inTraining:</span><span class="literal">true</span>),   </span><br><span class="line">    <span class="keyword">new</span> Employee(<span class="attr">middleName:</span><span class="string">&quot;Jones&quot;</span>,<span class="attr">lastName:</span><span class="string">&quot;Corwin&quot;</span>,<span class="attr">age:</span><span class="number">45</span>,    </span><br><span class="line">                 <span class="symbol">firstName:</span><span class="string">&quot;Alex&quot;</span>)      </span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line"><span class="comment">//进行测试</span></span><br><span class="line">Department department = <span class="keyword">new</span> Department()  </span><br><span class="line">department.assign(people)     </span><br><span class="line">[...rest of test]</span><br></pre></td></tr></table></figure>

<h3 id="2-17-使用Groovy列表"><a href="#2-17-使用Groovy列表" class="headerlink" title="2.17 使用Groovy列表"></a>2.17 使用Groovy列表</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建有两个元素的列表</span></span><br><span class="line">List&lt;String&gt; humanShips = [<span class="string">&quot;Condor&quot;</span>,<span class="string">&quot;Explorer&quot;</span>]  </span><br><span class="line"><span class="comment">//java方式获取元素</span></span><br><span class="line"><span class="keyword">assert</span> humanShips.get(<span class="number">0</span>) == <span class="string">&quot;Condor&quot;</span></span><br><span class="line"><span class="comment">//groovy方式获取元素</span></span><br><span class="line"><span class="keyword">assert</span> humanShips[<span class="number">0</span>] == <span class="string">&quot;Condor&quot;</span>      </span><br><span class="line"></span><br><span class="line"><span class="comment">//java方式增加元素</span></span><br><span class="line">humanShips.add(<span class="string">&quot;Hyperion&quot;</span>)   </span><br><span class="line"><span class="comment">//groovy方式增加元素</span></span><br><span class="line">humanShips &lt;&lt; <span class="string">&quot;Nova&quot;</span> &lt;&lt; <span class="string">&quot;Olympus&quot;</span>   </span><br><span class="line"><span class="keyword">assert</span> humanShips[<span class="number">3</span>] == <span class="string">&quot;Nova&quot;</span></span><br><span class="line"><span class="keyword">assert</span> humanShips[<span class="number">4</span>] == <span class="string">&quot;Olympus&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//groovy方式替换元素</span></span><br><span class="line">humanShips[<span class="number">3</span>] = <span class="string">&quot;Omega&quot;</span>       </span><br><span class="line"><span class="keyword">assert</span> humanShips[<span class="number">3</span>] == <span class="string">&quot;Omega&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-18-使用Groovy-MAP"><a href="#2-18-使用Groovy-MAP" class="headerlink" title="2.18 使用Groovy MAP"></a>2.18 使用Groovy MAP</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//groovy创建一个空的map</span></span><br><span class="line">Map&lt;String,String&gt; personRoles = [:]   </span><br><span class="line"><span class="comment">//java方式来插入</span></span><br><span class="line">personRoles.put(<span class="string">&quot;Suzan Ivanova&quot;</span>,<span class="string">&quot;Lt. Commander&quot;</span>) </span><br><span class="line"><span class="comment">//groovy方式来插入</span></span><br><span class="line">personRoles[<span class="string">&quot;Stephen Franklin&quot;</span>]= <span class="string">&quot;Doctor&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Java的方式来访问</span></span><br><span class="line"><span class="keyword">assert</span> personRoles.get(<span class="string">&quot;Suzan Ivanova&quot;</span>) == <span class="string">&quot;Lt. Commander&quot;</span></span><br><span class="line"><span class="comment">//groovy的方式来访问</span></span><br><span class="line"><span class="keyword">assert</span> personRoles[<span class="string">&quot;Stephen Franklin&quot;</span>] == <span class="string">&quot;Doctor&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">//groovy的方式来替换</span></span><br><span class="line">personRoles[<span class="string">&quot;Suzan Ivanova&quot;</span>]= <span class="string">&quot;Commander&quot;</span>  </span><br><span class="line"><span class="keyword">assert</span> personRoles[<span class="string">&quot;Suzan Ivanova&quot;</span>] == <span class="string">&quot;Commander&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-19-使用Groovy-strings"><a href="#2-19-使用Groovy-strings" class="headerlink" title="2.19 使用Groovy strings"></a>2.19 使用Groovy strings</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用java来创建对象</span></span><br><span class="line">SimpleDepartment sales =  </span><br><span class="line">    <span class="keyword">new</span> SimpleDepartment(<span class="attr">name:</span><span class="string">&quot;Sales&quot;</span>,<span class="attr">location:</span><span class="string">&quot;block C&quot;</span>)</span><br><span class="line">SimpleEmployee employee =    </span><br><span class="line">    <span class="keyword">new</span> SimpleEmployee(<span class="attr">fullName:</span><span class="string">&quot;Andrew Collins&quot;</span>,<span class="attr">age:</span><span class="number">37</span>,<span class="attr">department:</span>sales)</span><br><span class="line"><span class="comment">//java方式来访问字段</span></span><br><span class="line">System.out.println(<span class="string">&quot;Age is &quot;</span>+employee.getAge())  </span><br><span class="line"><span class="comment">//groovy方式</span></span><br><span class="line">println <span class="string">&quot;Age is $employee.age&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//java方式来访问字段</span></span><br><span class="line">System.out.println(<span class="string">&quot;Department location     is at &quot;</span>+employee.getDepartment().getLocation()) </span><br><span class="line"><span class="comment">//groovy方式</span></span><br><span class="line">println <span class="string">&quot;Department location is at $employee.department.location&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//使用&#123;&#125;进行表达式</span></span><br><span class="line">println <span class="string">&quot;Person is adult $&#123;employee.age &gt; 18&#125;&quot;</span></span><br><span class="line"><span class="comment">//转义$符号</span></span><br><span class="line">println <span class="string">&quot;Amount in dollars is \$300&quot;</span></span><br><span class="line"><span class="comment">//使用单引号不进行表达式的使用</span></span><br><span class="line">println <span class="string">&#x27;Person is adult $&#123;employee.age &gt; 18&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;groovy GroovyStrings.groovy</span><br><span class="line">Age is 37</span><br><span class="line">Age is 37</span><br><span class="line">Department location is at block C</span><br><span class="line">Department location is at block C</span><br><span class="line">Person is adult true</span><br><span class="line">Amount in dollars is $300</span><br><span class="line">Person is adult $&#123;employee.age &gt; 18&#125;</span><br></pre></td></tr></table></figure>




<p>张甜 范围：51-70页</p>
<h3 id="2-20-使用Groovy多行字符串"><a href="#2-20-使用Groovy多行字符串" class="headerlink" title="2.20 使用Groovy多行字符串"></a>2.20 使用Groovy多行字符串</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;关于Groovy多行字符串的另一个例子&quot;</span>&#123;</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;正在处理一个段落&quot;</span></span><br><span class="line">    <span class="comment">//创建多行字符串</span></span><br><span class="line">    String input =<span class="string">&#x27;&#x27;&#x27;I want you to know you were right. I didn&#x27;t want \</span></span><br><span class="line"><span class="string">            to admit that. Just pride I guess. You get my age, you \</span></span><br><span class="line"><span class="string">            get kinda set in your ways. It had to be \</span></span><br><span class="line"><span class="string">            done. Don&#x27;t blame yourself for what happened later.&#x27;&#x27;&#x27;</span></span><br><span class="line">    WordDetector wordDetector = <span class="keyword">new</span> WordDetector();</span><br><span class="line">    <span class="comment">//使用多行字符串</span></span><br><span class="line">    wordDetector.parseText(input);</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;单词的数量应该是正确的&quot;</span></span><br><span class="line">    wordDetector.wordsFound() == <span class="number">34</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-21-从文件中读取Spock测试数据"><a href="#2-21-从文件中读取Spock测试数据" class="headerlink" title="2.21 从文件中读取Spock测试数据"></a>2.21 从文件中读取Spock测试数据</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;读取文本文件的例子&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;段落已经过处理&quot;</span></span><br><span class="line">    WordDetector wordDetector = <span class="keyword">new</span> WordDetector();</span><br><span class="line"><span class="comment">//读取整个文本文件</span></span><br><span class="line">    String inputText = <span class="keyword">new</span> File(<span class="string">&quot;src/test/resources/quotes.txt&quot;</span>).text</span><br><span class="line">    wordDetector.parseText(inputText);</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;word frequency应该是正确的&quot;</span></span><br><span class="line">    wordDetector.wordsFound() == <span class="number">78</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;逐行读取文本文件的例子&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;段落已经过处理&quot;</span></span><br><span class="line">    List&lt;String&gt; inputText = <span class="keyword">new</span></span><br><span class="line"><span class="comment">//逐行读取文件</span></span><br><span class="line">    File(<span class="string">&quot;src/test/resources/quotes.txt&quot;</span>).readLines()</span><br><span class="line">    WordDetector wordDetector = <span class="keyword">new</span> WordDetector();</span><br><span class="line">    <span class="keyword">for</span>(String <span class="attr">line:</span>inputText)</span><br><span class="line">    &#123;</span><br><span class="line">        wordDetector.feedText(line)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;单词数量应该是正确的&quot;</span></span><br><span class="line">    wordDetector.wordsFound() == <span class="number">78</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-22-用Groovy读取XML文件"><a href="#2-22-用Groovy读取XML文件" class="headerlink" title="2.22 用Groovy读取XML文件"></a>2.22 用Groovy读取XML文件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> xmlRoot = <span class="keyword">new</span></span><br><span class="line"><span class="comment">//创建XMLSlurper对象</span></span><br><span class="line">    XmlSlurper().parse(<span class="string">&#x27;src/main/resources/employee-data.xml&#x27;</span>)</span><br><span class="line"><span class="comment">//确认XML子节点的数量</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.size() ==<span class="number">1</span></span><br><span class="line"><span class="comment">//访问XML的属性</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.<span class="meta">@name</span> ==<span class="string">&quot;sales&quot;</span></span><br><span class="line"><span class="comment">//确认XML子节点的数量</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee.size() ==<span class="number">2</span></span><br><span class="line"><span class="comment">//访问XML first child的内容</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee[<span class="number">0</span>].firstName ==<span class="string">&quot;Orlando&quot;</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee[<span class="number">0</span>].lastName ==<span class="string">&quot;Boren&quot;</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee[<span class="number">0</span>].age ==<span class="number">24</span></span><br><span class="line"><span class="comment">//访问XML second child的内容</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee[<span class="number">1</span>].firstName ==<span class="string">&quot;Diana&quot;</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee[<span class="number">1</span>].lastName ==<span class="string">&quot;Colgan&quot;</span></span><br><span class="line"><span class="keyword">assert</span> xmlRoot.department.employee[<span class="number">1</span>].age ==<span class="number">28</span></span><br></pre></td></tr></table></figure>
<h3 id="2-23-用Groovy读取JSON文件"><a href="#2-23-用Groovy读取JSON文件" class="headerlink" title="2.23 用Groovy读取JSON文件"></a>2.23 用Groovy读取JSON文件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//创建JsonSlurper对象</span></span><br><span class="line"><span class="keyword">def</span> jsonRoot =</span><br><span class="line">    <span class="keyword">new</span> JsonSlurper().parse(<span class="keyword">new</span></span><br><span class="line">        File(<span class="string">&#x27;src/main/resources/employee-data.json&#x27;</span>))</span><br><span class="line"><span class="comment">//访问Json领域</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.name ==<span class="string">&quot;sales&quot;</span></span><br><span class="line"><span class="comment">//确认Json数据的大小</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee.size() ==<span class="number">2</span></span><br><span class="line"><span class="comment">//访问数组内第一个元素</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee[<span class="number">0</span>].firstName ==<span class="string">&quot;Orlando&quot;</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee[<span class="number">0</span>].lastName ==<span class="string">&quot;Boren&quot;</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee[<span class="number">0</span>].age ==<span class="string">&quot;24&quot;</span></span><br><span class="line"><span class="comment">//访问数组内第二个元素</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee[<span class="number">1</span>].firstName ==<span class="string">&quot;Diana&quot;</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee[<span class="number">1</span>].lastName ==<span class="string">&quot;Colgan&quot;</span></span><br><span class="line"><span class="keyword">assert</span> jsonRoot.staff.department.employee[<span class="number">1</span>].age ==<span class="string">&quot;28&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-24-Groovy闭包"><a href="#2-24-Groovy闭包" class="headerlink" title="2.24 Groovy闭包"></a>2.24 Groovy闭包</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//一个Groovy特征的闭包：求整型参数的2倍</span></span><br><span class="line">Closure simple = &#123; <span class="keyword">int</span> x -&gt; <span class="keyword">return</span> x * <span class="number">2</span>&#125;</span><br><span class="line"><span class="comment">//使用闭包方法</span></span><br><span class="line"><span class="keyword">assert</span> simple(<span class="number">3</span>) == <span class="number">6</span></span><br><span class="line"><span class="comment">//同样的闭包使用简洁的Groovy，返回也是可选的。</span></span><br><span class="line"><span class="keyword">def</span> simpler = &#123; x -&gt; x * <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">assert</span> simpler(<span class="number">3</span>) == <span class="number">6</span></span><br><span class="line"><span class="comment">//带有两个参数的闭包</span></span><br><span class="line"><span class="keyword">def</span> twoArguments = &#123; x,y -&gt; x + y&#125;</span><br><span class="line"><span class="keyword">assert</span> twoArguments(<span class="number">3</span>,<span class="number">5</span>) ==<span class="number">8</span></span><br></pre></td></tr></table></figure>
<h3 id="2-25-在Spoke测试中使用Groovy闭包"><a href="#2-25-在Spoke测试中使用Groovy闭包" class="headerlink" title="2.25 在Spoke测试中使用Groovy闭包"></a>2.25 在Spoke测试中使用Groovy闭包</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;测试Jpeg文件&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;当在文件名列表中选择jpeg文件&quot;</span></span><br><span class="line">    <span class="comment">//创建被测试的Java类</span></span><br><span class="line">    FileExtensionFilter myFilter = <span class="keyword">new</span> FileExtensionFilter()</span><br><span class="line">    <span class="comment">//设置可接受的文件扩展名</span></span><br><span class="line">    myFilter.addValidExtension(<span class="string">&quot;jpeg&quot;</span>)</span><br><span class="line">    myFilter.addValidExtension(<span class="string">&quot;jpg&quot;</span>)</span><br><span class="line">    <span class="comment">//列出将被接受并将通过测试的类</span></span><br><span class="line">    List&lt;String&gt; testInput = [<span class="string">&quot;image1.jpg&quot;</span>,<span class="string">&quot;image2.png&quot;</span>,<span class="string">&quot;image3.jpeg&quot;</span>,<span class="string">&quot;image4.gif&quot;</span>,<span class="string">&quot;image5.jpg&quot;</span>,<span class="string">&quot;image6.tiff&quot;</span>]</span><br><span class="line">    <span class="comment">//方法调用的结果是另一个列表。</span></span><br><span class="line">    List&lt;String&gt; result = myFilter.filterFileNames(testInput)</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;result should not contain other types&quot;</span></span><br><span class="line">    <span class="comment">//使用闭包来测试列表中的每个元素</span></span><br><span class="line">    result.every&#123; filename -&gt; filename.endsWith(<span class="string">&quot;jpeg&quot;</span>) || filename.endsWith(<span class="string">&quot;jpg&quot;</span>)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-26-Java中的域类"><a href="#2-26-Java中的域类" class="headerlink" title="2.26 Java中的域类"></a>2.26 Java中的域类</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AssetInventory</span> &#123;</span></span><br><span class="line">    <span class="comment">//列表已经初始化</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Ship&gt; ships = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> [...getters and setters here...]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ship</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;CrewMember&gt; crewMembers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> String destination;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Cargo&gt; cargos= <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">[...getters and setters here...]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrewMember</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span> String firstName;</span><br><span class="line"> <span class="keyword">private</span> String lastName;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">[...getters and setters here...]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cargo</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span> String type;</span><br><span class="line"> <span class="comment">//字段名与类名相同。</span></span><br><span class="line"> <span class="keyword">private</span> CargoOrder cargoOrder; </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">float</span> tons;</span><br><span class="line">[...getters and setters here...]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CargoOrder</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span> String buyer;</span><br><span class="line"> <span class="keyword">private</span> String city;</span><br><span class="line"> <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">[...getters and setters here...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-27-使用Groovy构建器快速创建对象"><a href="#2-27-使用Groovy构建器快速创建对象" class="headerlink" title="2.27 使用Groovy构建器快速创建对象"></a>2.27 使用Groovy构建器快速创建对象</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//创建一个构建器</span></span><br><span class="line">ObjectGraphBuilder builder = <span class="keyword">new</span> ObjectGraphBuilder()</span><br><span class="line"><span class="comment">//指示该域Java包的构建器</span></span><br><span class="line">builder.classNameResolver = <span class="string">&quot;com.manning.spock.chapter2.assets&quot;</span></span><br><span class="line"><span class="comment">//使用顶级对象的构建器</span></span><br><span class="line">AssetInventory shipRegistry = builder.assetInventory() &#123;</span><br><span class="line">    ship ( <span class="attr">name:</span> <span class="string">&quot;Sea Spirit&quot;</span>, <span class="attr">destination:</span><span class="string">&quot;Chiba&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">//基于映射的构造函数</span></span><br><span class="line">        crewMember(<span class="attr">firstName:</span><span class="string">&quot;Michael&quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Curiel&quot;</span>,<span class="attr">age:</span><span class="number">43</span>) </span><br><span class="line">        crewMember(<span class="attr">firstName:</span><span class="string">&quot;Sean&quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Parker&quot;</span>,<span class="attr">age:</span><span class="number">28</span>)</span><br><span class="line">        crewMember(<span class="attr">firstName:</span><span class="string">&quot;Lillian &quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Zimmerman&quot;</span>,<span class="attr">age:</span><span class="number">32</span>)</span><br><span class="line">        cargo(<span class="attr">type:</span><span class="string">&quot;Cotton&quot;</span>, <span class="attr">tons:</span><span class="number">5.4</span>) &#123;</span><br><span class="line">            <span class="comment">//子节点自动创建并附加到父节点</span></span><br><span class="line">            cargoOrder ( <span class="attr">buyer:</span> <span class="string">&quot;ReiHosokawa&quot;</span>,<span class="attr">city:</span><span class="string">&quot;Yokohama&quot;</span>,<span class="attr">price:</span><span class="number">34000</span>)</span><br><span class="line">            cargo(<span class="attr">type:</span><span class="string">&quot;Olive Oil&quot;</span>, <span class="attr">tons:</span><span class="number">3.0</span>) &#123;</span><br><span class="line">                cargoOrder ( <span class="attr">buyer:</span> <span class="string">&quot;Hirokumi Kasaya&quot;</span>,<span class="attr">city:</span><span class="string">&quot;Kobe&quot;</span>,<span class="attr">price:</span><span class="number">27000</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                ship ( <span class="attr">name:</span> <span class="string">&quot;Calypso I&quot;</span>, <span class="attr">destination:</span><span class="string">&quot;Bristol&quot;</span>) &#123;</span><br><span class="line">                    crewMember(<span class="attr">firstName:</span><span class="string">&quot;Eric&quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Folkes&quot;</span>,<span class="attr">age:</span><span class="number">35</span>)</span><br><span class="line">                    crewMember(<span class="attr">firstName:</span><span class="string">&quot;Louis&quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Lessard&quot;</span>,<span class="attr">age:</span><span class="number">22</span>)</span><br><span class="line">                    cargo(<span class="attr">type:</span><span class="string">&quot;Oranges&quot;</span>, <span class="attr">tons:</span><span class="number">2.4</span>) &#123;</span><br><span class="line">                        cargoOrder ( <span class="attr">buyer:</span> <span class="string">&quot;Gregory Schmidt&quot;</span>,<span class="attr">city:</span><span class="string">&quot;Manchester&quot;</span>,<span class="attr">price:</span><span class="number">62000</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ship ( <span class="attr">name:</span> <span class="string">&quot;Desert Glory&quot;</span>, <span class="attr">destination:</span><span class="string">&quot;Los Angeles&quot;</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    crewMember(<span class="attr">firstName:</span><span class="string">&quot;Michelle&quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Kindred&quot;</span>,<span class="attr">age:</span><span class="number">38</span>)</span><br><span class="line">                    crewMember(<span class="attr">firstName:</span><span class="string">&quot;Kathy&quot;</span>, <span class="attr">lastName:</span><span class="string">&quot;Parker&quot;</span>,<span class="attr">age:</span><span class="number">21</span>)</span><br><span class="line">                    cargo(<span class="attr">type:</span><span class="string">&quot;Timber&quot;</span>, <span class="attr">tons:</span><span class="number">4.8</span>) &#123;</span><br><span class="line">                    cargoOrder ( <span class="attr">buyer:</span> <span class="string">&quot;Carolyn Cox&quot;</span>,<span class="attr">city:</span><span class="string">&quot;Sacramento&quot;</span>,<span class="attr">price:</span><span class="number">18000</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">assert</span> shipRegistry.ships.size == <span class="number">3</span></span><br><span class="line">    <span class="keyword">assert</span> shipRegistry.ships[<span class="number">0</span>].name == <span class="string">&quot;Sea Spirit&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> shipRegistry.ships[<span class="number">1</span>].crewMembers.size == <span class="number">2</span></span><br><span class="line">    <span class="keyword">assert</span> shipRegistry.ships[<span class="number">1</span>].crewMembers[<span class="number">0</span>].firstName == <span class="string">&quot;Eric&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> shipRegistry.ships[<span class="number">2</span>].cargos[<span class="number">0</span>].type==<span class="string">&quot;Timber&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> shipRegistry.ships[<span class="number">2</span>].cargos[<span class="number">0</span>].cargoOrder.city==<span class="string">&quot;Sacramento&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-28-使用Expando模拟接口"><a href="#2-28-使用Expando模拟接口" class="headerlink" title="2.28 使用Expando模拟接口"></a>2.28 使用Expando模拟接口</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;测试无效地址检测&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;地址没有邮政编码&quot;</span></span><br><span class="line">    <span class="comment">//创建测试数据</span></span><br><span class="line">    Address address = <span class="keyword">new</span> Address(<span class="attr">country:</span><span class="string">&quot;Greece&quot;</span>,<span class="attr">number:</span><span class="number">23</span>)</span><br><span class="line">    <span class="comment">//创建空的Groovy动态对象</span></span><br><span class="line">    <span class="keyword">def</span> dummyAddressDao = <span class="keyword">new</span> Expando()</span><br><span class="line">    <span class="comment">//动态创建加载方法</span></span><br><span class="line">    dummyAddressDao.load = &#123; <span class="keyword">return</span> address&#125;</span><br><span class="line">    <span class="comment">//使用Groovy动态对象代替Java接口</span></span><br><span class="line">    Stamper stamper = <span class="keyword">new</span> Stamper(dummyAddressDao <span class="keyword">as</span> AddressDao)</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;这个地址被拒绝&quot;</span></span><br><span class="line">    <span class="comment">//欺骗被测试的类使用Expando——参数是不相关的。</span></span><br><span class="line">    !stamper.isValid(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;测试无效和有效地址检测&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;检查两个不同的地址&quot;</span></span><br><span class="line">        <span class="comment">//包括两种情况</span></span><br><span class="line">        Address invalidAddress = <span class="keyword">new</span> Address(<span class="attr">country:</span><span class="string">&quot;Greece&quot;</span>,<span class="attr">number:</span><span class="number">23</span>)</span><br><span class="line">        Address validAddress = <span class="keyword">new</span> Address(<span class="attr">country:</span><span class="string">&quot;Greece&quot;</span>,<span class="attr">number:</span><span class="number">23</span>,<span class="attr">street:</span><span class="string">&quot;Argous&quot;</span>, <span class="attr">postCode:</span><span class="string">&quot;4534&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> dummyAddressDao = <span class="keyword">new</span> Expando()</span><br><span class="line">        <span class="comment">//使用闭包参数返回测试输入</span></span><br><span class="line">        dummyAddressDao.load = &#123; id -&gt; <span class="keyword">return</span> id==<span class="number">2</span>?validAddress:invalidAddress&#125;</span><br><span class="line">        Stamper stamper = <span class="keyword">new</span> Stamper(dummyAddressDao <span class="keyword">as</span> AddressDao)</span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;Only the address with street and postcode is accepted&quot;</span></span><br><span class="line">        <span class="comment">//在Expando闭包中调用测试参数下的类</span></span><br><span class="line">        !stamper.isValid(<span class="number">1</span>)</span><br><span class="line">        stamper.isValid(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h3 id="2-29-使用一个Groovy-Expando作为测试数据生成器"><a href="#2-29-使用一个Groovy-Expando作为测试数据生成器" class="headerlink" title="2.29 使用一个Groovy Expando作为测试数据生成器"></a>2.29 使用一个Groovy Expando作为测试数据生成器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//创建空的Groovy动态对象</span></span><br><span class="line">Expando smartIterator = <span class="keyword">new</span> Expando()</span><br><span class="line"><span class="comment">//创建将保存下一个数字的字段</span></span><br><span class="line">smartIterator.counter = <span class="number">0</span>; </span><br><span class="line"><span class="comment">//创建将保存返回的最大值的字段</span></span><br><span class="line">smartIterator.limit = <span class="number">4</span>; </span><br><span class="line"><span class="comment">//模仿迭代器接口方法</span></span><br><span class="line">smartIterator.hasNext = &#123; <span class="keyword">return</span> counter &lt; limit&#125; </span><br><span class="line">smartIterator.next = &#123;<span class="keyword">return</span> counter++&#125; </span><br><span class="line"><span class="comment">//在iterator接口中添加未定义的自定义方法</span></span><br><span class="line">smartIterator.restartFrom = &#123;from-&gt;counter = from&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用Expando代替迭代器</span></span><br><span class="line"><span class="keyword">for</span>(Integer <span class="attr">number:</span>smartIterator <span class="keyword">as</span> Iterator&lt;Integer&gt;) </span><br><span class="line">&#123;</span><br><span class="line">    println <span class="string">&quot;Next number is $number&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">println <span class="string">&quot;Reset smart iterator&quot;</span></span><br><span class="line"><span class="comment">//调用自定义方法来更改迭代器的状态</span></span><br><span class="line">smartIterator.restartFrom(2)#</span><br><span class="line"></span><br><span class="line"><span class="comment">//在重新设置后使用Expando</span></span><br><span class="line"><span class="keyword">for</span>(Integer <span class="attr">number:</span>smartIterator <span class="keyword">as</span> Iterator&lt;Integer&gt;)</span><br><span class="line">&#123;</span><br><span class="line">    println <span class="string">&quot;Next number is $number&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-Spock的功能"><a href="#3-Spock的功能" class="headerlink" title="3. Spock的功能"></a>3. Spock的功能</h2><h3 id="3-1-一个Java的火控系统"><a href="#3-1-一个Java的火控系统" class="headerlink" title="3.1 一个Java的火控系统"></a>3.1 一个Java的火控系统</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现监视的主类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FireEarlyWarning</span> &#123;</span></span><br><span class="line">    <span class="comment">//Method called every second by sensor software 方法称为每秒钟由传感器软件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> feedData(<span class="keyword">int</span> triggeredFireSensors)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//简洁起见的修改-查看完整代码的源代码</span></span><br><span class="line">        [...在此处实现...] </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//状态报告获取方法</span></span><br><span class="line">    <span class="keyword">public</span> WarningStatus getCurrentStatus() </span><br><span class="line">    &#123;</span><br><span class="line">        [...implementation here...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//状态报告内容(状态类)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WarningStatus</span> &#123;</span></span><br><span class="line">    <span class="comment">//若为true，警报就会响起。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isAlarmActive() &#123; </span><br><span class="line">        [...implementation here...]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若为true，就呼叫消防队。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isFireDepartmentNotified() &#123; </span><br><span class="line">        [...implementation here...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-火控系统的JUnit测试"><a href="#3-2-火控系统的JUnit测试" class="headerlink" title="3.2 火控系统的JUnit测试"></a>3.2 火控系统的JUnit测试</h3> <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JUnit测试用例</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> fireAlarmScenario() &#123; </span><br><span class="line">    <span class="comment">//测试所需的设置</span></span><br><span class="line">    FireEarlyWarning fireEarlyWarning = <span class="keyword">new</span> FireEarlyWarning(); </span><br><span class="line">    <span class="keyword">int</span> triggeredSensors = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//创建一个事件</span></span><br><span class="line">    fireEarlyWarning.feedData(triggeredSensors); </span><br><span class="line">    WarningStatus status = fireEarlyWarning.getCurrentStatus();</span><br><span class="line">    <span class="comment">//检查事件的结果</span></span><br><span class="line">    assertTrue(<span class="string">&quot;Alarm sounds&quot;</span>, status.isAlarmActive()); </span><br><span class="line">    assertFalse(<span class="string">&quot;No notifications&quot;</span>, status.isFireDepartmentNotified());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-具有复杂结构的JUnit测试-实际示例"><a href="#3-3-具有复杂结构的JUnit测试-实际示例" class="headerlink" title="3.3 具有复杂结构的JUnit测试(实际示例)"></a>3.3 具有复杂结构的JUnit测试(实际示例)</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MASTER_NAME = <span class="string">&quot;mymaster&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HostAndPort sentinel = <span class="keyword">new</span> HostAndPort(<span class="string">&quot;localhost&quot;</span>,<span class="number">26379</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> sentinelSet() &#123;</span><br><span class="line">    Jedis j = <span class="keyword">new</span> Jedis(sentinel.getHost(), sentinel.getPort());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; parameterMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        parameterMap.put(<span class="string">&quot;down-after-milliseconds&quot;</span>, String.valueOf(<span class="number">1234</span>));</span><br><span class="line">        parameterMap.put(<span class="string">&quot;parallel-syncs&quot;</span>, String.valueOf(<span class="number">3</span>));</span><br><span class="line">        parameterMap.put(<span class="string">&quot;quorum&quot;</span>, String.valueOf(<span class="number">2</span>));</span><br><span class="line">        j.sentinelSet(MASTER_NAME, parameterMap);</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; masters = j.sentinelMasters();</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, String&gt; <span class="attr">master :</span> masters) &#123;</span><br><span class="line">            <span class="keyword">if</span> (master.get(<span class="string">&quot;name&quot;</span>).equals(MASTER_NAME)) &#123;</span><br><span class="line">                assertEquals(<span class="number">1234</span>, Integer.parseInt(master.get(<span class="string">&quot;down-after-milliseconds&quot;</span>)));</span><br><span class="line">                assertEquals(<span class="number">3</span>,Integer.parseInt(master.get(<span class="string">&quot;parallel- syncs&quot;</span>)));</span><br><span class="line">                assertEquals(<span class="number">2</span>,Integer.parseInt(master.get(<span class="string">&quot;quorum&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         parameterMap.put(<span class="string">&quot;quorum&quot;</span>, String.valueOf(<span class="number">1</span>));</span><br><span class="line">        j.sentinelSet(MASTER_NAME, parameterMap);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">             j.close();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-JUnit测试测试两件事——不要这样做"><a href="#3-4-JUnit测试测试两件事——不要这样做" class="headerlink" title="3.4 JUnit测试测试两件事——不要这样做"></a>3.4 JUnit测试测试两件事——不要这样做</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> sensorsAreTriggered() &#123;</span><br><span class="line">    <span class="comment">//准备阶段</span></span><br><span class="line">    FireEarlyWarning fireEarlyWarning = <span class="keyword">new</span> FireEarlyWarning();</span><br><span class="line">    <span class="comment">//激励阶段</span></span><br><span class="line">    fireEarlyWarning.feedData(<span class="number">1</span>);</span><br><span class="line">    WarningStatus status = fireEarlyWarning.getCurrentStatus();</span><br><span class="line">    <span class="comment">//第一次维护阶段</span></span><br><span class="line">    assertTrue(<span class="string">&quot;Alarm sounds&quot;</span>, status.isAlarmActive());</span><br><span class="line">    assertFalse(<span class="string">&quot;No notifications&quot;</span>, status.isFireDepartmentNotified());</span><br><span class="line">    <span class="comment">//另一个激励阶段——这是一种糟糕的做法</span></span><br><span class="line">    fireEarlyWarning.feedData(<span class="number">2</span>);</span><br><span class="line">    WarningStatus status2 = fireEarlyWarning.getCurrentStatus();</span><br><span class="line">    <span class="comment">//第二次维护阶段</span></span><br><span class="line">    assertTrue(<span class="string">&quot;Alarm sounds&quot;</span>, status2.isAlarmActive());</span><br><span class="line">    assertTrue(<span class="string">&quot;Fire Department is notified&quot;</span>,status2.isFireDepartmentNotified());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-火控系统的全部Spock测试"><a href="#3-5-火控系统的全部Spock测试" class="headerlink" title="3.5 火控系统的全部Spock测试"></a>3.5 火控系统的全部Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FireSensorSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="comment">//清楚地解释这个测试的作用</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;如果所有传感器都不活动，那么一切都没问题&quot;</span>() &#123;</span><br><span class="line">        <span class="comment">//准备阶段</span></span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;所有的火灾传感器都关闭了&quot;</span> </span><br><span class="line">        FireEarlyWarning fireEarlyWarning = <span class="keyword">new</span> FireEarlyWarning()</span><br><span class="line">        <span class="keyword">int</span> triggeredSensors = <span class="number">0</span></span><br><span class="line">        <span class="comment">//激励阶段</span></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;我们询问消防状况&quot;</span> </span><br><span class="line">        fireEarlyWarning.feedData(triggeredSensors)</span><br><span class="line">        WarningStatus status = fireEarlyWarning.getCurrentStatus()</span><br><span class="line">        <span class="comment">//维护阶段</span></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;不应触发警报/通知&quot;</span> </span><br><span class="line">        !status.alarmActive </span><br><span class="line">        !status.fireDepartmentNotified</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;如果一个传感器是启动的，警报应该发出预防措施&quot;</span>() &#123; </span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;只有一个火情传感器是启动的&quot;</span></span><br><span class="line">        FireEarlyWarning fireEarlyWarning = <span class="keyword">new</span> FireEarlyWarning()</span><br><span class="line">        <span class="keyword">int</span> triggeredSensors = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;我们询问消防状况&quot;</span></span><br><span class="line">        fireEarlyWarning.feedData(triggeredSensors)</span><br><span class="line">        WarningStatus status = fireEarlyWarning.getCurrentStatus()</span><br><span class="line"></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;只应触发警报&quot;</span></span><br><span class="line">        status.alarmActive</span><br><span class="line">        !status.fireDepartmentNotified</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">def</span> <span class="string">&quot;如果不止一个传感器处于启动状态，且我们着火了&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;两个火灾传感器已经启动&quot;</span></span><br><span class="line">        FireEarlyWarning fireEarlyWarning = <span class="keyword">new</span> FireEarlyWarning()</span><br><span class="line">        <span class="keyword">int</span> triggeredSensors = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;我们询问消防状况&quot;</span></span><br><span class="line">        fireEarlyWarning.feedData(triggeredSensors)</span><br><span class="line">        WarningStatus status = fireEarlyWarning.getCurrentStatus()</span><br><span class="line"></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;警报被触发，消防部门被通知&quot;</span></span><br><span class="line">        status.alarmActive</span><br><span class="line">        status.fireDepartmentNotified</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>吴灿灿 范围：71-90页</p>
<h3 id="3-6-使用JUnit测试核反应的场景"><a href="#3-6-使用JUnit测试核反应的场景" class="headerlink" title="3.6 使用JUnit测试核反应的场景"></a>3.6 使用JUnit测试核反应的场景</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Parameterized.class文件内容</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//参数化测试所需的专用运行器是使用@RunWith创建的</span></span><br><span class="line"><span class="meta">@RunWith</span>(Parameterized.<span class="keyword">class</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NuclearReactorTest</span>&#123;</span></span><br><span class="line">    <span class="comment">//定义3个输入字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> triggeredFireSensors;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Float&gt; radiationDataReadings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> pressure;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义3个输出字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> expectedAlarmStatus;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> expectedShutdownCommand;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> expectedMinutesToEvacuate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//输入、输出参数的特殊构造</span></span><br><span class="line">    <span class="keyword">public</span> NuclearReactorTest(<span class="keyword">int</span> pressure,<span class="keyword">int</span> triggeredFireSensors,</span><br><span class="line">                     List&lt;Float&gt;radiationDataReadings,<span class="keyword">boolean</span> expectedAlarmStatus,</span><br><span class="line">                     <span class="keyword">boolean</span> expectedShutdownCommand,<span class="keyword">int</span> expectedMinutesToEvacuate)&#123;</span><br><span class="line">        <span class="built_in">this</span>.triggeredFireSensors = triggeredFireSensors;</span><br><span class="line">        <span class="built_in">this</span>.radiationDataReadings = radiationDataReadings;</span><br><span class="line">        <span class="built_in">this</span>.pressure = pressure;</span><br><span class="line">        <span class="built_in">this</span>.expectedAlarmStatus = expectedAlarmStatus;</span><br><span class="line">        <span class="built_in">this</span>.expectedMinutesToEvacuate = expectedMinutesToEvacuate;  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//单元测试需要使用的参数</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> nuclearReactorScenario()&#123;</span><br><span class="line">        NuclearReactorMonitor nuclearReactorMonitor = <span class="keyword">new</span> NuclearReactorMonitor();</span><br><span class="line">        nuclearReactorMonitor.feedFireSensorData(triggeredFireSensors);</span><br><span class="line">        nuclearReactorMonitor.feedRadiationSensorData(radiationDataReadings);</span><br><span class="line">        nuclearReactorMonitor.feedPressureInBar(pressure);</span><br><span class="line">        NuclearReactorStatus status = nuclearReactorMonitor.getCurrentStatus();</span><br><span class="line">        assertEquals(<span class="string">&quot;Expected no alarm&quot;</span>, expectedAlarmStatus,status.isAlarmActive());</span><br><span class="line">        assertEquals(<span class="string">&quot;No notifications&quot;</span>, expectedShutdownCommand,</span><br><span class="line">                     status.isShutDownNeeded());</span><br><span class="line">        assertEquals(<span class="string">&quot;No notifications&quot;</span>, expectedMinutesToEvacuate,</span><br><span class="line">                      status.getEvacuationMinutes());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//测试数据的来源</span></span><br><span class="line">    <span class="meta">@Parameters</span></span><br><span class="line">    <span class="comment">//二维数组测试数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Collection&lt;Object[]&gt; data() &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> Object[][] &#123;</span><br><span class="line">            &#123; <span class="number">150</span>, <span class="number">0</span>, <span class="keyword">new</span> ArrayList&lt;Float&gt;(), <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">-1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">150</span>, <span class="number">1</span>, <span class="keyword">new</span> ArrayList&lt;Float&gt;(), <span class="literal">true</span>, <span class="literal">false</span>, <span class="number">-1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">150</span>, <span class="number">3</span>, <span class="keyword">new</span> ArrayList&lt;Float&gt;(), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">-1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">150</span>, <span class="number">0</span>, Arrays.asList(<span class="number">110.4</span>f, <span class="number">0.3</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">150</span>, <span class="number">0</span>, Arrays.asList(<span class="number">45.3</span>f, <span class="number">10.3</span>f, <span class="number">47.7</span>f), <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">-1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">155</span>, <span class="number">0</span>, Arrays.asList(<span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">false</span>, <span class="number">-1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">170</span>, <span class="number">0</span>, Arrays.asList(<span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">3</span> &#125;,</span><br><span class="line">            &#123; <span class="number">180</span>, <span class="number">0</span>, Arrays.asList(<span class="number">110.4</span>f, <span class="number">0.3</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">500</span>, <span class="number">0</span>, Arrays.asList(<span class="number">110.4</span>f, <span class="number">300</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">30</span>, <span class="number">0</span>, Arrays.asList(<span class="number">110.4</span>f, <span class="number">1000</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">155</span>, <span class="number">4</span>, Arrays.asList(<span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">0.0</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">-1</span> &#125;,</span><br><span class="line">            &#123; <span class="number">170</span>, <span class="number">1</span>, Arrays.asList(<span class="number">45.3</span>f, <span class="number">10.3</span>f, <span class="number">47.7</span>f), <span class="literal">true</span>, <span class="literal">true</span>, <span class="number">3</span> &#125;, &#125;);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-使用Spock测试核反应的场景"><a href="#3-7-使用Spock测试核反应的场景" class="headerlink" title="3.7 使用Spock测试核反应的场景"></a>3.7 使用Spock测试核反应的场景</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NuclearReactorSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//测试描述需通俗易懂，人类可读</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;全面测试所有核反应场景&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;一个核反应和传感器的数据&quot;</span></span><br><span class="line">            NuclearReactorMonitor nuclearReactorMonitor =<span class="keyword">new</span> NuclearReactorMonitor()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//输入</span></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;当我们检查传感器数据&quot;</span></span><br><span class="line">            nuclearReactorMonitor.feedFireSensorData(fireSensors)</span><br><span class="line">            nuclearReactorMonitor.feedRadiationSensorData(radiation)</span><br><span class="line">            nuclearReactorMonitor.feedPressureInBar(pressure)</span><br><span class="line">            NuclearReactorStatus status = nuclearReactorMonitor.getCurrentStatus()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//输出</span></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;我们根据安全准则行动&quot;</span></span><br><span class="line">            status.alarmActive == alarm</span><br><span class="line">            status.shutDownNeeded == shutDown</span><br><span class="line">            status.evacuationMinutes == evacuation</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//参数的来源</span></span><br><span class="line">        <span class="symbol">where:</span> <span class="string">&quot;可能的核事故有:&quot;</span></span><br><span class="line">                <span class="comment">//输入和输出的定义</span></span><br><span class="line">            pressure | fireSensors | radiation || alarm | shutDown | evacuation</span><br><span class="line">            <span class="comment">//所有场景的表格表示</span></span><br><span class="line">            <span class="number">150</span>      | <span class="number">0</span>           | []        || <span class="literal">false</span> | <span class="literal">false</span>    | <span class="number">-1</span></span><br><span class="line">            <span class="number">150</span>      | <span class="number">1</span>           | []        || <span class="literal">true</span>  | <span class="literal">false</span>    | <span class="number">-1</span></span><br><span class="line">            <span class="number">150</span>      | <span class="number">3</span>           | []        || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">-1</span></span><br><span class="line">            <span class="number">150</span>      | <span class="number">0</span>| [<span class="number">110.4</span>f ,<span class="number">0.3</span>f, <span class="number">0.0</span>f] || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">1</span></span><br><span class="line">            <span class="number">150</span>      | <span class="number">0</span>| [<span class="number">45.3</span>f ,<span class="number">10.3</span>f, <span class="number">47.7</span>f]|| <span class="literal">false</span> | <span class="literal">false</span>    | <span class="number">-1</span></span><br><span class="line">            <span class="number">155</span>      | <span class="number">0</span>| [<span class="number">0.0</span>f ,<span class="number">0.0</span>f, <span class="number">0.0</span>f]   || <span class="literal">true</span>  | <span class="literal">false</span>    | <span class="number">-1</span></span><br><span class="line">            <span class="number">170</span>      | <span class="number">0</span>| [<span class="number">0.0</span>f ,<span class="number">0.0</span>f, <span class="number">0.0</span>f]   || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">3</span></span><br><span class="line">            <span class="number">180</span>      | <span class="number">0</span>| [<span class="number">110.4</span>f ,<span class="number">0.3</span>f, <span class="number">0.0</span>f] || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">1</span></span><br><span class="line">            <span class="number">500</span>      | <span class="number">0</span>| [<span class="number">110.4</span>f ,<span class="number">300</span>f, <span class="number">0.0</span>f] || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">1</span></span><br><span class="line">            <span class="number">30</span>       | <span class="number">0</span>|[<span class="number">110.4</span>f ,<span class="number">1000</span>f, <span class="number">0.0</span>f] || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">1</span></span><br><span class="line">            <span class="number">155</span>      | <span class="number">4</span>| [<span class="number">0.0</span>f ,<span class="number">0.0</span>f, <span class="number">0.0</span>f]   || <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">-1</span></span><br><span class="line">            <span class="number">170</span>      | <span class="number">1</span>| [<span class="number">45.3</span>f ,<span class="number">10.3</span>f, <span class="number">47.7</span>f]|| <span class="literal">true</span>  | <span class="literal">true</span>     | <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-8-温度监控器和读取器的Java类"><a href="#3-8-温度监控器和读取器的Java类" class="headerlink" title="3.8 温度监控器和读取器的Java类"></a>3.8 温度监控器和读取器的Java类</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//仅包含温度的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemperatureReadings</span> &#123;</span></span><br><span class="line">    <span class="comment">//目前温度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sensor1Data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sensor2Data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sensor3Data;</span><br><span class="line">    [...getters and setters here]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//温度读取器实现的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TemperatureReader</span> &#123;</span></span><br><span class="line">    <span class="comment">//被测试的类调用的方法</span></span><br><span class="line">    TemperatureReadings getCurrentReadings();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//正在测试的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemperatureMonitor</span> &#123;</span></span><br><span class="line">    <span class="comment">//注入的温度读取器字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TemperatureReader reader;</span><br><span class="line">    <span class="comment">//上一次温度的读数</span></span><br><span class="line">    <span class="keyword">private</span> TemperatureReadings lastReadings;</span><br><span class="line">    <span class="comment">//目前温度的读数</span></span><br><span class="line">    <span class="keyword">private</span> TemperatureReadings currentReadings;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TemperatureMonitor(<span class="keyword">final</span> TemperatureReader reader)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//构造函数注入</span></span><br><span class="line">        <span class="built_in">this</span>.reader = reader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//需要单元测试的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isTemperatureNormal()</span><br><span class="line">    &#123;</span><br><span class="line">        [...implementation here that compares readings...]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定期自动调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> readSensor()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//和温度读取器交互</span></span><br><span class="line">        lastReadings = currentReadings;</span><br><span class="line">        currentReadings = reader.getCurrentReadings();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-9-使用Spock的Stubbing"><a href="#3-9-使用Spock的Stubbing" class="headerlink" title="3.9 使用Spock的Stubbing"></a>3.9 使用Spock的Stubbing</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoolantSensorSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;如果当前温差在限制范围内，则一切正常&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;读取的温度在限制范围内&quot;</span></span><br><span class="line">            <span class="comment">//预设温度</span></span><br><span class="line">            TemperatureReadings prev = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">20</span>,                                                       <span class="attr">sensor2Data:</span><span class="number">40</span>,<span class="attr">sensor3Data:</span><span class="number">80</span>)</span><br><span class="line">            TemperatureReadings current = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">30</span>,                                                     <span class="attr">sensor2Data:</span><span class="number">45</span>,<span class="attr">sensor3Data:</span><span class="number">73</span>);</span><br><span class="line">            <span class="comment">//dummy接口实现</span></span><br><span class="line">            TemperatureReader reader = Stub(TemperatureReader)</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//dummy接口返回预设温度</span></span><br><span class="line">            reader.getCurrentReadings() &gt;&gt;&gt; [prev, current]</span><br><span class="line"></span><br><span class="line">            <span class="comment">//被测试的类注入dummy接口</span></span><br><span class="line">            TemperatureMonitor monitor = <span class="keyword">new</span> TemperatureMonitor(reader)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//被测试的类调用dummy接口</span></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;我们查询现在的温度&quot;</span></span><br><span class="line">            monitor.readSensor()</span><br><span class="line">            monitor.readSensor()</span><br><span class="line"></span><br><span class="line">        <span class="comment">//两次调用之后的结果</span></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;一切正常&quot;</span></span><br><span class="line">            monitor.isTemperatureNormal()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;如果当前温差大于20度，则警报响起&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;读取的温度不在限制范围内&quot;</span></span><br><span class="line">            TemperatureReadings prev = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">20</span>,                                                         <span class="attr">sensor2Data:</span><span class="number">40</span>,<span class="attr">sensor3Data:</span><span class="number">80</span>)</span><br><span class="line">            TemperatureReadings current = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">30</span>,</span><br><span class="line">                                           <span class="symbol">sensor2Data:</span><span class="number">10</span>,<span class="attr">sensor3Data:</span><span class="number">73</span>);</span><br><span class="line">            <span class="comment">//Stub的调用</span></span><br><span class="line">            TemperatureReader reader = Stub(TemperatureReader)</span><br><span class="line">            reader.getCurrentReadings() &gt;&gt;&gt; [prev,current]</span><br><span class="line">            TemperatureMonitor monitor = <span class="keyword">new</span> TemperatureMonitor(reader)</span><br><span class="line"></span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;我们查询现在的温度&quot;</span></span><br><span class="line">            monitor.readSensor()</span><br><span class="line">            monitor.readSensor()</span><br><span class="line"></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;警报应该响起&quot;</span></span><br><span class="line">            !monitor.isTemperatureNormal()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-10-温度监控器、读取器和反应控制的Java类"><a href="#3-10-温度监控器、读取器和反应控制的Java类" class="headerlink" title="3.10 温度监控器、读取器和反应控制的Java类"></a>3.10 温度监控器、读取器和反应控制的Java类</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//仅包含温度的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemperatureReadings</span> &#123;</span></span><br><span class="line">    <span class="comment">//目前温度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sensor1Data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sensor2Data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sensor3Data;</span><br><span class="line">    [...getters and setters here]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//温度读取器实现的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TemperatureReader</span> &#123;</span></span><br><span class="line">    <span class="comment">//被测试的类调用的方法</span></span><br><span class="line">    TemperatureReadings getCurrentReadings();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//具有副作用的类(Class with side effects)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactorControl</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> activateAlarm()</span><br><span class="line">    &#123;</span><br><span class="line">        [...implementation here...]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> shutdownReactor()</span><br><span class="line">    &#123;</span><br><span class="line">        [...implementation here...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//被测试的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImprovedTemperatureMonitor</span> &#123;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//温度读取器和核反应控制的字段注入</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TemperatureReader reader;</span><br><span class="line">    <span class="keyword">private</span> TemperatureReadings lastReadings;</span><br><span class="line">    <span class="keyword">private</span> TemperatureReadings currentReadings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactorControl reactorControl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ImprovedTemperatureMonitor(<span class="keyword">final</span> TemperatureReader reader, <span class="keyword">final</span>                                                        ReactorControl reactorControl)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.reactorControl = reactorControl;</span><br><span class="line">        <span class="built_in">this</span>.reader = reader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isTemperatureDiffMoreThan(<span class="keyword">long</span> degrees)</span><br><span class="line">    &#123;</span><br><span class="line">        [...implementation here that compares readings...]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> readSensor()</span><br><span class="line">    &#123;</span><br><span class="line">        lastReadings = currentReadings;</span><br><span class="line">        currentReadings = reader.getCurrentReadings();</span><br><span class="line">        </span><br><span class="line">        [...sanity checks...]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(isTemperatureDiffMoreThan(<span class="number">20</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//被测试的类调用具有副作用的方法</span></span><br><span class="line">            reactorControl.activateAlarm();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(isTemperatureDiffMoreThan(<span class="number">50</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//被测试的类调用具有副作用的方法</span></span><br><span class="line">            reactorControl.shutdownReactor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-11-使用Spock的mocking和stubbing"><a href="#3-11-使用Spock的mocking和stubbing" class="headerlink" title="3.11 使用Spock的mocking和stubbing"></a>3.11 使用Spock的mocking和stubbing</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;如果当前温差大于20度，则警报响起&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;读取的温度不在限制范围内&quot;</span></span><br><span class="line">        TemperatureReadings prev = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">20</span>,                                                          <span class="attr">sensor2Data:</span><span class="number">40</span>,<span class="attr">sensor3Data:</span><span class="number">80</span>)</span><br><span class="line">        TemperatureReadings current = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">30</span>,</span><br><span class="line">                                      <span class="symbol">sensor2Data:</span><span class="number">10</span>,<span class="attr">sensor3Data:</span><span class="number">73</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//为接口创建Stub</span></span><br><span class="line">        TemperatureReader reader = Stub(TemperatureReader)</span><br><span class="line">    </span><br><span class="line">        reader.getCurrentReadings() &gt;&gt;&gt; [prev, current]</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//为一个具体的类创建mock</span></span><br><span class="line">        ReactorControl control = Mock(ReactorControl)</span><br><span class="line">        <span class="comment">//被测试的类注入mock和stub</span></span><br><span class="line">        ImprovedTemperatureMonitor monitor = <span class="keyword">new</span></span><br><span class="line">            ImprovedTemperatureMonitor(reader,control)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后续场景调用mock方法</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;我们查询现在的温度&quot;</span></span><br><span class="line">        monitor.readSensor()</span><br><span class="line">        monitor.readSensor()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;警报应该响起&quot;</span></span><br><span class="line">        <span class="comment">//验证mock的调用</span></span><br><span class="line">        <span class="number">0</span> * control.shutdownReactor()</span><br><span class="line">        <span class="number">1</span> * control.activateAlarm()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;如果当前温差大于50度，则核反应应该停止&quot;</span>()&#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;读取的温度不在限制范围内&quot;</span></span><br><span class="line">        TemperatureReadings prev = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">20</span>,</span><br><span class="line">                                                       <span class="symbol">sensor2Data:</span><span class="number">40</span>,<span class="attr">sensor3Data:</span><span class="number">80</span>)</span><br><span class="line">        TemperatureReadings current = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span><span class="number">30</span>,</span><br><span class="line">                                                         <span class="symbol">sensor2Data:</span><span class="number">10</span>,<span class="attr">sensor3Data:</span><span class="number">160</span>);</span><br><span class="line">        TemperatureReader reader = Stub(TemperatureReader)</span><br><span class="line"></span><br><span class="line">        reader.getCurrentReadings() &gt;&gt;&gt; [prev, current]</span><br><span class="line"></span><br><span class="line">        ReactorControl control = Mock(ReactorControl)</span><br><span class="line">        ImprovedTemperatureMonitor monitor = <span class="keyword">new</span></span><br><span class="line">            ImprovedTemperatureMonitor(reader,control)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;我们查询现在的温度&quot;</span></span><br><span class="line">        monitor.readSensor()</span><br><span class="line">        monitor.readSensor()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;警报应该响起，并且核反应应该停止&quot;</span></span><br><span class="line">        <span class="number">1</span> * control.shutdownReactor()</span><br><span class="line">        <span class="number">1</span> * control.activateAlarm()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-12-Spock参数化测试中的mocking-stubbing"><a href="#3-12-Spock参数化测试中的mocking-stubbing" class="headerlink" title="3.12 Spock参数化测试中的mocking/stubbing"></a>3.12 Spock参数化测试中的mocking/stubbing</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;测试3个传感器温度的上升和下降&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一系列温度的读数&quot;</span></span><br><span class="line">        <span class="comment">//输入温度参数</span></span><br><span class="line">        TemperatureReadings prev = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span>previousTemp[<span class="number">0</span>], </span><br><span class="line">                                 <span class="symbol">sensor2Data:</span>previousTemp[<span class="number">1</span>],<span class="attr">sensor3Data:</span>previousTemp[<span class="number">2</span>])</span><br><span class="line">        TemperatureReadings current = <span class="keyword">new</span> TemperatureReadings(<span class="attr">sensor1Data:</span>currentTemp[<span class="number">0</span>],</span><br><span class="line">                                 <span class="symbol">sensor2Data:</span>currentTemp[<span class="number">1</span>], <span class="attr">sensor3Data:</span>currentTemp[<span class="number">2</span>]);</span><br><span class="line">        <span class="comment">//创建dummy接口</span></span><br><span class="line">        TemperatureReader reader = Stub(TemperatureReader)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//dummy接口的返回值</span></span><br><span class="line">        reader.getCurrentReadings() &gt;&gt;&gt; [prev, current]</span><br><span class="line"></span><br><span class="line">        <span class="comment">//具体类中的mocking</span></span><br><span class="line">        ReactorControl control = Mock(ReactorControl)</span><br><span class="line">        <span class="comment">//被测试的类注入mock和stub</span></span><br><span class="line">        ImprovedTemperatureMonitor monitor = <span class="keyword">new</span></span><br><span class="line">            ImprovedTemperatureMonitor(reader,control)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后续场景中被测试的类调用stub和mock</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;我们查询现在的温度&quot;</span></span><br><span class="line">        monitor.readSensor()</span><br><span class="line">        monitor.readSensor()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;如果需要，警报应该响起，并且核反应应该停止&quot;</span></span><br><span class="line">        <span class="comment">//使用参数验证mock</span></span><br><span class="line">        shutDown * control.shutdownReactor()</span><br><span class="line">        alarm * control.activateAlarm()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;所有可能的温度:&quot;</span></span><br><span class="line">        <span class="comment">//所有参数变量和期待的结果</span></span><br><span class="line">        previousTemp | currentTemp        || alarm | shutDown</span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">25</span>, <span class="number">15</span>, <span class="number">43.2</span>]     || <span class="number">0</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">13.3</span>, <span class="number">37.8</span>, <span class="number">39.2</span>] || <span class="number">0</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">50</span>, <span class="number">15</span>, <span class="number">43.2</span>]     || <span class="number">1</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">-20</span>, <span class="number">15</span>, <span class="number">43.2</span>]    || <span class="number">1</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">100</span>, <span class="number">15</span>, <span class="number">43.2</span>]    || <span class="number">1</span>     | <span class="number">1</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">-80</span>, <span class="number">15</span>, <span class="number">43.2</span>]    || <span class="number">1</span>     | <span class="number">1</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">20</span>, <span class="number">55</span>, <span class="number">43.2</span>]     || <span class="number">1</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">20</span>, <span class="number">8</span> , <span class="number">43.2</span>]     || <span class="number">1</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">21</span>, <span class="number">100</span>, <span class="number">43.2</span>]    || <span class="number">1</span>     | <span class="number">1</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">22</span>, <span class="number">-40</span>, <span class="number">43.2</span>]    || <span class="number">1</span>     | <span class="number">1</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">20</span>, <span class="number">35</span>, <span class="number">76</span>]       || <span class="number">1</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">20</span>, <span class="number">31</span> ,<span class="number">13.2</span>]     || <span class="number">1</span>     | <span class="number">0</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">21</span>, <span class="number">33</span>, <span class="number">97</span>]       || <span class="number">1</span>     | <span class="number">1</span></span><br><span class="line">        [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>] | [<span class="number">22</span>, <span class="number">39</span>, <span class="number">-22</span>]      || <span class="number">1</span>     | <span class="number">1</span></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<p> 王肖 范围：91页 —110页</p>
<h2 id="4-使用Spock编写单元测试"><a href="#4-使用Spock编写单元测试" class="headerlink" title="4.使用Spock编写单元测试"></a>4.使用Spock编写单元测试</h2><h3 id="4-1-测试方法中的Spock块"><a href="#4-1-测试方法中的Spock块" class="headerlink" title="4.1  测试方法中的Spock块"></a>4.1  测试方法中的Spock块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Spock测试方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;2加3可以得到5&quot;</span>() &#123;</span><br><span class="line">    <span class="comment">//given块及其描述</span></span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;两个整数，2和3&quot;</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">3</span></span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//when块及其描述</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;把他们相加&quot;</span></span><br><span class="line">    <span class="keyword">int</span> result = a + b</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//then块及其描述</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;结果是5&quot;</span></span><br><span class="line">    result == <span class="number">5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-电子购物篮的Java框架"><a href="#4-2-电子购物篮的Java框架" class="headerlink" title="4.2 电子购物篮的Java框架"></a>4.2 电子购物篮的Java框架</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//所有销售的产品都在此类定义。</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> weight;</span><br><span class="line">    [...getters and setters here]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Basket</span> &#123;</span></span><br><span class="line">    <span class="comment">//用户选择产品时由用户界面触发</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> addProduct(Product product)</span><br><span class="line">    &#123;</span><br><span class="line">        addProduct(product,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> addProduct(Product product, <span class="keyword">int</span> times)</span><br><span class="line">    &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> getCurrentWeight()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//计算运费所需</span></span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//销售分析所需</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> getProductTypesCount()</span><br><span class="line">    &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-given-when-then-三合会"><a href="#4-3-given-when-then-三合会" class="headerlink" title="4.3 given-when-then 三合会"></a>4.3 given-when-then 三合会</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;装有一种产品的购物篮的重量跟产品相同&quot;</span>() &#123;</span><br><span class="line">    <span class="comment">//准备单元测试。</span></span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//触发将要测试的动作。</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视&quot;</span></span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查结果。</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于电视&quot;</span></span><br><span class="line">    basket.currentWeight == tv.weight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-使用setup别名"><a href="#4-4-使用setup别名" class="headerlink" title="4.4 使用setup别名"></a>4.4 使用setup别名</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;装有一种产品的购物篮的重量跟产品相同（替代）&quot;</span>() &#123;</span><br><span class="line">    <span class="comment">//准备单元测试。</span></span><br><span class="line">    <span class="symbol">setup:</span> <span class="string">&quot;一个空购物篮和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//触发将要测试的动作。</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视&quot;</span></span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查结果。</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于电视&quot;</span></span><br><span class="line">    basket.currentWeight == tv.weight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-不平凡的when块——请勿这样做"><a href="#4-5-不平凡的when块——请勿这样做" class="headerlink" title="4.5 不平凡的when块——请勿这样做"></a>4.5 不平凡的when块——请勿这样做</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;测试指标分配&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">setup:</span></span><br><span class="line">        List&lt;String&gt; list = [<span class="string">&quot;IDCODIGO&quot;</span>, <span class="string">&quot;descripcion&quot;</span>, <span class="string">&quot;field_1&quot;</span>,<span class="string">&quot;FAMILIA&quot;</span>, <span class="string">&quot;MARCA&quot;</span> ]</span><br><span class="line">        ArticuloSunglassDescriptor.reset()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//when块没有文字说明，也没有不清楚的触发代码</span></span><br><span class="line">    <span class="symbol">when:</span></span><br><span class="line">        Integer ix = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (String tag <span class="keyword">in</span> list) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ArticuloSunglassDescriptor descriptor <span class="keyword">in</span></span><br><span class="line">        ArticuloSunglassDescriptor.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (descriptor.equals(tag)) &#123;</span><br><span class="line">                descriptor.index = ix</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ix++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="symbol">then:</span></span><br><span class="line">        ArticuloSunglassDescriptor.family.index == <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-描述性when块"><a href="#4-6-描述性when块" class="headerlink" title="4.6 描述性when块"></a>4.6 描述性when块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;有两个产品的购物篮的重量是产品重量之和&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮，一台电视和一台照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//when块带有文字说明和清晰的触发代码</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视和相机&quot;</span></span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">    basket.addProduct(camera)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于相机和电视&quot;</span></span><br><span class="line">    basket.currentWeight == (tv.weight + camera.weight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-7-无效的then块"><a href="#4-7-无效的then块" class="headerlink" title="4.7 无效的then块"></a>4.7 无效的then块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;有两个产品的购物篮的重量是产品重量之和&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮，一台电视和一台照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视和相机&quot;</span></span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">    basket.addProduct(camera)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于相机和电视&quot;</span></span><br><span class="line">    <span class="comment">//错误！ 它应该被“代替”。</span></span><br><span class="line">    basket.currentWeight = (tv.weight + camera.weight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-8使用and分割when块"><a href="#4-8使用and分割when块" class="headerlink" title="4.8使用and分割when块"></a>4.8使用and分割when块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;有三个产品的购物篮的重量是产品重量之和&quot;</span>() &#123;</span><br><span class="line">    <span class="comment">//given块仅处理被测类。</span></span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮&quot;</span></span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//and块创建协作者。</span></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;几种产品&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Product hifi = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;jvc&quot;</span>,<span class="attr">price:</span><span class="number">600</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视，摄像机和高保真音响&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line">    basket.addProduct hifi</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于所有产品重量之和&quot;</span></span><br><span class="line">    basket.currentWeight == (tv.weight + camera.weight + hifi.weight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-9-使用and拆分when块"><a href="#4-9-使用and拆分when块" class="headerlink" title="4.9 使用and拆分when块"></a>4.9 使用and拆分when块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;有三个产品的购物篮的重量是产品重量之和（替代）&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮，一台电视，一台照相机和一个高保真音响&quot;</span></span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Product hifi = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;jvc&quot;</span>,<span class="attr">price:</span><span class="number">600</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//原始when块</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视..&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//扩展when块</span></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;..相机..&quot;</span></span><br><span class="line">    basket.addProduct camera</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;..和wifi&quot;</span></span><br><span class="line">    basket.addProduct hifi</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于所有产品重量之和&quot;</span></span><br><span class="line">    basket.currentWeight == (tv.weight + camera.weight + hifi.weight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-10-使用and作为then块的扩展"><a href="#4-10-使用and作为then块的扩展" class="headerlink" title="4.10 使用and作为then块的扩展"></a>4.10 使用and作为then块的扩展</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;装有三种产品的购物篮的重量和数量是正确的（有争议）&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮，一台电视，一台照相机和一个高保真音响&quot;</span></span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Product hifi = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;jvc&quot;</span>,<span class="attr">price:</span><span class="number">600</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视，摄像机和高保真音响&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line">    basket.addProduct hifi</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//原始的when块</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮的重量等于所有产品的重量&quot;</span></span><br><span class="line">    basket.currentWeight == (tv.weight + camera.weight + hifi.weight)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//扩展then块</span></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;它包含3个产品&quot;</span></span><br><span class="line">    basket.productTypesCount == <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-11-具有expect块的琐碎测试"><a href="#4-11-具有expect块的琐碎测试" class="headerlink" title="4.11 具有expect块的琐碎测试"></a>4.11 具有expect块的琐碎测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;空购物篮没有重量&quot;</span>() &#123;</span><br><span class="line">    <span class="comment">//只存在expect块。</span></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;当不添加任何东西时重量为零&quot;</span></span><br><span class="line">    <span class="keyword">new</span> Basket().currentWeight == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-12-expect块替换when和then"><a href="#4-12-expect块替换when和then" class="headerlink" title="4.12 expect块替换when和then"></a>4.12 expect块替换when和then</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;空购物篮没有重量（替代）&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮&quot;</span></span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//expect块执行测试的断言</span></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;重量为0&quot;</span></span><br><span class="line">    basket.currentWeight == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-13-使用expect作为前提条件"><a href="#4-13-使用expect作为前提条件" class="headerlink" title="4.13 使用expect作为前提条件"></a>4.13 使用expect作为前提条件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;有两个产品的购物篮的重量是产品重量之和（前提条件）&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮，一台电视和一台照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//expect块执行中间断言</span></span><br><span class="line">    <span class="symbol">expect:</span><span class="string">&quot;里面什么也不要&quot;</span></span><br><span class="line">    basket.currentWeight == <span class="number">0</span></span><br><span class="line">    basket.productTypesCount == <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视和相机&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//then块检查最终结果</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于相机和电视&quot;</span></span><br><span class="line">    basket.currentWeight == (tv.weight + camera.weight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-14-即使测试失败使用cleanup也可以释放资源"><a href="#4-14-即使测试失败使用cleanup也可以释放资源" class="headerlink" title="4.14 即使测试失败使用cleanup也可以释放资源"></a>4.14 即使测试失败使用cleanup也可以释放资源</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;装有一种产品的购物篮的重量跟产品相同&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视&quot;</span></span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于电视&quot;</span></span><br><span class="line">    basket.currentWeight == tv.weight</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//cleanup块将始终运行，即使when失败</span></span><br><span class="line">    <span class="symbol">cleanup:</span> <span class="string">&quot;刷新购物篮物品&quot;</span></span><br><span class="line">    <span class="comment">//then块检查最终结果。</span></span><br><span class="line">    basket.clearAllProducts()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-15-测试方法准确描述了要测试的内容"><a href="#4-15-测试方法准确描述了要测试的内容" class="headerlink" title="4.15 测试方法准确描述了要测试的内容"></a>4.15 测试方法准确描述了要测试的内容</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//英文全文</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;装有一种产品的购物篮的重量跟产品相同&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空购物篮和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视&quot;</span></span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于电视&quot;</span></span><br><span class="line">    basket.currentWeight == tv.weight</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-16-标记被测课程"><a href="#4-16-标记被测课程" class="headerlink" title="4.16 标记被测课程"></a>4.16 标记被测课程</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;有两个产品的购物篮的重量是产品重量之和（更好）&quot;</span>() &#123;</span><br><span class="line">    <span class="comment">//该考试的主题是篮球课。</span></span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空的购物篮&quot;</span></span><br><span class="line">    <span class="meta">@Subject</span></span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;几种产品&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视，摄像机和高保真音响&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于所有产品重量之和&quot;</span></span><br><span class="line">    basket.currentWeight == (tv.weight + camera.weight)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-17-编写Spock规范"><a href="#4-17-编写Spock规范" class="headerlink" title="4.17 编写Spock规范"></a>4.17 编写Spock规范</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//英文全称</span></span><br><span class="line"><span class="meta">@Title</span>(<span class="string">&quot;购物篮重量的单元测试&quot;</span>)</span><br><span class="line"><span class="comment">//Groovy类扩展了Specification。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasketWeightSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">     [...test methods here redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-18-编写完整的Spock规范"><a href="#4-18-编写完整的Spock规范" class="headerlink" title="4.18 编写完整的Spock规范"></a>4.18 编写完整的Spock规范</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//单元测试的详细描述</span></span><br><span class="line"><span class="comment">//Groovy多行字符串</span></span><br><span class="line"><span class="meta">@Narrative</span>(<span class="string">&quot;&quot;&quot; 空的购物篮开始时没有重量。 将产品添加到购物篮中会增加其重量。 然后将重量用于计算运输期间的计费。 电子商品的重量始终为零。&quot;&quot;&quot;</span>)</span><br><span class="line"><span class="comment">//单行测试描述</span></span><br><span class="line"><span class="meta">@Title</span>(<span class="string">&quot;购物篮重量的单元测试&quot;</span>)</span><br><span class="line"><span class="comment">//有关所有测试方法的被测类信息</span></span><br><span class="line"><span class="meta">@Subject</span>(Basket)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasketWeightDetailedSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    [...test methods here redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-19-提取通用初始化代码"><a href="#4-19-提取通用初始化代码" class="headerlink" title="4.19 提取通用初始化代码"></a>4.19 提取通用初始化代码</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonSetupSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="comment">//通用类作为字段放置。</span></span><br><span class="line">    Product tv</span><br><span class="line">    Product camera</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//该方法会在每种测试方法之前自动运行。</span></span><br><span class="line">    <span class="keyword">def</span> setup() &#123;</span><br><span class="line">        <span class="comment">//初始化代码只编写一次。</span></span><br><span class="line">        tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//测试方法在初始化代码之后运行。</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;装有一种产品的购物篮的重量跟产品相同&quot;</span>() &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity purposes...]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//测试方法在初始化代码之后运行。</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;有两个产品的购物篮的重量是产品重量之和&quot;</span>()</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity purposes...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-20-提取常见的前后条件"><a href="#4-20-提取常见的前后条件" class="headerlink" title="4.20 提取常见的前后条件"></a>4.20 提取常见的前后条件</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subject</span>(Basket)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonCleanupSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="comment">//通用类作为字段放置。</span></span><br><span class="line">    Product tv</span><br><span class="line">    Product camera</span><br><span class="line">    Basket basket</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//该方法将在每种测试方法之前自动运行。</span></span><br><span class="line">    <span class="keyword">def</span> setup() &#123;</span><br><span class="line">        tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">        basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;装有一种产品的购物篮的重量跟产品相同&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视&quot;</span></span><br><span class="line">        basket.addProduct tv</span><br><span class="line">        </span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于所有产品重量&quot;</span></span><br><span class="line">        basket.currentWeight == tv.weight</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;有两个产品的购物篮的重量是产品重量之和&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;用户想购买电视和相机&quot;</span></span><br><span class="line">        basket.addProduct tv</span><br><span class="line">        basket.addProduct camera</span><br><span class="line">        </span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;购物篮重量等于所有产品重量&quot;</span></span><br><span class="line">        basket.currentWeight == (tv.weight + camera.weight)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//该方法将在每种测试方法之后自动运行。</span></span><br><span class="line">    <span class="keyword">def</span> cleanup()</span><br><span class="line">    &#123;</span><br><span class="line">        basket.clearAllProducts()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>王渊超 范围：111-130页</p>
<h3 id="4-21-所有Spock生命周期方法"><a href="#4-21-所有Spock生命周期方法" class="headerlink" title="4.21 所有Spock生命周期方法"></a>4.21 所有Spock生命周期方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123; </span><br><span class="line">        <span class="comment">//初始化一个代价昂贵（耗资源）的对象</span></span><br><span class="line">        <span class="function">def <span class="title">setupSpec</span><span class="params">()</span> </span>&#123; </span><br><span class="line">           println <span class="string">&quot;Will run only once&quot;</span></span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">//所有测试的通用代码</span></span><br><span class="line">    <span class="function">def <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           println <span class="string">&quot;Will run before EACH feature&quot;</span></span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//测试方法</span></span><br><span class="line">    def <span class="string">&quot;测试第一个功能&quot;</span>() &#123;           </span><br><span class="line">                expect: <span class="string">&quot;trivial test&quot;</span></span><br><span class="line">          println <span class="string">&quot;first feature runs&quot;</span>           </span><br><span class="line">          <span class="number">2</span> == <span class="number">1</span> +<span class="number">1</span></span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//测试方法</span></span><br><span class="line">    def <span class="string">&quot;测试第二个功能&quot;</span>() &#123;           </span><br><span class="line">                 expect: <span class="string">&quot;trivial test&quot;</span></span><br><span class="line">           println <span class="string">&quot;second feature runs&quot;</span>           </span><br><span class="line">           <span class="number">5</span> == <span class="number">3</span> +<span class="number">2</span></span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">//所有测试的公共清理代码</span></span><br><span class="line">    <span class="function">def <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           println <span class="string">&quot;Will run once after EACH feature&quot;</span></span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="function">def <span class="title">cleanupSpec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           println <span class="string">&quot;Will run once at the end&quot;</span></span><br><span class="line">        &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-22-使用-Shared注入"><a href="#4-22-使用-Shared注入" class="headerlink" title="4.22 使用@Shared注入"></a>4.22 使用@Shared注入</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SharedSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//只创建一次</span></span><br><span class="line">    <span class="meta">@Shared</span></span><br><span class="line">    CreditCardProcessor creditCardProcessor;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//会创建多次</span></span><br><span class="line">    BillableBasket basket</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化代价昂贵/速度慢的对象</span></span><br><span class="line">    <span class="function">def <span class="title">setupSpec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                creditCardProcessor = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//共享对象可以正常使用</span></span><br><span class="line">        <span class="function">def <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">        creditCardProcessor.newDayStarted()</span><br><span class="line">        basket.setCreditCardProcessor(creditCardProcessor)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        def <span class="string">&quot;用户购买单一产品&quot;</span>() &#123;</span><br><span class="line">           given: <span class="string">&quot;一个购物车和一台电视机&quot;</span></span><br><span class="line">           Product tv = <span class="keyword">new</span> Product(name:<span class="string">&quot;bravia&quot;</span>,price:<span class="number">1200</span>,weight:<span class="number">18</span>)</span><br><span class="line">        </span><br><span class="line">        and: <span class="string">&quot;用户想购买电视机&quot;</span> </span><br><span class="line">        basket.addProduct(tv)</span><br><span class="line">          </span><br><span class="line">                when: <span class="string">&quot;用户登出&quot;</span> </span><br><span class="line">        basket.checkout()</span><br><span class="line">          </span><br><span class="line">                then: <span class="string">&quot;获得收入即为电视价格&quot;</span> </span><br><span class="line">        creditCardProcessor.currentRevenue == tv.price</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        def <span class="string">&quot;用户购买两样产品&quot;</span>() &#123;</span><br><span class="line">           given: <span class="string">&quot;一个购物车和一台相机&quot;</span></span><br><span class="line">           Product camera = <span class="keyword">new</span> Product(name:<span class="string">&quot;panasonic&quot;</span>,price:<span class="number">350</span>,weight:<span class="number">2</span>)</span><br><span class="line">          </span><br><span class="line">                and: <span class="string">&quot;用户想购买两台相机&quot;</span> </span><br><span class="line">                basket.addProduct(camera,<span class="number">2</span>)</span><br><span class="line">          </span><br><span class="line">                when: <span class="string">&quot;用户登出&quot;</span> </span><br><span class="line">        basket.checkout()</span><br><span class="line">          </span><br><span class="line">                then: <span class="string">&quot;取得收入为两种产品的价格&quot;</span></span><br><span class="line">        creditCardProcessor.currentRevenue == <span class="number">2</span> * camera.price</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//运行多次</span></span><br><span class="line">      <span class="function">def <span class="title">cleanup</span><span class="params">()</span> </span>&#123; </span><br><span class="line">          basket.clearAllProducts()</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">//只运行一次</span></span><br><span class="line">        <span class="function">def <span class="title">cleanupSpec</span><span class="params">()</span> </span>&#123;     </span><br><span class="line">          creditCardProcessor.shutDown()</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-23-使用old-方法断言"><a href="#4-23-使用old-方法断言" class="headerlink" title="4.23 使用old() 方法断言"></a>4.23 使用old() 方法断言</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def <span class="string">&quot;在购物车里添加产品，增加它的重量&quot;</span>() &#123;</span><br><span class="line">    given: <span class="string">&quot;一个购物车&quot;</span></span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//在given:块中添加第一个产品</span></span><br><span class="line">    and: <span class="string">&quot;一台电视机已经加入购物车&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(name:<span class="string">&quot;bravia&quot;</span>,price:<span class="number">1200</span>,weight:<span class="number">18</span>) </span><br><span class="line">    basket.addProduct(tv)</span><br><span class="line">      </span><br><span class="line">    <span class="comment">//在when:块中添加第二个产品</span></span><br><span class="line">    when: <span class="string">&quot;用户添加一台相机&quot;</span></span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(name:<span class="string">&quot;panasonic&quot;</span>,price:<span class="number">350</span>,weight:<span class="number">2</span>)</span><br><span class="line">        basket.addProduct(camera)</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//检查重量的差异</span></span><br><span class="line">    then: <span class="string">&quot;购物车重量相应更新&quot;</span></span><br><span class="line">        Second product is added in when: block.</span><br><span class="line">        basket.currentWeight == old(basket.currentWeight) + camera.weight </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-24-多个when-then块"><a href="#4-24-多个when-then块" class="headerlink" title="4.24  多个when-then块"></a>4.24  多个when-then块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def &quot;在购物车里添加产品让其重量增加&quot;() &#123;</span><br><span class="line">      given: &quot;一个购物车&quot;</span><br><span class="line">      Basket basket &#x3D; new Basket()</span><br><span class="line">       </span><br><span class="line">      and: &quot;两种产品&quot;</span><br><span class="line">      Product tv &#x3D; new Product(name:&quot;bravia&quot;,price:1200,weight:18)</span><br><span class="line">      Product camera &#x3D; new Product(name:&quot;panasonic&quot;,price:350,weight:2)</span><br><span class="line">       </span><br><span class="line">            when: &quot;用户添加一台相机&quot; </span><br><span class="line">            basket.addProduct(camera)</span><br><span class="line">            </span><br><span class="line">            then: &quot;购物车重量相应更新&quot; </span><br><span class="line">            basket.currentWeight &#x3D;&#x3D; camera.weight</span><br><span class="line">            </span><br><span class="line">            when: &quot;用户还添加一台电视机&quot; </span><br><span class="line">            basket.addProduct(tv)</span><br><span class="line">            </span><br><span class="line">      then: &quot;购物车重量相应更新&quot; </span><br><span class="line">            basket.currentWeight &#x3D;&#x3D; camera.weight + tv.weight </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-25-避免缺少块注释"><a href="#4-25-避免缺少块注释" class="headerlink" title="4.25  避免缺少块注释"></a>4.25  避免缺少块注释</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Test toRegExp(Productos3.txt)&quot;</span> () &#123;      <span class="comment">//测试方发名称不明确</span></span><br><span class="line">  <span class="comment">/* setup: expect: where: 三个块都缺少注释*/</span></span><br><span class="line">      <span class="symbol">setup:</span></span><br><span class="line">        String filePattern = <span class="string">&#x27;PROD&#123;MES&#125;&#123;DIA&#125;_11.TXT&#x27;</span></span><br><span class="line">        String regexp = FileFilterUtil.toRegExpLowerCase( filePattern ) </span><br><span class="line">    Pattern pattern = Pattern.compile(regexp)</span><br><span class="line">      </span><br><span class="line">        <span class="symbol">expect:</span></span><br><span class="line">        StringUtils.trimToEmpty(filename).toLowerCase().matches(pattern) == match</span><br><span class="line">      </span><br><span class="line">        <span class="symbol">where:</span></span><br><span class="line">        filename &lt;&lt; [<span class="string">&#x27;PROD.05-12.11.TXT&#x27;</span>, <span class="string">&#x27;prod.03-21.11.txt&#x27;</span>, </span><br><span class="line">                 <span class="string">&#x27;PROD051211.TXT&#x27;</span>, <span class="string">&#x27;prod0512_11.txt&#x27;</span> ]</span><br><span class="line">    match &lt;&lt; [<span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-26-将某个商品在购物车添加两次"><a href="#4-26-将某个商品在购物车添加两次" class="headerlink" title="4.26  将某个商品在购物车添加两次"></a>4.26  将某个商品在购物车添加两次</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;在购物车里添加产品让其重量增加&quot;</span>() &#123;</span><br><span class="line"></span><br><span class="line">         <span class="symbol">given:</span> <span class="string">&quot;一个购物车&quot;</span></span><br><span class="line">         ProblematicBasket basket = <span class="keyword">new</span> ProblematicBasket()</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;两种不同产品&quot;</span></span><br><span class="line">    Product laptop = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;toshiba&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//插入两个“相机”</span></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户添加一台笔记本和两台相机&quot;</span> </span><br><span class="line">    basket.addProduct(camera,<span class="number">2</span>)</span><br><span class="line">    basket.addProduct(laptop)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断三个商品的重量</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;购物车重量相应更新&quot;</span> </span><br><span class="line">    basket.currentWeight == (<span class="number">2</span> * camera.weight) + laptop.weight </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-27-帮助呈现toString-方法中的错误项"><a href="#4-27-帮助呈现toString-方法中的错误项" class="headerlink" title="4.27  帮助呈现toString() 方法中的错误项"></a>4.27  帮助呈现toString() 方法中的错误项</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProblematicBasket</span> &#123;</span></span><br><span class="line">        <span class="comment">// 键是产品，值是其在购物车中出现次数</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Product,Integer&gt; contents = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">        [... rest of code is redacted <span class="keyword">for</span> brevity purposes...]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//toString()的自定义实现</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String toString()</span><br><span class="line">    &#123;</span><br><span class="line">                StringBuilder builder = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;[ &quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Entry&lt;Product, Integer&gt; <span class="attr">entry:</span>contents.entrySet()) </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//打印每个产品在购物车中的次数</span></span><br><span class="line">                        builder.append(entry.getValue()); </span><br><span class="line">                        builder.append(<span class="string">&quot; x &quot;</span>);</span><br><span class="line">                        builder.append(entry.getKey().getName());  <span class="comment">//打印商品名</span></span><br><span class="line">                        builder.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">                &#125; </span><br><span class="line">                builder.setLength(builder.length()<span class="number">-2</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> builder.append(<span class="string">&quot; ]&quot;</span>).toString();</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-28-Spock对Hamcrest-matchers的支持"><a href="#4-28-Spock对Hamcrest-matchers的支持" class="headerlink" title="4.28 Spock对Hamcrest matchers的支持"></a>4.28 Spock对Hamcrest matchers的支持</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;借助Hamcrest的普通测试&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个商品清单&quot;</span></span><br><span class="line">    List&lt;String&gt; products= [<span class="string">&quot;camera&quot;</span>, <span class="string">&quot;laptop&quot;</span>,<span class="string">&quot;hifi&quot;</span>]     <span class="comment">//建一个列表</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检查列表中的项目是否包含“照相机”</span></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;相机应该是其中之一&quot;</span>          </span><br><span class="line">    products hasItem(<span class="string">&quot;camera&quot;</span>)</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//链接两个Hamcrest matchers</span></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;热狗不应该在其中&quot;</span>             </span><br><span class="line">    products not(hasItem(<span class="string">&quot;hotdog&quot;</span>))  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-29-Hamcrest-matchers中可选择的Spock支持选项"><a href="#4-29-Hamcrest-matchers中可选择的Spock支持选项" class="headerlink" title="4.29 Hamcrest matchers中可选择的Spock支持选项"></a>4.29 Hamcrest matchers中可选择的Spock支持选项</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;借助Hamcrest的普通测试(可选)&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个空列表&quot;</span></span><br><span class="line">    List&lt;String&gt; products= <span class="keyword">new</span> ArrayList&lt;String&gt;()</span><br><span class="line">    </span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;里面装满产品&quot;</span> </span><br><span class="line">        products.add(<span class="string">&quot;laptop&quot;</span>) </span><br><span class="line">        products.add(<span class="string">&quot;camera&quot;</span>)</span><br><span class="line">        products.add(<span class="string">&quot;hifi&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;相机应该是其中之一&quot;</span></span><br><span class="line">    expect(products, hasItem(<span class="string">&quot;camera&quot;</span>))      <span class="comment">//expect()对于then:模块很有用</span></span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;热狗不应该在其中&quot;</span></span><br><span class="line">    that(products, not(hasItem(<span class="string">&quot;hotdog&quot;</span>)))   <span class="comment">//that()对于and:和expect:模块很有用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-30-在Spock断言中使用Groovy闭包"><a href="#4-30-在Spock断言中使用Groovy闭包" class="headerlink" title="4.30  在Spock断言中使用Groovy闭包"></a>4.30  在Spock断言中使用Groovy闭包</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;用Groovy闭包的普通测试&quot;</span>() &#123;</span><br><span class="line">   <span class="symbol">given:</span> <span class="string">&quot;一个装有产品的列表&quot;</span></span><br><span class="line">   List&lt;String&gt; products= [<span class="string">&quot;camera&quot;</span>, <span class="string">&quot;laptop&quot;</span>, <span class="string">&quot;hifi&quot;</span>]</span><br><span class="line">   </span><br><span class="line">   <span class="symbol">expect:</span> <span class="string">&quot;相机应该是其中之一&quot;</span></span><br><span class="line">      products.any&#123; productName -&gt; productName == <span class="string">&quot;camera&quot;</span>&#125;    <span class="comment">//迭代列表并传递任何名为camera的值</span></span><br><span class="line">    </span><br><span class="line">   <span class="symbol">and:</span> <span class="string">&quot;热狗不应该在其中&quot;</span></span><br><span class="line">   products.every&#123; productName -&gt; productName != <span class="string">&quot;hotdog&quot;</span>&#125;  <span class="comment">//迭代列表并检查所有产品的名称</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-31-一个假设的仓库"><a href="#4-31-一个假设的仓库" class="headerlink" title="4.31 一个假设的仓库"></a>4.31 一个假设的仓库</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WarehouseInventory</span> </span>&#123;</span><br><span class="line">        <span class="comment">//装载仓库</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">(Product product, <span class="keyword">int</span> times)</span></span>&#123;</span><br><span class="line">                        [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//结账时由购物车调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subtract</span><span class="params">(String productName, Integer times)</span></span>&#123;</span><br><span class="line">                        [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//提供库存状态</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">availableOfProduct</span><span class="params">(String productName)</span></span>&#123;</span><br><span class="line">                        [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有产品时返回true</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>&#123; </span><br><span class="line">                        [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//跟踪销售情况</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBoxesMovedToday</span><span class="params">()</span></span>&#123;</span><br><span class="line">                        [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-32-一个企业级购物车"><a href="#4-32-一个企业级购物车" class="headerlink" title="4.32 一个企业级购物车"></a>4.32 一个企业级购物车</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnterprisyBasket</span> <span class="keyword">extends</span> <span class="title">Basket</span></span>&#123;</span><br><span class="line">        <span class="comment">//经典企业代码</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enableAutoRefresh</span><span class="params">()</span></span>&#123;</span><br><span class="line">            [...为简洁起见，对代码进行了修订（下同）...]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumberOfCaches</span><span class="params">(<span class="keyword">int</span> number)</span></span>&#123; </span><br><span class="line">                [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCustomerResolver</span><span class="params">(DefaultCustomerResolver  //setter注入方法</span></span></span><br><span class="line"><span class="function"><span class="params">              defaultCustomerResolver)</span></span>&#123;</span><br><span class="line">                [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWarehouseInventory</span><span class="params">(WarehouseInventory    //setter注入方法</span></span></span><br><span class="line"><span class="function"><span class="params">                warehouseInventory)</span></span>&#123;</span><br><span class="line">                [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLanguage</span><span class="params">(String language)</span></span>&#123; </span><br><span class="line">                [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从库存中删除产品</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkout</span><span class="params">()</span></span>&#123;</span><br><span class="line">                [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-33-同一对象上的断言和设置"><a href="#4-33-同一对象上的断言和设置" class="headerlink" title="4.33 同一对象上的断言和设置"></a>4.33 同一对象上的断言和设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">def &quot;购买产品减少库存&quot;() &#123;</span><br><span class="line">            given: &quot;产品目录&quot;</span><br><span class="line">            Product laptop &#x3D; new Product(name:&quot;toshiba&quot;,price:1200,weight:5) </span><br><span class="line">            Product camera &#x3D; new Product(name:&quot;panasonic&quot;,price:350,weight:2) </span><br><span class="line">            Product hifi &#x3D; new Product(name:&quot;jvc&quot;,price:600,weight:5) </span><br><span class="line">            WarehouseInventory warehouseInventory &#x3D; new WarehouseInventory()</span><br><span class="line">            &#x2F;&#x2F;对象参数</span><br><span class="line">            warehouseInventory.preload(laptop,3) </span><br><span class="line">            warehouseInventory.preload(camera,5) </span><br><span class="line">            warehouseInventory.preload(hifi,2)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            and: &quot;一个空购物车&quot;</span><br><span class="line">            EnterprisyBasket basket &#x3D; new EnterprisyBasket()</span><br><span class="line">            basket.setWarehouseInventory(warehouseInventory) </span><br><span class="line">            basket.setCustomerResolver(new DefaultCustomerResolver()) </span><br><span class="line">            &#x2F;&#x2F;对象参数</span><br><span class="line">            basket.setLanguage(&quot;english&quot;) </span><br><span class="line">            basket.setNumberOfCaches(3)</span><br><span class="line">            basket.enableAutoRefresh()</span><br><span class="line">            </span><br><span class="line">            when: &quot;用户添加一台笔记本电脑和两台摄像机&quot; </span><br><span class="line">            basket.addProduct(camera,2) </span><br><span class="line">            basket.addProduct(laptop)</span><br><span class="line">            </span><br><span class="line">            and: &quot;用户完成交易&quot; </span><br><span class="line">            basket.checkout()</span><br><span class="line">            </span><br><span class="line">            then: &quot;仓库相应更新&quot; </span><br><span class="line">            &#x2F;&#x2F;同一对象上的断言</span><br><span class="line">            !warehouseInventory.isEmpty() warehouseInventory.getBoxesMovedToday() &#x3D;&#x3D; 3</span><br><span class="line">            warehouseInventory.availableOfProduct(&quot;toshiba&quot;) &#x3D;&#x3D; 2</span><br><span class="line">            warehouseInventory.availableOfProduct(&quot;panasonic&quot;) &#x3D;&#x3D; 3</span><br><span class="line">            warehouseInventory.availableOfProduct(&quot;jvc&quot;) &#x3D;&#x3D; 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-34-用Groovy和Spock对相似代码进行分组"><a href="#4-34-用Groovy和Spock对相似代码进行分组" class="headerlink" title="4.34 用Groovy和Spock对相似代码进行分组"></a>4.34 用Groovy和Spock对相似代码进行分组</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">def &quot;购买产品会降低库存 (可选)&quot;() &#123; </span><br><span class="line">            given: &quot;产品目录&quot;</span><br><span class="line">            Product laptop &#x3D; new Product(name:&quot;toshiba&quot;,price:1200,weight:5) </span><br><span class="line">            Product camera &#x3D; new Product(name:&quot;panasonic&quot;,price:350,weight:2) </span><br><span class="line">            Product hifi &#x3D; new Product(name:&quot;jvc&quot;,price:600,weight:5) </span><br><span class="line">            WarehouseInventory warehouseInventory &#x3D; new WarehouseInventory() </span><br><span class="line">            &#x2F;&#x2F;使用Groovy中的object.with设置组对象</span><br><span class="line">            warehouseInventory.with&#123;</span><br><span class="line">                            preload laptop,3</span><br><span class="line">                            preload camera,5</span><br><span class="line">                            preload hifi,2</span><br><span class="line">         &#125;</span><br><span class="line">        </span><br><span class="line">        and: &quot;一个空购物车&quot;</span><br><span class="line">        EnterprisyBasket basket &#x3D; new EnterprisyBasket() </span><br><span class="line">        &#x2F;&#x2F;使用Groovy中的object.with设置组对象</span><br><span class="line">        basket.with &#123;</span><br><span class="line">                setWarehouseInventory(warehouseInventory)</span><br><span class="line">                setCustomerResolver(new DefaultCustomerResolver())</span><br><span class="line">                setLanguage &quot;english&quot;</span><br><span class="line">                setNumberOfCaches 3</span><br><span class="line">                enableAutoRefresh()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        when: &quot;用户添加一台笔记本电脑和两台相机&quot; </span><br><span class="line">        basket.with &#123;</span><br><span class="line">           addProduct camera,2</span><br><span class="line">           addProduct laptop</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">     and: &quot;用户完成交易&quot; </span><br><span class="line">     basket.checkout()</span><br><span class="line">     </span><br><span class="line">     then: &quot;仓库相应更新&quot; </span><br><span class="line">   with(warehouseInventory) &#123;       &#x2F;&#x2F;使用Groovy中的Specification.with设置组断言</span><br><span class="line">   &#123;</span><br><span class="line">            !isEmpty()</span><br><span class="line">            getBoxesMovedToday() &#x3D;&#x3D; 3</span><br><span class="line">            availableOfProduct(&quot;toshiba&quot;) &#x3D;&#x3D; 2</span><br><span class="line">            availableOfProduct(&quot;panasonic&quot;) &#x3D;&#x3D; 3</span><br><span class="line">            availableOfProduct(&quot;jvc&quot;) &#x3D;&#x3D; 2</span><br><span class="line">     &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-参数化测试"><a href="#5-参数化测试" class="headerlink" title="5. 参数化测试"></a>5. 参数化测试</h2><h3 id="5-1-避免做重复测试"><a href="#5-1-避免做重复测试" class="headerlink" title="5.1 避免做重复测试"></a>5.1 避免做重复测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;每个测试的输入数据不同</span><br><span class="line">&#x2F;&#x2F;每个测试的输出数据不同</span><br><span class="line"></span><br><span class="line">def &quot;JPG是有效的图像&quot;() &#123;</span><br><span class="line">            given: &quot;一个图像文件扩展名检查器和一个jpg文件&quot; </span><br><span class="line">            ImageNameValidator validator &#x3D; new ImageNameValidator() </span><br><span class="line">            String pictureFile &#x3D; &quot;scenery.jpg&quot;</span><br><span class="line">            </span><br><span class="line">        expect: &quot;文件名是否有效&quot;</span><br><span class="line">            validator.isValidImageExtension(pictureFile) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def &quot;JPEG是有效的图像&quot;() &#123;</span><br><span class="line">            given: &quot;一个图像文件扩展名检查器和一个jpeg文件&quot;</span><br><span class="line">            ImageNameValidator validator &#x3D; new ImageNameValidator() </span><br><span class="line">            String pictureFile &#x3D; &quot;house.jpeg&quot;</span><br><span class="line">        </span><br><span class="line">        expect: &quot;文件名是否有效&quot;</span><br><span class="line">            validator.isValidImageExtension(pictureFile) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def &quot;Tiff是无效的&quot;() &#123;</span><br><span class="line">            given: &quot;一个图像文件扩展名检查器和一个tiff文件&quot; </span><br><span class="line">            ImageNameValidator validator &#x3D; new ImageNameValidator() </span><br><span class="line">            String pictureFile &#x3D; &quot;sky.tiff&quot;</span><br><span class="line">        </span><br><span class="line">        expect: &quot;文件名是否有效&quot;</span><br><span class="line">            !validator.isValidImageExtension(pictureFile) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-简单的Spock参数化测试"><a href="#5-2-简单的Spock参数化测试" class="headerlink" title="5.2 简单的Spock参数化测试"></a>5.2 简单的Spock参数化测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def &quot;有效的PNG和JPEG图像文件&quot;() &#123;</span><br><span class="line">    </span><br><span class="line">    given: &quot;图像文件扩展名检查器&quot;</span><br><span class="line">    ImageNameValidator validator &#x3D; new ImageNameValidator()</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;所有使用pictureFile和validPicture的场景的通用测试逻辑</span><br><span class="line">         expect: &quot;只接受有效的文件名&quot;</span><br><span class="line">         validator.isValidImageExtension(pictureFile) &#x3D;&#x3D; validPicture</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;where:块中包含多个方案的参数。</span><br><span class="line">        where: &quot;示例图像名称如下&quot;</span><br><span class="line">        pictureFile         ||     validPicture        &#x2F;&#x2F;第一行一般是参数名称</span><br><span class="line">    &quot;scenery.jpg&quot;       || true                    &#x2F;&#x2F;每行中包括各场景下的输入值和预期输出值</span><br><span class="line">    &quot;house.jpeg&quot;        || true</span><br><span class="line">    &quot;car.png&quot;           || true</span><br><span class="line">    &quot;sky.tiff&quot;          || false</span><br><span class="line">    &quot;dance_bunny.gif&quot;   || false</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>周天润 范围：131-150页</p>
<h3 id="5-3-given-when-then-where结构"><a href="#5-3-given-when-then-where结构" class="headerlink" title="5.3 given-when-then-where结构"></a>5.3 given-when-then-where结构</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">def <span class="string">&quot;Valid images are PNG and JPEG files (enterprise version)&quot;</span>() &#123;</span><br><span class="line">    given: <span class="string">&quot;an image extension checker&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line">    when: <span class="string">&quot;an image is checked&quot;</span></span><br><span class="line">    ImageExtensionCheck imageExtensionCheck =</span><br><span class="line">    <span class="comment">//在when：语句块中写输入参数（图片文件）</span></span><br><span class="line">    validator.examineImageExtension(pictureFile)</span><br><span class="line">    <span class="comment">//then:语句块中写输出参数校验</span></span><br><span class="line">    then: <span class="string">&quot;expect that only valid filenames are accepted&quot;</span></span><br><span class="line">    imageExtensionCheck.result == validPicture</span><br><span class="line">    imageExtensionCheck.errorCode == error</span><br><span class="line">    imageExtensionCheck.errorDescription == description</span><br><span class="line">    <span class="comment">//where:语句块是测试案例的最后语句块</span></span><br><span class="line">    where: <span class="string">&quot;sample image names are&quot;</span></span><br><span class="line">    <span class="comment">//输入和输出写在同一行中</span></span><br><span class="line">    pictureFile         || validPicture | error         | description</span><br><span class="line">    <span class="string">&quot;scenery.jpg&quot;</span>         || <span class="keyword">true</span>         | <span class="string">&quot;&quot;</span>             | <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;house.jpeg&quot;</span>         || <span class="keyword">true</span>         | <span class="string">&quot;&quot;</span>             | <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;car.png&quot;</span>             || <span class="keyword">true</span>         | <span class="string">&quot;&quot;</span>             | <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="string">&quot;sky.tiff&quot;</span>             || <span class="keyword">false</span>         | <span class="string">&quot;ERROR002&quot;</span>     | <span class="string">&quot;Tiff files are not</span></span><br><span class="line"><span class="string">                                                    supported&quot;</span></span><br><span class="line">    <span class="string">&quot;dance_bunny.gif&quot;</span>     || <span class="keyword">false</span>         | <span class="string">&quot;ERROR999&quot;</span>     | <span class="string">&quot;Unsupported file</span></span><br><span class="line"><span class="string">                                                        type&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-在Spock中使用数据表"><a href="#5-4-在Spock中使用数据表" class="headerlink" title="5.4 在Spock中使用数据表"></a>5.4 在Spock中使用数据表</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Trivial adder test&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">    Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that it calculates the sum of two numbers&quot;</span></span><br><span class="line">    <span class="comment">//输入和输出参数之间的关系：sum 依赖于 first 和second</span></span><br><span class="line">    adder.add(first,second)==sum</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//参数命名——first和second是输入，sum是输出</span></span><br><span class="line">    <span class="comment">//测试场景包括first和second值以及期望的sum值 </span></span><br><span class="line">    first     |second || sum</span><br><span class="line">    <span class="number">1</span>         | <span class="number">1</span>     || <span class="number">2</span></span><br><span class="line">    <span class="number">3</span>         | <span class="number">2</span>     || <span class="number">5</span></span><br><span class="line">    <span class="number">82</span>         | <span class="number">16</span>     || <span class="number">98</span></span><br><span class="line">    <span class="number">3</span>         | <span class="number">-3</span>     || <span class="number">0</span></span><br><span class="line">    <span class="number">0</span>         | <span class="number">0</span>     || <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-5-在Spock中使用带参数类型的数据表"><a href="#5-5-在Spock中使用带参数类型的数据表" class="headerlink" title="5.5  在Spock中使用带参数类型的数据表"></a>5.5  在Spock中使用带参数类型的数据表</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////声明参数的类型（本案例中都是Integer型）</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;Trivial adder test (alt)&quot;</span>(<span class="keyword">int</span> first, <span class="keyword">int</span> second, <span class="keyword">int</span> sum) &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">    Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that it calculates the sum of two numbers&quot;</span></span><br><span class="line">    <span class="comment">//像之前一样使用参数</span></span><br><span class="line">    adder.add(first,second)==sum</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//声明参数的值（本案例中都是Integer型）</span></span><br><span class="line">    first |second || sum</span><br><span class="line">    <span class="number">1</span> | <span class="number">1</span> || <span class="number">2</span></span><br><span class="line">    <span class="number">3</span> | <span class="number">2</span> || <span class="number">5</span></span><br><span class="line">    <span class="number">82</span> | <span class="number">16</span> || <span class="number">98</span></span><br><span class="line">    <span class="number">3</span> | <span class="number">-3</span> || <span class="number">0</span></span><br><span class="line">    <span class="number">0</span> | <span class="number">0</span> || <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-6-一列数据表"><a href="#5-6-一列数据表" class="headerlink" title="5.6  一列数据表"></a>5.6  一列数据表</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Tiff, gif, raw,mov and bmp are invalid extensions&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an image extension checker&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that only valid filenames are accepted&quot;</span></span><br><span class="line">    <span class="comment">//对于这个案例输出参数永远为false 所有的图像都是无效的</span></span><br><span class="line">    !validator.isValidImageExtension(pictureFile)</span><br><span class="line">    <span class="comment">//下划线可以作为Boolean型结果的过滤器</span></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;sample image names are&quot;</span></span><br><span class="line">    pictureFile         || _</span><br><span class="line">    <span class="string">&quot;screenshot.bmp&quot;</span>     || _</span><br><span class="line">    <span class="string">&quot;IMG3434.raw&quot;</span>         || _</span><br><span class="line">    <span class="string">&quot;christmas.mov&quot;</span>     || _</span><br><span class="line">    <span class="string">&quot;sky.tiff&quot;</span>             || _</span><br><span class="line">    <span class="string">&quot;dance_bunny.gif&quot;</span>     || _</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-7-在数据表中捕获业务需求"><a href="#5-7-在数据表中捕获业务需求" class="headerlink" title="5.7  在数据表中捕获业务需求"></a>5.7  在数据表中捕获业务需求</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Discount estimation for the eshop&quot;</span>() &#123;</span><br><span class="line">    [...rest of code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some of the possible scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//六个输入参数会影响最终的折扣</span></span><br><span class="line">price | isVip | points | order | discount | special || finalDiscount</span><br><span class="line"><span class="comment">//一行写一个业务场景，这样对于业务分析人员来说也是可读的</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">false</span> | <span class="number">0</span>     | <span class="number">50</span>     | <span class="number">0</span>     | <span class="literal">false</span> || <span class="number">0</span></span><br><span class="line"><span class="number">100</span> | <span class="literal">false</span> | <span class="number">0</span>     | <span class="number">300</span>     | <span class="number">0</span>     | <span class="literal">false</span> || <span class="number">10</span></span><br><span class="line"><span class="number">500</span> | <span class="literal">false</span> | <span class="number">0</span>     | <span class="number">0</span>     | <span class="number">0</span>     | <span class="literal">true</span>     || <span class="number">50</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">true</span>     | <span class="number">0</span>     | <span class="number">50</span>     | <span class="number">0</span>     | <span class="literal">false</span> || <span class="number">15</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">true</span>     | <span class="number">0</span>     | <span class="number">50</span>     | <span class="number">25</span>     | <span class="literal">false</span> || <span class="number">25</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">true</span>     | <span class="number">0</span>     | <span class="number">50</span>     | <span class="number">5</span>     | <span class="literal">false</span> || <span class="number">15</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">true</span>     | <span class="number">0</span>     | <span class="number">50</span>     | <span class="number">5</span>     | <span class="literal">true</span>     || <span class="number">50</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">false</span> | <span class="number">0</span>     | <span class="number">100</span>     | <span class="number">0</span>     | <span class="literal">false</span> || <span class="number">0</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">false</span> | <span class="number">0</span>     | <span class="number">75</span>     | <span class="number">10</span>     | <span class="literal">false</span> || <span class="number">10</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">false</span> | <span class="number">5000</span>     | <span class="number">50</span>     | <span class="number">0</span>     | <span class="literal">false</span> || <span class="number">75</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">false</span> | <span class="number">3000</span>     | <span class="number">50</span>     | <span class="number">0</span>     | <span class="literal">false</span> || <span class="number">0</span></span><br><span class="line"><span class="number">50</span>     | <span class="literal">true</span>     | <span class="number">8000</span>     | <span class="number">50</span>     | <span class="number">3</span>     | <span class="literal">false</span> || <span class="number">75</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-8-参数化测试的生命周期"><a href="#5-8-参数化测试的生命周期" class="headerlink" title="5.8 参数化测试的生命周期"></a>5.8 参数化测试的生命周期</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifecycleDataSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="comment">//对于每个场景执行一次when和then语句块</span></span><br><span class="line">    <span class="keyword">def</span> setup() &#123;</span><br><span class="line">        println <span class="string">&quot;Setup prepares next run&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//单个测试方法执行多次</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;Trivial adder test&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">        Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">        println <span class="string">&quot;Given: block runs&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;the add method is called for two numbers&quot;</span></span><br><span class="line">        <span class="keyword">int</span> result = adder.add(first,second)</span><br><span class="line">        println <span class="string">&quot;When: block runs for first = $first and second =</span></span><br><span class="line"><span class="string">                            $second&quot;</span></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;the result should be the sum of them&quot;</span></span><br><span class="line">        result == sum</span><br><span class="line">        println <span class="string">&quot;Then: block is evaluated for sum = $sum&quot;</span></span><br><span class="line">        <span class="comment">//包含三种业务场景输入和输出参数的数据表 </span></span><br><span class="line">        <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">        first |second || sum</span><br><span class="line">        <span class="number">1</span> | <span class="number">1</span>     || <span class="number">2</span></span><br><span class="line">        <span class="number">3</span> | <span class="number">2</span>     || <span class="number">5</span></span><br><span class="line">        <span class="number">3</span> | <span class="number">-3</span>     || <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">def</span> cleanup()</span><br><span class="line">    &#123;</span><br><span class="line">    println <span class="string">&quot;Cleanup releases resources of last run\n&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-9-展开参数化场景"><a href="#5-9-展开参数化场景" class="headerlink" title="5.9 展开参数化场景"></a>5.9 展开参数化场景</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@Unroll标注测试方法 多个业务场景多次执行</span></span><br><span class="line"><span class="meta">@Unroll</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;Trivial adder test&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">    Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;the add method is called for two numbers&quot;</span></span><br><span class="line">    <span class="keyword">int</span> result = adder.add(first,second)</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;the result should be the sum of them&quot;</span></span><br><span class="line">    result ==sum</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//作为单独的单元测试场景，每行一个</span></span><br><span class="line">    first |second || sum</span><br><span class="line">    <span class="number">1</span> | <span class="number">1</span>     || <span class="number">2</span></span><br><span class="line">    <span class="number">3</span> | <span class="number">2</span>     || <span class="number">5</span></span><br><span class="line">    <span class="number">3</span> | <span class="number">-3</span>     || <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-10-打印每个场景的参数"><a href="#5-10-打印每个场景的参数" class="headerlink" title="5.10  打印每个场景的参数"></a>5.10  打印每个场景的参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用带参数的@Unroll以便在最后的运行中使用它们--替代语法</span></span><br><span class="line"><span class="meta">@Unroll</span>(<span class="string">&quot;Adder test #first, #second and #sum (alt2)&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;Trivial adder test (alt2)&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">    Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;the add method is called for two numbers&quot;</span></span><br><span class="line">    <span class="keyword">int</span> result = adder.add(first,second)</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;the result should be the sum of them&quot;</span></span><br><span class="line">    result ==sum</span><br><span class="line">    <span class="comment">//将在测试描述中插入的参数</span></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    first     |second     || sum</span><br><span class="line">    <span class="number">1</span>         | <span class="number">1</span>         || <span class="number">2</span></span><br><span class="line">    <span class="number">3</span>         | <span class="number">2</span>         || <span class="number">5</span></span><br><span class="line">    <span class="number">3</span>         | <span class="number">-3</span>         || <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-11-测试方法上的参数呈现"><a href="#5-11-测试方法上的参数呈现" class="headerlink" title="5.11 测试方法上的参数呈现"></a>5.11 测试方法上的参数呈现</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span></span><br><span class="line"><span class="comment">//参数写在方法名中，而不是使用unroll 字符串</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;Testing the Adder for #first + #second = #sum &quot;</span>&#123;</span><br><span class="line"><span class="attr">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">[...rest of code is same <span class="keyword">as</span> listing <span class="number">5.10</span>...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-12-数据表中的自定义表达式"><a href="#5-12-数据表中的自定义表达式" class="headerlink" title="5.12 数据表中的自定义表达式"></a>5.12 数据表中的自定义表达式</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;Testing the Adder for #first + #second = #sum &quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an adder&quot;</span></span><br><span class="line">    Adder adder = <span class="keyword">new</span> Adder()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that it calculates the sum of two numbers&quot;</span></span><br><span class="line">    adder.add(first,second)==sum</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    first                 |second || sum</span><br><span class="line">    <span class="number">2</span>+<span class="number">3</span>                 | <span class="number">10</span><span class="number">-2</span> || <span class="keyword">new</span></span><br><span class="line">    <span class="comment">//完整的语句直接作为参数写在数据表中</span></span><br><span class="line">                        Integer(<span class="number">13</span>).intValue()</span><br><span class="line">    <span class="comment">//枚举可以作为参数</span></span><br><span class="line">    MyInteger.FIVE.getNumber()</span><br><span class="line">    | MyInteger.NINE.getNumber() || <span class="number">14</span></span><br><span class="line">    <span class="comment">//对象工厂创造动态参数</span></span><br><span class="line">    IntegerFactory.createFrom(<span class="string">&quot;two&quot;</span>) | (<span class="number">7</span><span class="number">-2</span>)*<span class="number">2</span> || <span class="number">12</span></span><br><span class="line">    [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].get(<span class="number">1</span>) | <span class="number">3</span> ||</span><br><span class="line">    IntegerFactory.createFrom(<span class="string">&quot;five&quot;</span>)</span><br><span class="line">    <span class="keyword">new</span> Integer(<span class="number">5</span>).intValue() | <span class="keyword">new</span> String(<span class="string">&quot;cat&quot;</span>).size() ||</span><br><span class="line">    MyInteger.EIGHT.getNumber()</span><br><span class="line">    [<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>].size() | <span class="number">5</span> ||</span><br><span class="line">    IntegerFactory.createFrom(<span class="string">&quot;seven&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-13-简单的数据管道示例"><a href="#5-13-简单的数据管道示例" class="headerlink" title="5.13 简单的数据管道示例"></a>5.13 简单的数据管道示例</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Valid images are PNG and JPEG files only&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an image extension checker&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that only valid filenames are accepted&quot;</span></span><br><span class="line">    <span class="comment">//输入和输出参数的关系</span></span><br><span class="line">    validator.isValidImageExtension(pictureFile) == validPicture</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;sample image names are&quot;</span></span><br><span class="line">    <span class="comment">//输入参数的所有值可以写在集合中</span></span><br><span class="line">    pictureFile &lt;&lt; [<span class="string">&quot;scenery.jpg&quot;</span>,<span class="string">&quot;house.jpeg&quot;</span>, <span class="string">&quot;car.png &quot;</span>,<span class="string">&quot;sky.tiff&quot;</span></span><br><span class="line">    ,<span class="string">&quot;dance_bunny.gif&quot;</span> ]</span><br><span class="line">    <span class="comment">//输出参数的所有值可以写在集合中</span></span><br><span class="line">    validPicture &lt;&lt; [ <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-14-用Groovy-rangs做为数据生成器"><a href="#5-14-用Groovy-rangs做为数据生成器" class="headerlink" title="5.14 用Groovy rangs做为数据生成器"></a>5.14 用Groovy rangs做为数据生成器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Multiplying #first and #second is always a negative number&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;a calculator&quot;</span></span><br><span class="line">    Calculator calc = <span class="keyword">new</span> Calculator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that multiplying a positive and negative number is also</span></span><br><span class="line"><span class="string">    negative&quot;</span></span><br><span class="line">    <span class="comment">//没有输出参数</span></span><br><span class="line">    calc.multiply(first,second) &lt; <span class="number">0</span></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//它会得到60个正数</span></span><br><span class="line">    first &lt;&lt; (<span class="number">20.</span><span class="number">.80</span>)</span><br><span class="line">    <span class="comment">//它会变成60个负数</span></span><br><span class="line">    second &lt;&lt; (<span class="number">-65.</span>.<span class="number">-5</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-15-使用groovy组合"><a href="#5-15-使用groovy组合" class="headerlink" title="5.15 使用groovy组合"></a>5.15 使用groovy组合</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span>(<span class="string">&quot;Checking image name #pictureFile&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;All kinds of JPEG file are accepted&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an image extension checker&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that all jpeg filenames are accepted regardless of case&quot;</span></span><br><span class="line">    validator.isValidImageExtension(pictureFile)</span><br><span class="line">     <span class="comment">//combinations()方法返回 所有变量的一个集合 </span></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;sample image names are&quot;</span></span><br><span class="line">    pictureFile &lt;&lt;                                                GroovyCollections.combinations([[<span class="string">&quot;sample.&quot;</span>,<span class="string">&quot;Sample.&quot;</span>,<span class="string">&quot;SAMPLE.&quot;</span>],[<span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;J&#x27;</span>], [<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;P&#x27;</span>],[<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;&#x27;</span>],[<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;G&#x27;</span>]])*.join()</span><br><span class="line">    <span class="comment">//join方法返回对应每个变量返回一个字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-16-Spock测试中的常量参数"><a href="#5-16-Spock测试中的常量参数" class="headerlink" title="5.16 Spock测试中的常量参数"></a>5.16 Spock测试中的常量参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Multipling #first and #second is always a negative number&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;a calculator&quot;</span></span><br><span class="line">    Calculator calc = <span class="keyword">new</span> Calculator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that multiplying a positive and negative number results in a</span></span><br><span class="line"><span class="string">    negative number&quot;</span></span><br><span class="line">    calc.multiply(first,second) &lt; <span class="number">0</span></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//这个参数对于每个场景是不同的</span></span><br><span class="line">    first &lt;&lt; [<span class="number">20</span>,<span class="number">34</span>,<span class="number">44</span>,<span class="number">67</span>]</span><br><span class="line">    <span class="comment">//这个参与对于每个场景来说是一样的</span></span><br><span class="line">    second = <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-17-Spock测试中的派生参数"><a href="#5-17-Spock测试中的派生参数" class="headerlink" title="5.17 Spock测试中的派生参数"></a>5.17 Spock测试中的派生参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Multipling #first and #second is always a negative number (alt)&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;a calculator&quot;</span></span><br><span class="line">    Calculator calc = <span class="keyword">new</span> Calculator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that multiplying a positive and negative number results in a negative number&quot;</span></span><br><span class="line">    calc.multiply(first,second) &lt; <span class="number">0</span></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;some scenarios are&quot;</span></span><br><span class="line">    <span class="comment">//这个参数被显式的定义了。first是integer型</span></span><br><span class="line">    first &lt;&lt; [<span class="number">20</span>,<span class="number">34</span>,<span class="number">44</span>,<span class="number">67</span>]</span><br><span class="line">    <span class="comment">//这个参数依赖于另一个，&quot;second&quot;是带负号的first</span></span><br><span class="line">    second = first * <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-18-使用现存的数据生成器"><a href="#5-18-使用现存的数据生成器" class="headerlink" title="5.18 使用现存的数据生成器"></a>5.18 使用现存的数据生成器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span>(<span class="string">&quot;Checking image name #pictureFile&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;Valid images are PNG and JPEG files&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;an image extension checker&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;that all filenames are accepted&quot;</span></span><br><span class="line">    validator.isValidImageExtension(pictureFile)</span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;sample image names are&quot;</span></span><br><span class="line">    <span class="comment">//获文件所有行的列表</span></span><br><span class="line">    pictureFile &lt;&lt; <span class="keyword">new</span></span><br><span class="line">                File(<span class="string">&quot;src/test/resources/validImageNames.txt&quot;</span>)</span><br><span class="line">                    .readLines()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>刘琰 范围：第5章 151页-170页</p>
<h3 id="5-19-使用专用数据生成器"><a href="#5-19-使用专用数据生成器" class="headerlink" title="5.19 使用专用数据生成器"></a>5.19 使用专用数据生成器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//类将返回字符串</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvalidNamesGen</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">String</span>&gt;&#123;</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; invalidNames;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> InvalidNamesGen() &#123;</span><br><span class="line">        invalidNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        parse();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> parse() &#123;</span><br><span class="line">            [...code that reads the file and discards</span><br><span class="line">            empty lines, tabs and comments not shown <span class="keyword">for</span> brevity...]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> hasNext() &#123;<span class="comment">//文件中存在行时生成值</span></span><br><span class="line">        <span class="keyword">return</span> counter &lt; invalidNames.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String next() &#123; <span class="comment">//从文件中获取下一行</span></span><br><span class="line">        String result = invalidNames.get(counter);</span><br><span class="line">        counter++;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> remove() &#123; <span class="comment">//在此示例中无需实现</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-20-Spock中使用Java迭代器"><a href="#5-20-Spock中使用Java迭代器" class="headerlink" title="5.20 Spock中使用Java迭代器"></a>5.20 Spock中使用Java迭代器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span>(<span class="string">&quot;检查图片的名字 #pictureFile&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;有效的图像是PNG和JPEG文件&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;图像扩展名检查器&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line">    <span class="comment">//此时您期望图像无效</span></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;所有文件名称都不合法&quot;</span></span><br><span class="line">    !validator.isValidImageExtension(pictureFile) </span><br><span class="line">    </span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;示例图像名称是&quot;</span></span><br><span class="line">    <span class="comment">//指示Spock从自定义类读取字符串。</span></span><br><span class="line">    pictureFile &lt;&lt; <span class="keyword">new</span> InvalidNamesGen() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-21-Spock中使用Java迭代器"><a href="#5-21-Spock中使用Java迭代器" class="headerlink" title="5.21 Spock中使用Java迭代器"></a>5.21 Spock中使用Java迭代器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiVarReader</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Object</span>[]&gt;&#123;</span><span class="comment">//类将返回多个值</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; fileNames;privateList&lt;Boolean&gt; validFlag</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter =<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MultiVarReader() &#123;</span><br><span class="line">        fileNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        validFlag = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        parse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> parse() &#123;</span><br><span class="line">        [...code that reads the file and discards</span><br><span class="line">        empty lines, tabs and comments not shown <span class="keyword">for</span> brevity...]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//在行出现时生成值</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> hasNext() &#123; </span><br><span class="line">        <span class="keyword">return</span> counter&lt; fileNames.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//第一个参数是文件，第二个参数参数是通过/失败结果。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object[] next() &#123; </span><br><span class="line">        Object[] result = <span class="keyword">new</span> Object[<span class="number">2</span>];</span><br><span class="line">        result[<span class="number">0</span>] = fileNames.get(counter);</span><br><span class="line">        result[<span class="number">1</span>] = validFlag.get(counter);</span><br><span class="line">        counter++;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//不需要实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> remove() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-22-Spock中使用多值迭代器"><a href="#5-22-Spock中使用多值迭代器" class="headerlink" title="5.22 Spock中使用多值迭代器"></a>5.22 Spock中使用多值迭代器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span>(<span class="string">&quot;检查图像名称#pictureFile和结果#result&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;有效图像仅有2个：PNG和JPEG&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;图像扩展名检查器&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;所有文件名都分类正确&quot;</span></span><br><span class="line">    validator.isValidImageExtension(pictureFile) == result <span class="comment">//现在的结果是输出参数</span></span><br><span class="line"></span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;示例图像名称是&quot;</span></span><br><span class="line">    <span class="comment">//迭代器一次读取两个参数。</span></span><br><span class="line">    [pictureFile,result] &lt;&lt; <span class="keyword">new</span> MultiVarReader() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-23-Spock中使用多值分配"><a href="#5-23-Spock中使用多值分配" class="headerlink" title="5.23 Spock中使用多值分配"></a>5.23 Spock中使用多值分配</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Unroll</span>(<span class="string">&quot;检查图像名称和结果&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;有效图像仅有PNG和JPEG&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;图像扩展名检查器&quot;</span></span><br><span class="line">    ImageNameValidator validator = <span class="keyword">new</span> ImageNameValidator()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在Spock测试中将使用两个参数：pictureFile和result</span></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;所有文件名都分类正确&quot;</span></span><br><span class="line">    validator.isValidImageExtension(pictureFile) == result </span><br><span class="line">    </span><br><span class="line">    <span class="symbol">where:</span> <span class="string">&quot;示例图像名称是&quot;</span> </span><br><span class="line">    <span class="comment">//多值分配，第一个参数是pictureFile，第二个参数是result</span></span><br><span class="line">    [pictureFile,result] &lt;&lt; [[<span class="string">&quot;sample.jpg&quot;</span>,<span class="literal">true</span>], [<span class="string">&quot;bunny.gif&quot;</span>,<span class="literal">false</span>]] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-Mocking-and-stubbing"><a href="#6-Mocking-and-stubbing" class="headerlink" title="6. Mocking and stubbing"></a>6. Mocking and stubbing</h2><h3 id="6-1-使用模拟合作者"><a href="#6-1-使用模拟合作者" class="headerlink" title="6.1 使用模拟合作者"></a>6.1 使用模拟合作者</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> &#123;</span> <span class="comment">//一个商品类</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> price;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> weight;</span><br><span class="line">    [...getters and setters..]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WarehouseInventory</span> &#123;</span> </span><br><span class="line"><span class="comment">//包括库存商品—我们将对此stub</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> isProductAvailable(String productName)</span><br><span class="line">    &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查商品是否库存</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isProductAvailable(String productName,<span class="keyword">int</span> count) </span><br><span class="line">    &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//快速检查商品可用性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isEmpty() </span><br><span class="line">    &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//测试下的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Basket</span> &#123;</span> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> addProduct(Product product) &#123; <span class="comment">//从用户界面触发</span></span><br><span class="line">        addProduct(product, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> addProduct(Product product, <span class="keyword">int</span> times) &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> getProductTypesCount() &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Setter注入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setWarehouseInventory(WarehouseInventory warehouseInventory) &#123;</span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//需要被测试的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> canShipCompletely() &#123; </span><br><span class="line">        [...code redacted <span class="keyword">for</span> brevity..]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-使用stub控制对被测类的输入"><a href="#6-2-使用stub控制对被测类的输入" class="headerlink" title="6.2 使用stub控制对被测类的输入"></a>6.2 使用stub控制对被测类的输入</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.2</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;空仓库，没有商品可以发货&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车和一个电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;一个空的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory) <span class="comment">//创建Spock stub</span></span><br><span class="line">    inventory.isEmpty() &gt;&gt; <span class="literal">true</span> <span class="comment">//当isEmpty()被调用时，指示stub返回true</span></span><br><span class="line">    basket.setWarehouseInventory(inventory) <span class="comment">//将stub注入被测试类</span></span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加电视&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单无法发货&quot;</span></span><br><span class="line">    !basket.canShipCompletely() <span class="comment">//调用stub behind the scenes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-Stub特定的参数"><a href="#6-3-Stub特定的参数" class="headerlink" title="6.3 Stub特定的参数"></a>6.3 Stub特定的参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.3</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;仓库包含客户购买的所有商品&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车和一个电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;有足够库存的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory) <span class="comment">//创建一个Spock stub</span></span><br><span class="line">    <span class="comment">/**当特定的参数被调用时，指示stub返回true**/</span></span><br><span class="line">    inventory.isProductAvailable(<span class="string">&quot;bravia&quot;</span>,<span class="number">1</span>) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">    inventory.isEmpty() &gt;&gt; <span class="literal">false</span> <span class="comment">//Instructing the warehouse to respond with false</span></span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加电视&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单可以立即发货&quot;</span></span><br><span class="line">    basket.canShipCompletely()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-4-基于参数的stub区分"><a href="#6-4-基于参数的stub区分" class="headerlink" title="6.4 基于参数的stub区分"></a>6.4 基于参数的stub区分</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.4</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;仓库没有客户购买的所有商品，则无法发货&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个电视和一个照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;有部分商品的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory)</span><br><span class="line">    <span class="comment">/**不同的参数有不同的stub结果**/</span></span><br><span class="line">    inventory.isProductAvailable(<span class="string">&quot;bravia&quot;</span>,<span class="number">1</span>) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">    inventory.isProductAvailable(<span class="string">&quot;panasonic&quot;</span>,<span class="number">1</span>) &gt;&gt; <span class="literal">false</span> </span><br><span class="line">    inventory.isEmpty() &gt;&gt; <span class="literal">false</span></span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加所有商品&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单不能立即发货&quot;</span></span><br><span class="line">    !basket.canShipCompletely()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-5-对所有的stub方法分组"><a href="#6-5-对所有的stub方法分组" class="headerlink" title="6.5 对所有的stub方法分组"></a>6.5 对所有的stub方法分组</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.5</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;仓库没有客户购买的所有商品，则无法发货&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个电视和一个照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;有部分商品的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory) &#123;</span><br><span class="line">        <span class="comment">/**Compact way of stubbing methods**/</span></span><br><span class="line">        isProductAvailable(<span class="string">&quot;bravia&quot;</span>,<span class="number">1</span>) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">        isProductAvailable(<span class="string">&quot;panasonic&quot;</span>,<span class="number">1</span>) &gt;&gt; <span class="literal">false</span> </span><br><span class="line">        isEmpty() &gt;&gt; <span class="literal">false</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**Setter injection using Groovy style**/</span></span><br><span class="line">     <span class="comment">/**使用Groovy的样式注入Setter**/</span></span><br><span class="line">    basket.warehouseInventory = inventory </span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加所有商品&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单不能立即发货&quot;</span></span><br><span class="line">    !basket.canShipCompletely()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-6-在stub中使用参数匹配器"><a href="#6-6-在stub中使用参数匹配器" class="headerlink" title="6.6 在stub中使用参数匹配器"></a>6.6 在stub中使用参数匹配器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.6</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;仓库同时具有客户所购买的两种商品&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个电视和一个照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;有足够库存的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory)</span><br><span class="line">    <span class="comment">/**Stubbing a method call regardless of the value </span></span><br><span class="line"><span class="comment">of an argument**/</span></span><br><span class="line">    <span class="comment">/**无论参数的值是什么，Stub一个方法的调用**/</span></span><br><span class="line">    inventory.isProductAvailable(_, <span class="number">1</span>) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加电视和照相机&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    basket.addProduct camera</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单立即发货&quot;</span></span><br><span class="line">    basket.canShipCompletely()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-7-返回结果时，忽略stub方法的所有参数"><a href="#6-7-返回结果时，忽略stub方法的所有参数" class="headerlink" title="6.7 返回结果时，忽略stub方法的所有参数"></a>6.7 返回结果时，忽略stub方法的所有参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.7</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;仓库库存充足&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个电视和一个照相机&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;有无限库存的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory)</span><br><span class="line">    <span class="comment">//对于所有可能的参数，Stub一个方法</span></span><br><span class="line">    inventory.isProductAvailable( _, _) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加多个商品&quot;</span></span><br><span class="line">    <span class="comment">//匹配这两个调用</span></span><br><span class="line">    basket.addProduct tv,<span class="number">33</span> </span><br><span class="line">    basket.addProduct camera,<span class="number">12</span> </span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单立即发货&quot;</span></span><br><span class="line">    basket.canShipCompletely()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-8-Stub后续方法调用"><a href="#6-8-Stub后续方法调用" class="headerlink" title="6.8 Stub后续方法调用"></a>6.8 Stub后续方法调用</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.8</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;在最后时刻检查库存&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车和一个电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;库存不稳定的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory)</span><br><span class="line">    <span class="comment">//第一个调用返回true，第二个调用返回false</span></span><br><span class="line">    inventory.isProductAvailable( <span class="string">&quot;bravia&quot;</span>, _) &gt;&gt;&gt; <span class="literal">true</span> &gt;&gt; <span class="literal">false</span> </span><br><span class="line">    <span class="comment">//对于有序的返回，Spock可以迭代一个集合</span></span><br><span class="line">    inventory.isEmpty() &gt;&gt;&gt; [<span class="literal">false</span>, <span class="literal">true</span>] </span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加电视机&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    <span class="comment">//此场景下第一次调用inventory stub</span></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单立即发货&quot;</span></span><br><span class="line">    basket.canShipCompletely() </span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加另一台电视机&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单无法发货&quot;</span></span><br><span class="line">    <span class="comment">//第二次调用inventory stub</span></span><br><span class="line">    !basket.canShipCompletely() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-9-指示stub抛出异常"><a href="#6-9-指示stub抛出异常" class="headerlink" title="6.9 指示stub抛出异常"></a>6.9 指示stub抛出异常</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.9</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;有问题的仓库无法运送任何商品&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车和一个电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;有严重问题的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory)</span><br><span class="line">    inventory.isProductAvailable( <span class="string">&quot;bravia&quot;</span>, _) &gt;&gt; &#123; <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;critical error&quot;</span>) &#125; <span class="comment">//引入Stub抛出异常</span></span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加电视机&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;订单无法发货&quot;</span></span><br><span class="line">    !basket.canShipCompletely() <span class="comment">//Ensures that the basket class can recover from the exception。确保basket类可以从异常中恢复</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-10-根据参数响应的stub"><a href="#6-10-根据参数响应的stub" class="headerlink" title="6.10 根据参数响应的stub"></a>6.10 根据参数响应的stub</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">例子<span class="number">6.10</span></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;购物车根据商品数量处理运输费用&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车和几种商品&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">    Product hifi = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;jvc&quot;</span>,<span class="attr">price:</span><span class="number">600</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">    Product laptop = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;toshiba&quot;</span>,<span class="attr">price:</span><span class="number">800</span>,<span class="attr">weight:</span><span class="number">10</span>)</span><br><span class="line">    Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个存货充足的仓库&quot;</span></span><br><span class="line">    WarehouseInventory inventory = Stub(WarehouseInventory) <span class="comment">//Stub一个具体的类</span></span><br><span class="line">    inventory.isProductAvailable( _ , _) &gt;&gt; <span class="literal">true</span></span><br><span class="line">    basket.setWarehouseInventory(inventory)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个shippingCalculator每件产品收费10美元&quot;</span></span><br><span class="line">    <span class="comment">/**Stub一个Java接口**/</span></span><br><span class="line">    ShippingCalculator shippingCalculator = Stub(ShippingCalculator) </span><br><span class="line">    shippingCalculator.findShippingCostFor( _, _) &gt;&gt; &#123; Product product, <span class="keyword">int</span> </span><br><span class="line">    count -&gt; <span class="number">10</span> * count&#125; </span><br><span class="line">    basket.setShippingCalculator(shippingCalculator)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;用户在购物车中添加几种不同数量的商品&quot;</span></span><br><span class="line">    basket.addProduct tv, <span class="number">2</span> </span><br><span class="line">    basket.addProduct camera, <span class="number">2</span> </span><br><span class="line">    basket.addProduct hifi </span><br><span class="line">    basket.addProduct laptop, <span class="number">3</span> </span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;正确计算花费&quot;</span></span><br><span class="line">    basket.findTotalCost() == <span class="number">2</span> * tv.price + <span class="number">2</span> * camera.price + hifi.price </span><br><span class="line">    + <span class="number">3</span> * laptop.price + basket.getProductCount() * <span class="number">10</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>纪凯斌 范围：170页 = 190页</p>
<h3 id="6-10-根据参数响应的stub-1"><a href="#6-10-根据参数响应的stub-1" class="headerlink" title="6.10 根据参数响应的stub"></a>6.10 根据参数响应的stub</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;根据产品数量计算运输费用&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮和一些产品&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Product hifi = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;jvc&quot;</span>,<span class="attr">price:</span><span class="number">600</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">         Product laptop = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;toshiba&quot;</span>,<span class="attr">price:</span><span class="number">800</span>,<span class="attr">weight:</span><span class="number">10</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个库存充足的仓库&quot;</span></span><br><span class="line">        <span class="comment">//一个具体类stub</span></span><br><span class="line">         WarehouseInventory inventory = Stub(WarehouseInventory) </span><br><span class="line">         inventory.isProductAvailable( _ , _) &gt;&gt; <span class="literal">true</span></span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个航运计算器，每件产品收费10美元&quot;</span></span><br><span class="line">        <span class="comment">//一个Java接口stub</span></span><br><span class="line">         ShippingCalculator shippingCalculator = Stub(ShippingCalculator)</span><br><span class="line">         shippingCalculator.findShippingCostFor( _, _) &gt;&gt; &#123; Product product, <span class="keyword">int</span></span><br><span class="line">                      <span class="comment">//对动态响应使用Groovy闭包</span></span><br><span class="line">                       count -&gt; <span class="number">10</span> * count&#125; </span><br><span class="line">         basket.setShippingCalculator(shippingCalculator)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查几种不同数量的产品&quot;</span></span><br><span class="line">        <span class="comment">//添加不同数量到购物篮中</span></span><br><span class="line">         basket.addProduct tv, <span class="number">2</span> </span><br><span class="line">         basket.addProduct camera, <span class="number">2</span> </span><br><span class="line">         basket.addProduct hifi </span><br><span class="line">         basket.addProduct laptop, <span class="number">3</span></span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;成本计算正确&quot;</span></span><br><span class="line">         basket.findTotalCost() == <span class="number">2</span> * tv.price + <span class="number">2</span> * camera.price + hifi.price</span><br><span class="line">                       <span class="comment">//确认已包含运费</span></span><br><span class="line">                        + <span class="number">3</span> * laptop.price + basket.getProductCount() * <span class="number">10</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-11-智能stub-查看它的两个参数"><a href="#6-11-智能stub-查看它的两个参数" class="headerlink" title="6.11 智能stub:查看它的两个参数"></a>6.11 智能stub:查看它的两个参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;可卸货物没有运输成本&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮和一些产品&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Product hifi = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;jvc&quot;</span>,<span class="attr">price:</span><span class="number">600</span>,<span class="attr">weight:</span><span class="number">5</span>)</span><br><span class="line">         Product laptop = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;toshiba&quot;</span>,<span class="attr">price:</span><span class="number">800</span>,<span class="attr">weight:</span><span class="number">10</span>)</span><br><span class="line">         Product ebook = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;learning exposure&quot;</span>,<span class="attr">price:</span><span class="number">30</span>,<span class="attr">weight:</span><span class="number">0</span>)</span><br><span class="line">         Product suite = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;adobe essentials&quot;</span>,<span class="attr">price:</span><span class="number">200</span>,<span class="attr">weight:</span><span class="number">0</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个库存充足的仓库&quot;</span></span><br><span class="line">         WarehouseInventory inventory = Stub(WarehouseInventory)</span><br><span class="line">         inventory.isProductAvailable( _ , _) &gt;&gt; <span class="literal">true</span></span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个航运计算器，每件产品收费10美元&quot;</span></span><br><span class="line">         <span class="comment">//一个Java接口stub</span></span><br><span class="line">         ShippingCalculator shippingCalculator = Stub(ShippingCalculator)</span><br><span class="line">         <span class="comment">//使用这两个参数的Groovy闭包</span></span><br><span class="line">         shippingCalculator.findShippingCostFor( _, _) &gt;&gt; &#123; Product product, <span class="keyword">int</span></span><br><span class="line">                       count -&gt; product.weight==<span class="number">0</span> ? <span class="number">0</span> :<span class="number">10</span> * count&#125; </span><br><span class="line">         basket.setShippingCalculator(shippingCalculator)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查几种不同数量的产品&quot;</span></span><br><span class="line">         basket.addProduct tv,<span class="number">2</span></span><br><span class="line">         basket.addProduct camera,<span class="number">2</span></span><br><span class="line">         basket.addProduct hifi</span><br><span class="line">         basket.addProduct laptop</span><br><span class="line">         basket.addProduct ebook</span><br><span class="line">         basket.addProduct suite,<span class="number">3</span></span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;成本计算正确&quot;</span></span><br><span class="line">         <span class="comment">//60是实物的运费</span></span><br><span class="line">         basket.findTotalCost() == <span class="number">2</span> * tv.price + <span class="number">2</span> * camera.price + hifi.price </span><br><span class="line">                 + laptop.price + ebook.price + <span class="number">3</span> * suite.price+ <span class="number">60</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-12-用其他stub对响应进行stub"><a href="#6-12-用其他stub对响应进行stub" class="headerlink" title="6.12 用其他stub对响应进行stub"></a>6.12 用其他stub对响应进行stub</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;如果仓库是空的，什么都不能装运&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">     <span class="symbol">and:</span><span class="string">&quot;一个空的仓库&quot;</span></span><br><span class="line">         <span class="comment">//将被测试的类使用的stub</span></span><br><span class="line">         WarehouseInventory inventory = Stub(WarehouseInventory) </span><br><span class="line">         inventory.isEmpty() &gt;&gt; <span class="literal">true</span></span><br><span class="line">        <span class="comment">//一个中介类stub</span></span><br><span class="line">         ServiceLocator serviceLocator = Stub(ServiceLocator) </span><br><span class="line">        <span class="comment">//指示一个stub返回另一个stub</span></span><br><span class="line">         serviceLocator.getWarehouseInventory() &gt;&gt; inventory </span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个购物篮&quot;</span></span><br><span class="line">        <span class="comment">//使用被测试类中的父stub</span></span><br><span class="line">         EnterprisyBasket basket = <span class="keyword">new</span> EnterprisyBasket(serviceLocator) </span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查电视&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单不能发货&quot;</span></span><br><span class="line">         !basket.canShipCompletely()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-13-stubbing和mock"><a href="#6-13-stubbing和mock" class="headerlink" title="6.13 stubbing和mock"></a>6.13 stubbing和mock</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;如果仓库是空的，什么都不能装运&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮和一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span><span class="string">&quot;一个空的仓库&quot;</span></span><br><span class="line">        <span class="comment">//创建一个mock</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory) </span><br><span class="line">        <span class="comment">//指示mock在调用isEmpty()时返回true。</span></span><br><span class="line">         inventory.isEmpty() &gt;&gt; <span class="literal">true</span> </span><br><span class="line">        <span class="comment">//将mock注入到被测试的类中</span></span><br><span class="line">         basket.setWarehouseInventory(inventory)  </span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查电视&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单不能发货&quot;</span></span><br><span class="line">        <span class="comment">//此方法在后台调用mock</span></span><br><span class="line">         !basket.canShipCompletely() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-14-信用卡收费的Java框架"><a href="#6-14-信用卡收费的Java框架" class="headerlink" title="6.14 信用卡收费的Java框架"></a>6.14 信用卡收费的Java框架</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123; </span><br><span class="line">     <span class="keyword">private</span> String name;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">boolean</span> vip = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//信用卡号码</span></span><br><span class="line">     <span class="keyword">private</span> String creditCard; </span><br><span class="line">     [...getters and setters here...]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> CreditCardResult &#123;</span><br><span class="line">    <span class="comment">//信用卡收费的可能结果</span></span><br><span class="line">     OK, INVALID_CARD, NOT_ENOUGH_FUNDS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//由外部系统提供的接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CreditCardProcessor</span> </span>&#123;</span><br><span class="line">    <span class="comment">//费用方法</span></span><br><span class="line">     <span class="function">CreditCardResult <span class="title">sale</span><span class="params">(<span class="keyword">int</span> amount, Customer customer)</span></span>;</span><br><span class="line">    <span class="comment">//必须每次支付费用后</span></span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BillableBasket</span> <span class="keyword">extends</span> <span class="title">Basket</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> CreditCardProcessor creditCardProcessor;</span><br><span class="line">    <span class="comment">//注入setter</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreditCardProcessor</span><span class="params">(CreditCardProcessor </span></span></span><br><span class="line"><span class="function"><span class="params">             creditCardProcessor)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.creditCardProcessor = creditCardProcessor;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">//触发信用卡注入</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkout</span><span class="params">(Customer customer)</span> </span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">             [...code redacted..]</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-15-mock方法的验证"><a href="#6-15-mock方法的验证" class="headerlink" title="6.15 mock方法的验证"></a>6.15 mock方法的验证</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡连接总是关闭的&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一位顾客和一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span></span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>, <span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一项信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//创建一个mock接口</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor)</span><br><span class="line">        <span class="comment">//将mock导入测试类</span></span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查电视&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">        <span class="comment">//此方法在后台调用mock</span></span><br><span class="line">         basket.checkout(customer)</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;连接在最终总是关闭的&quot;</span></span><br><span class="line">        <span class="comment">//验证调用方法</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.shutdown() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-16-mock方法的特定顺序的验证"><a href="#6-16-mock方法的特定顺序的验证" class="headerlink" title="6.16 mock方法的特定顺序的验证"></a>6.16 mock方法的特定顺序的验证</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡连接总是关闭的&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一位顾客和一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span></span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>, <span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一项信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//创建一个mock接口</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor</span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查电视&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.checkout(customer)</span><br><span class="line">    <span class="comment">//首先，检查此验证。                                            </span></span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡已收费&quot;</span> </span><br><span class="line">         <span class="number">1</span> * creditCardSevice.sale( _, _)</span><br><span class="line">    <span class="comment">//只有在第一个验证通过时才会检查                                            </span></span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡服务已关闭&quot;</span> </span><br><span class="line">         <span class="number">1</span> * creditCardSevice.shutdown() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-17-交互的明确声明"><a href="#6-17-交互的明确声明" class="headerlink" title="6.17 交互的明确声明"></a>6.17 交互的明确声明</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;在仓库中查询每种产品&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一台电视和一个照相机&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个无限库存的仓库&quot;</span></span><br><span class="line">        <span class="comment">//创建一个mock/stub</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory) </span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">    <span class="comment">//mock只能在when：块中进行检查。</span></span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         <span class="keyword">boolean</span> readyToShip = basket.canShipCompletely()</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单可以发货&quot;</span></span><br><span class="line">         readyToShip</span><br><span class="line">        <span class="comment">//一个mock方法stub</span></span><br><span class="line">         <span class="number">2</span> * inventory.isProductAvailable( _ , _) &gt;&gt; <span class="literal">true</span></span><br><span class="line">        <span class="comment">//验证从未调用过方法</span></span><br><span class="line">         <span class="number">0</span> * inventory.preload(_ , _) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-18-验证类中所有方法的交互"><a href="#6-18-验证类中所有方法的交互" class="headerlink" title="6.18 验证类中所有方法的交互"></a>6.18 验证类中所有方法的交互</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;在仓库中精确查询每种产品&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一台电视和一个照相机&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个无限库存的仓库&quot;</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory) </span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         <span class="keyword">boolean</span> readyToShip = basket.canShipCompletely()</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单可以发货&quot;</span></span><br><span class="line">         readyToShip</span><br><span class="line">        <span class="comment">//为特定的方法设定期望</span></span><br><span class="line">         <span class="number">2</span> * inventory.isProductAvailable( _ , _) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">         <span class="number">1</span> * inventory.isEmpty() &gt;&gt; <span class="literal">false</span></span><br><span class="line">        <span class="comment">//为类的所有其他方法设置期望</span></span><br><span class="line">         <span class="number">0</span> * inventory._ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-19-验证所有mock的非交互性"><a href="#6-19-验证所有mock的非交互性" class="headerlink" title="6.19 验证所有mock的非交互性"></a>6.19 验证所有mock的非交互性</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;检查发货状态时，只进行仓库查询&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一台电视和一个照相机&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个无限库存的仓库&quot;</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory)</span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">         ShippingCalculator shippingCalculator = Mock(ShippingCalculator)</span><br><span class="line">         basket.setShippingCalculator(shippingCalculator)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         <span class="keyword">boolean</span> readyToShip = basket.canShipCompletely()</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单可以发货&quot;</span></span><br><span class="line">         readyToShip</span><br><span class="line">        <span class="comment">//下划线匹配参数。</span></span><br><span class="line">         <span class="number">2</span> * inventory.isProductAvailable( _ , _) &gt;&gt; <span class="literal">true</span></span><br><span class="line">        <span class="comment">//下划线匹配调用的数量</span></span><br><span class="line">         _ * inventory.isEmpty() &gt;&gt; <span class="literal">false</span></span><br><span class="line">        <span class="comment">//下划线匹配mock的类</span></span><br><span class="line">         <span class="number">0</span> * _ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-20-当调用mock的方法时，验证参数不为空"><a href="#6-20-当调用mock的方法时，验证参数不为空" class="headerlink" title="6.20 当调用mock的方法时，验证参数不为空"></a>6.20 当调用mock的方法时，验证参数不为空</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;在仓库中查询每种产品——空&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一台电视和一个照相机&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个无限库存的仓库&quot;</span></span><br><span class="line">        <span class="comment">//创建一个Spock mock</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory) </span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         <span class="keyword">boolean</span> readyToShip = basket.canShipCompletely()</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单可以发货&quot;</span></span><br><span class="line">         readyToShip</span><br><span class="line">        <span class="comment">//验证第一个参数不为空</span></span><br><span class="line">         <span class="number">2</span> * inventory.isProductAvailable(!<span class="literal">null</span> ,<span class="number">1</span>) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-21-验证参数的类型"><a href="#6-21-验证参数的类型" class="headerlink" title="6.21 验证参数的类型"></a>6.21 验证参数的类型</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;在仓库中查询每种产品类型&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一台电视和一个照相机&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         Basket basket = <span class="keyword">new</span> Basket()</span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个无限库存的仓库&quot;</span></span><br><span class="line">        <span class="comment">//创建一个Spock mock</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory) </span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         <span class="keyword">boolean</span> readyToShip = basket.canShipCompletely()</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;订单可以发货&quot;</span></span><br><span class="line">         readyToShip</span><br><span class="line">        <span class="comment">//验证第一个参数始终是String型，第二个参数始终是Integer型</span></span><br><span class="line">         <span class="number">2</span> * inventory.isProductAvailable(_ <span class="keyword">as</span> String ,_ <span class="keyword">as</span> Integer) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-22-验证mock方法的精确参数"><a href="#6-22-验证mock方法的精确参数" class="headerlink" title="6.22 验证mock方法的精确参数"></a>6.22 验证mock方法的精确参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;VIP状态已正确传递至信用卡-简易&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一位顾客和一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span></span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//创建一个Spock mock</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor)</span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         basket.checkout(customer)</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡已收费&quot;</span></span><br><span class="line">        <span class="comment">//验证第二个参数等于特定的对象实例</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.sale(<span class="number">1550</span>, customer) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-23-验证对象实例的一部分用作mock参数"><a href="#6-23-验证对象实例的一部分用作mock参数" class="headerlink" title="6.23 验证对象实例的一部分用作mock参数"></a>6.23 验证对象实例的一部分用作mock参数</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;VIP状态已正确传递到信用卡-VIP&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一位顾客和一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span> </span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//创建一个Spock mock</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor) </span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">         basket.checkout(customer)</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡已收费&quot;</span></span><br><span class="line">        <span class="comment">//验证第二个是否有一个名为vip的字段，其值为false</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.sale(<span class="number">1550</span>, &#123; client -&gt; client.vip == <span class="literal">false</span>&#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-24-使用完整的Groovy闭包进行参数验证"><a href="#6-24-使用完整的Groovy闭包进行参数验证" class="headerlink" title="6.24 使用完整的Groovy闭包进行参数验证"></a>6.24 使用完整的Groovy闭包进行参数验证</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;VIP状态已正确传递至信用卡--全&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一位顾客和一台电视&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span></span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//创建一个Spock mock</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor) </span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">        basket.addProduct camera</span><br><span class="line">         basket.checkout(customer)</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡已收费&quot;</span></span><br><span class="line">        <span class="comment">//两个mock参数的自定义表达式</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.sale(&#123;amount -&gt; amount == </span><br><span class="line">                 basket.findOrderPrice()&#125;, &#123; client -&gt; client.vip == <span class="literal">false</span>&#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-25-在同一测试中使用mock和stub"><a href="#6-25-在同一测试中使用mock和stub" class="headerlink" title="6.25 在同一测试中使用mock和stub"></a>6.25 在同一测试中使用mock和stub</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;卡内没有资金&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一位顾客和一些产品&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span></span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//创建一个Spock mock</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor) </span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个存货充足的仓库&quot;</span></span><br><span class="line">        <span class="comment">//库存已满stub</span></span><br><span class="line">         WarehouseInventory inventory = Stub(WarehouseInventory) &#123; </span><br><span class="line">                 isProductAvailable(_ , _) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">                 isEmpty() &gt;&gt; <span class="literal">false</span> </span><br><span class="line">         &#125;</span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">        <span class="comment">//触发测试的动作</span></span><br><span class="line">         <span class="keyword">boolean</span> charged = basket.fullCheckout(customer)</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;如果信用卡没有足够的钱，则不支付任何费用&quot;</span></span><br><span class="line">        <span class="comment">//信用卡无效mock</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.authorize(<span class="number">1550</span>, customer) &gt;&gt; </span><br><span class="line">                       CreditCardResult.NOT_ENOUGH_FUNDS</span><br><span class="line">        <span class="comment">//确认没有支付任何费用</span></span><br><span class="line">         !charged </span><br><span class="line">         <span class="number">0</span> * _ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-26-验证事件的顺序与互连方法调用"><a href="#6-26-验证事件的顺序与互连方法调用" class="headerlink" title="6.26 验证事件的顺序与互连方法调用"></a>6.26 验证事件的顺序与互连方法调用</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡销售的幸福之路&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;一个购物篮，一个顾客和一些产品&quot;</span></span><br><span class="line">         Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">         Product camera = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;panasonic&quot;</span>,<span class="attr">price:</span><span class="number">350</span>,<span class="attr">weight:</span><span class="number">2</span>)</span><br><span class="line">         BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">         Customer customer = <span class="keyword">new</span></span><br><span class="line">         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;信用卡有足够的资金&quot;</span></span><br><span class="line">        <span class="comment">//信用卡服务mock</span></span><br><span class="line">         CreditCardProcessor creditCardSevice = Mock(CreditCardProcessor) </span><br><span class="line">         basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">         CreditCardResult sampleResult = CreditCardResult.OK</span><br><span class="line">        <span class="comment">//创建一个信用卡样本token</span></span><br><span class="line">         sampleResult.setToken(<span class="string">&quot;sample&quot;</span>);</span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;一个仓库&quot;</span></span><br><span class="line">        <span class="comment">//仓库mock</span></span><br><span class="line">         WarehouseInventory inventory = Mock(WarehouseInventory) </span><br><span class="line">         basket.setWarehouseInventory(inventory)</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;用户检查两个产品&quot;</span></span><br><span class="line">         basket.addProduct tv</span><br><span class="line">         basket.addProduct camera</span><br><span class="line">        <span class="comment">//触发测试动作</span></span><br><span class="line">         <span class="keyword">boolean</span> charged = basket.fullCheckout(customer)</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡已检查&quot;</span></span><br><span class="line">        <span class="comment">//传递token样本到basket类</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.authorize(<span class="number">1550</span>, customer) &gt;&gt; sampleResult</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;检查库存&quot;</span></span><br><span class="line">        <span class="comment">//使用with（）进行群组互动</span></span><br><span class="line">         with(inventory) &#123;</span><br><span class="line">                <span class="comment">//验证是否两次查询库存（每个产品一次）</span></span><br><span class="line">                 <span class="number">2</span> * isProductAvailable(!<span class="literal">null</span> , <span class="number">1</span>) &gt;&gt; <span class="literal">true</span> </span><br><span class="line">                 _ * isEmpty() &gt;&gt; <span class="literal">false</span></span><br><span class="line">         &#125;</span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;信用卡已收费&quot;</span></span><br><span class="line">         <span class="number">1</span> * creditCardSevice.capture(&#123;myToken -&gt; myToken.endsWith(<span class="string">&quot;sample&quot;</span>)&#125;,</span><br><span class="line">                      <span class="comment">//验证先前的token已被basket类重用</span></span><br><span class="line">                       customer) &gt;&gt; CreditCardResult.OK </span><br><span class="line">         <span class="comment">//验证信用卡已收费</span></span><br><span class="line">        charged </span><br><span class="line">         <span class="comment">//确保没有调用mock中的其他方法</span></span><br><span class="line">        <span class="number">0</span> * _ </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>姓名：杨潇涵</li>
<li>范围：191页 - 210页</li>
</ul>
<h2 id="7-Spock的集成测试和功能测试"><a href="#7-Spock的集成测试和功能测试" class="headerlink" title="7. Spock的集成测试和功能测试"></a>7. Spock的集成测试和功能测试</h2><h3 id="7-1-从Spock测试访问Spring上下文"><a href="#7-1-从Spock测试访问Spring上下文" class="headerlink" title="7.1 从Spock测试访问Spring上下文"></a>7.1 从Spock测试访问Spring上下文</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用@ContextConfiguration去Mock这个测试</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:spring-context.xml&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealDatabaseSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//按照正常的生产代码的方式连接spring bean</span></span><br><span class="line">    ProductLoader productLoader</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Sql(&quot;clear-db.sql&quot;)</span> </span><br><span class="line">    def <span class="string">&quot;测试：产品类的hibernate映射&quot;</span>() &#123;</span><br><span class="line">        given: <span class="string">&quot;创建一个新产品&quot;</span></span><br><span class="line">        productLoader.createDefaultProduct() <span class="comment">//将数据存入数据库</span></span><br><span class="line">        </span><br><span class="line">        when: <span class="string">&quot;获取数据库中所有的产品&quot;</span></span><br><span class="line">        List&lt;Product&gt; allProducts = productLoader.getAllProducts(); <span class="comment">//再一次从数据库读取</span></span><br><span class="line"></span><br><span class="line">        then: <span class="string">&quot;数据库里应该有这些产品&quot;</span></span><br><span class="line">        allProducts.size() == <span class="number">1</span> <span class="comment">//验证数据库读取</span></span><br><span class="line"></span><br><span class="line">        and: <span class="string">&quot;这些产品的ID应该是从0开始&quot;</span></span><br><span class="line">        allProducts[<span class="number">0</span>].getStock() ==<span class="number">0</span> <span class="comment">//验证数据库读取</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这个栗( li )子中：<ol>
<li>最重要的一行是@ContextConfiguration注释，目的是让Spock来理解这是一个基于Spring的集成测试。</li>
<li>还要注意，使用Spring@Sql注释，它允许你在测试之前运行Sql文件。在上面这个例子里，@sql由Spring提供了，并且在Spock测试中工作正常。</li>
</ol>
</li>
</ul>
<h3 id="7-2-自动回滚数据库的更改"><a href="#7-2-自动回滚数据库的更改" class="headerlink" title="7.2 自动回滚数据库的更改"></a>7.2 自动回滚数据库的更改</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:spring-context.xml&quot;)</span> </span><br><span class="line"><span class="meta">@Transactional</span> <span class="comment">//做个测试，使用Transactional</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealDatabaseSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  ProductLoader productLoader</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Rollback</span> <span class="comment">//在测试结束后，数据库的更改将被还原一次</span></span><br><span class="line">  <span class="meta">@Sql(&quot;clear-db.sql&quot;)</span> </span><br><span class="line">  def <span class="string">&quot;测试：产品类的hibernate映射&quot;</span>() &#123;</span><br><span class="line">    [...code redacted <span class="keyword">for</span> brevity...]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这个栗( li )子中：<ol>
<li>@Transactional注释通知Spring这个测试，将使用数据库的Transactional。</li>
<li>@Rollback注释告诉Spring在测试换Spock中的方法后，恢复全部数据库的更改。</li>
</ol>
</li>
</ul>
<h3 id="7-3-使用简化的Spring上下文进行单元测试"><a href="#7-3-使用简化的Spring上下文进行单元测试" class="headerlink" title="7.3 使用简化的Spring上下文进行单元测试"></a>7.3 使用简化的Spring上下文进行单元测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:reduced-test-context.xml&quot;)</span> <span class="comment">//定义可供替代的Spring context</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DummyDatabaseSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ProductLoader productLoader</span><br><span class="line"></span><br><span class="line">    def <span class="string">&quot;测试：产品类的hibernate映射 - 内存数据库&quot;</span>() &#123;</span><br><span class="line">      given: <span class="string">&quot;创建一个新产品&quot;</span></span><br><span class="line">      productLoader.createDefaultProduct() <span class="comment">//数据写入内存数据库</span></span><br><span class="line"></span><br><span class="line">      when: <span class="string">&quot;获取数据库中所有的产品&quot;</span></span><br><span class="line">      List&lt;Product&gt; allProducts = productLoader.getAllProducts(); <span class="comment">//数据在内存数据库中，测试速度非常快</span></span><br><span class="line"></span><br><span class="line">      then: <span class="string">&quot;数据库里应该有这些产品&quot;</span></span><br><span class="line">      allProducts.size() == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      and: <span class="string">&quot;这些产品的ID应该是从0开始&quot;</span></span><br><span class="line">      allProducts[<span class="number">0</span>].stock ==<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-4-在Spock测试中使用Groovy-SQL准备数据"><a href="#7-4-在Spock测试中使用Groovy-SQL准备数据" class="headerlink" title="7.4 在Spock测试中使用Groovy SQL准备数据"></a>7.4 在Spock测试中使用Groovy SQL准备数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration(locations = &quot;classpath:reduced-test-context.xml&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DummyDatabaseGroovySqlWriteSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource <span class="comment">//获取底层来自Spring的数据源</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ProductLoader productLoader</span><br><span class="line"></span><br><span class="line">    def <span class="string">&quot;测试：产品加入购物车&quot;</span>() &#123;</span><br><span class="line">        given: <span class="string">&quot;创建三个产品&quot;</span></span><br><span class="line">        Sql sql = <span class="keyword">new</span> Sql(dataSource) <span class="comment">//用Groovy SQL创建一个现有数据源</span></span><br><span class="line">        sql.execute(<span class="string">&quot;DELETE FROM PRODUCT&quot;</span>)  <span class="comment">//清除数据</span></span><br><span class="line">        sql.execute(<span class="string">&quot;INSERT INTO PRODUCT (id,name,price, weight,stock) VALUES (1, &#x27;samsung&#x27;,400,1,45);&quot;</span>) <span class="comment">//插入数据</span></span><br><span class="line">        sql.execute(<span class="string">&quot;INSERT INTO PRODUCT (id,name,price, weight,stock) VALUES (2, &#x27;bravia&#x27;,1200,3,2);&quot;</span>) <span class="comment">//插入数据</span></span><br><span class="line">        sql.execute(<span class="string">&quot;INSERT INTO PRODUCT (id,name,price, weight,stock) VALUES (3, &#x27;canon&#x27;,500,5,23);&quot;</span>) <span class="comment">//插入数据</span></span><br><span class="line"></span><br><span class="line">        when: <span class="string">&quot;获取数据库中购物车里的所有的产品&quot;</span></span><br><span class="line">        List&lt;Product&gt; allProducts = productLoader.getAllProducts();</span><br><span class="line"></span><br><span class="line">        then: <span class="string">&quot;新建的三个产品应该有名字&quot;</span></span><br><span class="line">        allProducts.size() == <span class="number">3</span></span><br><span class="line">        allProducts[<span class="number">0</span>].name ==<span class="string">&quot;bravia&quot;</span></span><br><span class="line">        allProducts[<span class="number">1</span>].name ==<span class="string">&quot;canon&quot;</span></span><br><span class="line">        allProducts[<span class="number">2</span>].name ==<span class="string">&quot;samsung&quot;</span></span><br><span class="line">        </span><br><span class="line">        cleanup: <span class="string">&quot;删除插入的数据&quot;</span></span><br><span class="line">        sql.execute(<span class="string">&quot;DELETE FROM PRODUCT&quot;</span>) <span class="comment">//清理干净，避免影响别人</span></span><br><span class="line">        sql.close() </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-5-在Spock测试中使用Groovy-SQL准备数据-改进版"><a href="#7-5-在Spock测试中使用Groovy-SQL准备数据-改进版" class="headerlink" title="7.5 在Spock测试中使用Groovy SQL准备数据 - 改进版"></a>7.5 在Spock测试中使用Groovy SQL准备数据 - 改进版</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def <span class="string">&quot;测试购买产品 - 改进版&quot;</span>() &#123;</span><br><span class="line">    given: <span class="string">&quot;创建三个产品&quot;</span></span><br><span class="line">    Sql sql = <span class="keyword">new</span> Sql(dataSource) </span><br><span class="line">    sql.execute(<span class="string">&quot;DELETE FROM PRODUCT&quot;</span>)</span><br><span class="line">    String insertProduct = <span class="string">&quot;INSERT INTO PRODUCT (id,name,price, weight,stock) VALUES (?, ?,?,?,?);&quot;</span> <span class="comment">//定义参数化SQL语句</span></span><br><span class="line">    sql.execute(insertProduct,[<span class="number">1</span>, <span class="string">&#x27;samsung&#x27;</span>,<span class="number">400</span>,<span class="number">1</span>,<span class="number">45</span>]) <span class="comment">//运行相同的SQL语句不同的参数</span></span><br><span class="line">    sql.execute(insertProduct,[<span class="number">2</span>, <span class="string">&#x27;bravia&#x27;</span>,<span class="number">1200</span>,<span class="number">3</span>,<span class="number">2</span>]) <span class="comment">//运行相同的SQL语句不同的参数</span></span><br><span class="line">    sql.execute(insertProduct,[<span class="number">3</span>, <span class="string">&#x27;canon&#x27;</span>,<span class="number">500</span>,<span class="number">5</span>,<span class="number">23</span>]) <span class="comment">//运行相同的SQL语句不同的参数</span></span><br><span class="line"></span><br><span class="line">    when: <span class="string">&quot;获取数据库中购物车里的所有的产品&quot;</span></span><br><span class="line">    List&lt;Product&gt; allProducts = productLoader.getAllProducts();</span><br><span class="line"></span><br><span class="line">    then: <span class="string">&quot;新建的三个产品应该有名字&quot;</span></span><br><span class="line">    allProducts.size() == <span class="number">3</span></span><br><span class="line">    allProducts[<span class="number">0</span>].name ==<span class="string">&quot;bravia&quot;</span></span><br><span class="line">    allProducts[<span class="number">1</span>].name ==<span class="string">&quot;canon&quot;</span></span><br><span class="line">    allProducts[<span class="number">2</span>].name ==<span class="string">&quot;samsung&quot;</span></span><br><span class="line"></span><br><span class="line">    cleanup: <span class="string">&quot;删除插入的数据&quot;</span></span><br><span class="line">    sql.execute(<span class="string">&quot;DELETE FROM PRODUCT&quot;</span>)</span><br><span class="line">    sql.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-6-手动创建Spring上下文"><a href="#7-6-手动创建Spring上下文" class="headerlink" title="7.6 手动创建Spring上下文"></a>7.6 手动创建Spring上下文</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ManualInjectionSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span></span>&#123;</span><br><span class="line">  def <span class="string">&quot;测试：产品类的hibernate映射 - 内存数据库&quot;</span>() &#123;</span><br><span class="line">    given: <span class="string">&quot;一个产品的DAO&quot;</span></span><br><span class="line">    ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;reduced-test-context.xml&quot;</span>); <span class="comment">//从XML文件创建Spring上下文</span></span><br><span class="line">    ProductLoader productLoader = ctx.getBean(ProductLoader.class) //手动初始化spring bean</span><br><span class="line"></span><br><span class="line">    when: <span class="string">&quot;获取数据库中所有的产品&quot;</span></span><br><span class="line">    List&lt;Product&gt; allProducts = productLoader.getAllProducts(); <span class="comment">//使用spring bean</span></span><br><span class="line"></span><br><span class="line">    then: <span class="string">&quot;这个数据库应该没有数据&quot;</span></span><br><span class="line">    allProducts.size() == <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-7-使用Spock和spring-ResTemplate测试REST服务"><a href="#7-7-使用Spock和spring-ResTemplate测试REST服务" class="headerlink" title="7.7 使用Spock和spring ResTemplate测试REST服务"></a>7.7 使用Spock和spring ResTemplate测试REST服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def <span class="string">&quot;简单状态检查程序&quot;</span>() &#123;</span><br><span class="line">    when: <span class="string">&quot;对状态页执行发送请求&quot;</span></span><br><span class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate() <span class="comment">//创建Spring REST客户端</span></span><br><span class="line">    String status = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/rest-service-example/status&quot;</span>, String.class) //对 /status 发送GET请求</span><br><span class="line"></span><br><span class="line">    then: <span class="string">&quot;等待响应&quot;</span></span><br><span class="line">    status == <span class="string">&quot;Up and Running&quot;</span> <span class="comment">//检查响应</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-8-按顺序运行多个测试方法"><a href="#7-8-按顺序运行多个测试方法" class="headerlink" title="7.8 按顺序运行多个测试方法"></a>7.8 按顺序运行多个测试方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Stepwise</span> <span class="comment">//确保所有方法都按源文件中显示的顺序运行</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringRestSpec</span> <span class="keyword">extends</span> <span class="title">Specification</span> </span>&#123;</span><br><span class="line">    def <span class="string">&quot;简单状态检查程序&quot;</span>() &#123;</span><br><span class="line">        when: <span class="string">&quot;对状态页执行发送请求&quot;</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate()</span><br><span class="line">        String status = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/rest-service-example/status&quot;</span>, String.class)</span><br><span class="line"></span><br><span class="line">        then: <span class="string">&quot;等待响应&quot;</span></span><br><span class="line">        status == <span class="string">&quot;Up and Running&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def <span class="string">&quot;清空产品&quot;</span>() &#123;</span><br><span class="line">        given: <span class="string">&quot;发送请求删除所有数据&quot;</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate()</span><br><span class="line">        restTemplate.delete(<span class="string">&quot;http://localhost:8080/rest-service-example/products&quot;</span>) <span class="comment">//对 /products 发送DELETE请求</span></span><br><span class="line"></span><br><span class="line">        when: <span class="string">&quot;请求产品列表&quot;</span></span><br><span class="line">        List&lt;Product&gt; products = </span><br><span class="line">        restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/rest-service-example/products&quot;</span>, List.class) //对 /products 发送GET请求</span><br><span class="line"></span><br><span class="line">        then: <span class="string">&quot;产品列表应该为空&quot;</span></span><br><span class="line">        products.size() == <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    def <span class="string">&quot;新建一个产品&quot;</span>() &#123;</span><br><span class="line">        given: <span class="string">&quot;一个rest请求模板&quot;</span></span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate()</span><br><span class="line"></span><br><span class="line">        when: <span class="string">&quot;创建一个产品&quot;</span></span><br><span class="line">        Product product = restTemplate.postForObject(<span class="string">&quot;http://localhost:8080/rest-service-example/products&quot;</span>,<span class="string">&quot;unused&quot;</span>,Product.class) //对 /products 发送POST请求</span><br><span class="line"></span><br><span class="line">        and: <span class="string">&quot;请求产品列表&quot;</span></span><br><span class="line">        List&lt;Product&gt; products = restTemplate.getForObject(<span class="string">&quot;http://localhost:8080/rest-service-example/products&quot;</span>, List.class) </span><br><span class="line"></span><br><span class="line">        then: <span class="string">&quot;这个产品应该默认的属性&quot;</span></span><br><span class="line">        with(product) <span class="comment">//检查JSON响应</span></span><br><span class="line">        &#123;</span><br><span class="line">            name == <span class="string">&quot;A product&quot;</span></span><br><span class="line">            stock == <span class="number">0</span></span><br><span class="line">            price == <span class="number">0</span></span><br><span class="line">            weight == <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        and: <span class="string">&quot;产品列表不为空&quot;</span></span><br><span class="line">        products.size() == <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>张老师 </p>
<h3 id="7-9-在Spock-test-中使用Groovy-RESTClient"><a href="#7-9-在Spock-test-中使用Groovy-RESTClient" class="headerlink" title="7.9 在Spock test 中使用Groovy RESTClient"></a>7.9 在Spock test 中使用Groovy RESTClient</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Stepwise</span>  <span class="comment">//确保所有的方法按顺序执行</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroovyRestClientSpec</span> <span class="keyword">extends</span> <span class="title">Specification</span> &#123;</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">//创建一个REST客户端</span></span><br><span class="line"> <span class="meta">@Shared</span></span><br><span class="line"> <span class="keyword">def</span> client = <span class="keyword">new</span> RESTClient(<span class="string">&quot;http://localhost:8080/rest-service-example/&quot;</span>) </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">def</span> <span class="string">&quot;简单状态检查器&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;一个rest请求发送至状态页面&quot;</span></span><br><span class="line">     <span class="comment">//在状态节点发起一个GET请求    </span></span><br><span class="line">     <span class="keyword">def</span> response = client.get(<span class="attr">path :</span> <span class="string">&quot;status&quot;</span>) </span><br><span class="line">     </span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;应获取正确的消息响应&quot;</span></span><br><span class="line">     with(response)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="comment">//检查响应文本</span></span><br><span class="line">        data.text == <span class="string">&quot;Up and Running&quot;</span> </span><br><span class="line">         <span class="comment">//检查HTTP错误码</span></span><br><span class="line">        status == <span class="number">200</span> </span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">                             </span><br><span class="line"> <span class="keyword">def</span> <span class="string">&quot;清除所有的产品&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">given:</span> <span class="string">&quot;发起一个清除所有东西的 rest 请求&quot;</span></span><br><span class="line">     <span class="comment">//在products节点发起一个DELETE请求</span></span><br><span class="line">    client.delete(<span class="attr">path :</span> <span class="string">&quot;products&quot;</span>) </span><br><span class="line">     </span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;一个产品列表被请求&quot;</span></span><br><span class="line">     <span class="keyword">def</span> response = client.get(<span class="attr">path :</span> <span class="string">&quot;products&quot;</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;产品列表应该被清空&quot;</span></span><br><span class="line">     with(response)</span><br><span class="line">     &#123;</span><br><span class="line">     data.isEmpty()</span><br><span class="line">     status == <span class="number">200</span></span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line">                             </span><br><span class="line"> <span class="keyword">def</span> <span class="string">&quot;创建一个产品&quot;</span>() &#123;</span><br><span class="line">     <span class="symbol">when:</span> <span class="string">&quot;一个新产品被创建&quot;</span></span><br><span class="line">     <span class="comment">//在products节点发起一个POST请求</span></span><br><span class="line">     <span class="keyword">def</span> response = client.post(<span class="attr">path :</span> <span class="string">&quot;products&quot;</span>) </span><br><span class="line">     </span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;产品列表再次被GET请求&quot;</span></span><br><span class="line">     <span class="keyword">def</span> listResponse = client.get(<span class="attr">path :</span> <span class="string">&quot;products&quot;</span>)</span><br><span class="line">     </span><br><span class="line">     <span class="symbol">then:</span> <span class="string">&quot;新产品应该有缺省值&quot;</span></span><br><span class="line">     with(response)</span><br><span class="line">     &#123;</span><br><span class="line">         data.name == <span class="string">&quot;A product&quot;</span></span><br><span class="line">         data.stock == <span class="number">0</span></span><br><span class="line">         data.price == <span class="number">0</span></span><br><span class="line">         status == <span class="number">200</span></span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="symbol">and:</span> <span class="string">&quot;产品列表应该包括这个产品&quot;</span></span><br><span class="line">     listResponse.data.size() == <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-10-同时使用Geb和Spock，加载Web浏览器"><a href="#7-10-同时使用Geb和Spock，加载Web浏览器" class="headerlink" title="7.10 同时使用Geb和Spock，加载Web浏览器"></a>7.10 同时使用Geb和Spock，加载Web浏览器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePageSpec</span> <span class="keyword">extends</span> <span class="title">GebSpec</span> &#123;</span> <span class="comment">//Spock类使得Geb方法可用</span></span><br><span class="line">     <span class="keyword">def</span> <span class="string">&quot;使用Geb测试来请求主页&quot;</span>() &#123;</span><br><span class="line">         <span class="symbol">when:</span> <span class="string">&quot;跳转到主页&quot;</span></span><br><span class="line">         <span class="comment">//让测试浏览器加载指定的URL</span></span><br><span class="line">        Browser.drive &#123; </span><br><span class="line">             go <span class="string">&quot;http://localhost:8080/web-ui-    example/index.html&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="symbol">then:</span> <span class="string">&quot;首页应该被正确加载&quot;</span></span><br><span class="line">        <span class="comment">//测试应用的标题</span></span><br><span class="line">         title == <span class="string">&quot;Spock/Geb Web example&quot;</span> </span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-11-使用Geb获取页面内容"><a href="#7-11-使用Geb获取页面内容" class="headerlink" title="7.11 使用Geb获取页面内容"></a>7.11 使用Geb获取页面内容</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;Trivial Geb test for homepage -header check&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;打开主页&quot;</span></span><br><span class="line">        Browser.drive &#123;</span><br><span class="line">        go <span class="string">&quot;http://localhost:8080/web-ui-example/index.html&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;首页应该被加载&quot;</span></span><br><span class="line">        <span class="comment">//在浏览器中启动应用程序的主页</span></span><br><span class="line">        title == <span class="string">&quot;Spock/Geb Web example&quot;</span></span><br><span class="line">        <span class="comment">//检查页面中的要素</span></span><br><span class="line">        $(<span class="string">&quot;h1&quot;</span>).text() == <span class="string">&quot;Java Testing with Spock - Sample code&quot;</span></span><br><span class="line">        <span class="comment">//使用“active” CSS类检查页面中被激活的要素</span></span><br><span class="line">        $(<span class="string">&quot;.active&quot;</span>).text() == <span class="string">&quot;Welcome&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="7-12-使用Geb来提交HTML表单"><a href="#7-12-使用Geb来提交HTML表单" class="headerlink" title="7.12 使用Geb来提交HTML表单"></a>7.12 使用Geb来提交HTML表单</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Stepwise</span>  <span class="comment">//确保测试方法按照顺序执行</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddProductGebSpec</span> <span class="keyword">extends</span> <span class="title">GebSpec</span> &#123;</span><span class="comment">//使用Geb的类库</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;导航至页面&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;打开了一个新产品页面&quot;</span></span><br><span class="line">            Browser.drive &#123;</span><br><span class="line">                <span class="comment">//导航至HTML页面</span></span><br><span class="line">                go <span class="string">&quot;http://localhost:8080/web-ui-example/addproduct.html&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;表单应该被加载&quot;</span></span><br><span class="line">            <span class="comment">//确保浏览器中的页面正确</span></span><br><span class="line">            $(<span class="string">&quot;.col1&quot;</span>).$(<span class="string">&quot;h2&quot;</span>).text() == <span class="string">&quot;New Product details&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;创建新的产品&quot;</span>() &#123;</span><br><span class="line">        <span class="symbol">when:</span> <span class="string">&quot;填入了产品信息&quot;</span></span><br><span class="line">            <span class="comment">//在输入框中录入文本</span></span><br><span class="line">            $(<span class="string">&quot;input[name=&#x27;productName&#x27;]&quot;</span>).value(<span class="string">&quot;Bravia TV&quot;</span>)</span><br><span class="line">            <span class="comment">//点击页面按钮</span></span><br><span class="line">            $(<span class="string">&quot;#createProductButton&quot;</span>).click()</span><br><span class="line"></span><br><span class="line">        <span class="symbol">then:</span> <span class="string">&quot;应该看到一个成功的消息&quot;</span></span><br><span class="line">            <span class="comment">//确定页面显示成功的消息</span></span><br><span class="line">            $(<span class="string">&quot;.ok&quot;</span>).text() == <span class="string">&quot;You added new product named: Bravia TV.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-13-在Tomcat中运行Spock功能测试"><a href="#7-13-在Tomcat中运行Spock功能测试" class="headerlink" title="7.13 在Tomcat中运行Spock功能测试"></a>7.13 在Tomcat中运行Spock功能测试</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[...rest of pom.xml....]</span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    [...rest of build plugins....]</span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-failsafe-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>integration-test<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">useFile</span>&gt;</span>false<span class="tag">&lt;/<span class="name">useFile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*Spec.java<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>tomcat-run<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>run-war-only<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">phase</span>&gt;</span>pre-integration-test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>tomcat-shutdown<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>shutdown<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">phase</span>&gt;</span>post-integration-test<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="7-14-在Spock中使用JaCoCo"><a href="#7-14-在Spock中使用JaCoCo" class="headerlink" title="7.14 在Spock中使用JaCoCo"></a>7.14 在Spock中使用JaCoCo</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[...rest of build plugins here...]</span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jacoco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jacoco-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.4.201502262128<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>prepare-agent<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">goal</span>&gt;</span>prepare-agent<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">[...rest of pom.xml here...]</span><br></pre></td></tr></table></figure>



<h2 id="8-Spock在企业级测试中的应用"><a href="#8-Spock在企业级测试中的应用" class="headerlink" title="8 Spock在企业级测试中的应用"></a>8 Spock在企业级测试中的应用</h2><h3 id="8-1-Spock中对异常的测试"><a href="#8-1-Spock中对异常的测试" class="headerlink" title="8.1 Spock中对异常的测试"></a>8.1 Spock中对异常的测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;对于未知产品的异常情况&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个库存&quot;</span></span><br><span class="line">        WarehouseInventory inventory = <span class="keyword">new</span> WarehouseInventory()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;请求从仓库发出一个错误的产品&quot;</span></span><br><span class="line">        inventory.isProductAvailable(<span class="string">&quot;productThatDoesNotExist&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;一个异常应该被抛出&quot;</span></span><br><span class="line">    <span class="comment">//只有当IllegalArgumentException异常抛出的时候，测试才能通过</span></span><br><span class="line">        thrown(IllegalArgumentException)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-一个预期异常的细节测试"><a href="#8-2-一个预期异常的细节测试" class="headerlink" title="8.2 一个预期异常的细节测试"></a>8.2 一个预期异常的细节测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;改进测试未知产品的错误情况&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个库存&quot;</span></span><br><span class="line">        WarehouseInventory inventory = <span class="keyword">new</span> WarehouseInventory()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;请求从仓库发出一个错误的产品&quot;</span></span><br><span class="line">        inventory.isProductAvailable(<span class="string">&quot;productThatDoesNotExist&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;一个异常应该被正确抛出&quot;</span></span><br><span class="line">        IllegalArgumentException e = thrown()</span><br><span class="line">        <span class="comment">//只有当这个异常包括正确的信息时才能测试通过</span></span><br><span class="line">        <span class="comment">//确保异常在变量e中抛出</span></span><br><span class="line">        e.getMessage() == <span class="string">&quot;Unknown product productThatDoesNotExist&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-3-明确的声明一个异常不应该抛出"><a href="#8-3-明确的声明一个异常不应该抛出" class="headerlink" title="8.3 明确的声明一个异常不应该抛出"></a>8.3 明确的声明一个异常不应该抛出</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;产品数量为负值时，按照0处理&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个库存&quot;</span></span><br><span class="line">        WarehouseInventory inventory = <span class="keyword">new</span> WarehouseInventory()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个产品&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;库存初始化时为负值&quot;</span></span><br><span class="line">        inventory.preload(tv,<span class="number">-5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;这个产品的库存应该为0&quot;</span></span><br><span class="line">        <span class="comment">//明确测试正常时，不会抛出异常</span></span><br><span class="line">        notThrown(IllegalArgumentException)</span><br><span class="line">        !inventory.isProductAvailable(tv.getName(),<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-4-标记一个测试方法所解决的缺陷或问题"><a href="#8-4-标记一个测试方法所解决的缺陷或问题" class="headerlink" title="8.4 标记一个测试方法所解决的缺陷或问题"></a>8.4 标记一个测试方法所解决的缺陷或问题</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//标记这个方法解决了JIRA-561这个问题</span></span><br><span class="line"><span class="meta">@Issue</span>(<span class="string">&quot;JIRA-561&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;未知产品的异常情况&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个库存&quot;</span></span><br><span class="line">        WarehouseInventory inventory = <span class="keyword">new</span> WarehouseInventory()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;一个错误产品申请了入库&quot;</span></span><br><span class="line">        inventory.isProductAvailable(<span class="string">&quot;productThatDoesNotExist&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;一个异常将会抛出&quot;</span></span><br><span class="line">        thrown(IllegalArgumentException)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-5-标记一个Spock所解决问题的链接"><a href="#8-5-标记一个Spock所解决问题的链接" class="headerlink" title="8.5 标记一个Spock所解决问题的链接"></a>8.5 标记一个Spock所解决问题的链接</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个测试方法确认解决了Remine issue 2554所记录的问题</span></span><br><span class="line"><span class="meta">@Issue</span>(<span class="string">&quot;http://redmine.example.com/issues/2554&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;更好的测试未知产品的错误情况&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个库存&quot;</span></span><br><span class="line">        WarehouseInventory inventory = <span class="keyword">new</span> WarehouseInventory()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;一个错误产品申请了入库&quot;</span></span><br><span class="line">        inventory.isProductAvailable(<span class="string">&quot;productThatDoesNotExist&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;一个异常将会抛出&quot;</span></span><br><span class="line">        IllegalArgumentException e = thrown()</span><br><span class="line">        e.getMessage() == <span class="string">&quot;Uknown product productThatDoesNotExist&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-6-用多个issues标记Spock测试"><a href="#8-6-用多个issues标记Spock测试" class="headerlink" title="8.6 用多个issues标记Spock测试"></a>8.6 用多个issues标记Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个测试方法解决了多个问题</span></span><br><span class="line"><span class="meta">@Issue</span>([<span class="string">&quot;JIRA-453&quot;</span>,<span class="string">&quot;JIRA-678&quot;</span>,<span class="string">&quot;JIRA-3485&quot;</span>])</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;产品数量为负值时，按照0处理&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个库存&quot;</span></span><br><span class="line">        WarehouseInventory inventory = <span class="keyword">new</span> WarehouseInventory()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个产品&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;库存初始化时为负值&quot;</span></span><br><span class="line">        inventory.preload(tv,<span class="number">-5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;这个产品的库存应该为0&quot;</span></span><br><span class="line">        notThrown(IllegalArgumentException)</span><br><span class="line">        !inventory.isProductAvailable(tv.getName(),<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-7-声明一个测试的最大时长"><a href="#8-7-声明一个测试的最大时长" class="headerlink" title="8.7 声明一个测试的最大时长"></a>8.7 声明一个测试的最大时长</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个测试应该在5秒内完成</span></span><br><span class="line"><span class="meta">@Timeout</span>(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡收费流程是一个 happy path&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个客户和一台电视&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">        Customer customer = <span class="keyword">new</span></span><br><span class="line">        Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个信用卡服务&quot;</span></span><br><span class="line">        <span class="comment">//CreditCardProcessor是一个外部服务</span></span><br><span class="line">        CreditCardProcessor creditCardSevice = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line">        basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;客户购买了电视&quot;</span></span><br><span class="line">        basket.addProduct tv</span><br><span class="line">        <span class="comment">//这是一个跟信用卡服务相关的很耗时的方法</span></span><br><span class="line">        <span class="keyword">boolean</span> success = basket.checkout(customer)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;信用卡被扣款&quot;</span></span><br><span class="line">        success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-8-自定义一个测试耗时限制"><a href="#8-8-自定义一个测试耗时限制" class="headerlink" title="8.8 自定义一个测试耗时限制"></a>8.8 自定义一个测试耗时限制</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将时间单位设置为毫秒</span></span><br><span class="line"><span class="meta">@Timeout</span>(value = <span class="number">5000</span>, unit = TimeUnit.MILLISECONDS)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡收费的happy path - 变化版 &quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个客户和一台电视&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">        Customer customer = <span class="keyword">new</span></span><br><span class="line">        Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个信用卡服务&quot;</span></span><br><span class="line">        CreditCardProcessor creditCardSevice = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line">        basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;客户购买了电视&quot;</span></span><br><span class="line">        basket.addProduct tv</span><br><span class="line">        <span class="keyword">boolean</span> success = basket.checkout(customer)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;信用卡被扣款&quot;</span></span><br><span class="line">        success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-9-忽略某个测试"><a href="#8-9-忽略某个测试" class="headerlink" title="8.9 忽略某个测试"></a>8.9 忽略某个测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Spock测试的时候，这个测试将跳过</span></span><br><span class="line"><span class="meta">@Ignore</span>(<span class="string">&quot;直到信用卡服务器迁移完毕&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡收费的happy path&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一个购物车，一个客户和一台电视&quot;</span></span><br><span class="line">        Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">        BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">        Customer customer = <span class="keyword">new</span></span><br><span class="line">        Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;一个信用卡服务&quot;</span></span><br><span class="line">        CreditCardProcessor creditCardSevice = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line">        basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span> <span class="string">&quot;客户购买了电视&quot;</span></span><br><span class="line">        basket.addProduct tv</span><br><span class="line">        <span class="keyword">boolean</span> success = basket.checkout(customer)</span><br><span class="line">        </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;信用卡被扣款&quot;</span></span><br><span class="line">        success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>何思雨</p>
<h3 id="8-10-只执行一个测试，忽略其他测试"><a href="#8-10-只执行一个测试，忽略其他测试" class="headerlink" title="8.10  只执行一个测试，忽略其他测试"></a>8.10  只执行一个测试，忽略其他测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeepOneSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    <span class="comment">//这个测试使用了真正的信用卡服务，将被略过</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;信用卡扣款-集成测试&quot;</span>()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//只有IgnoreRest标注的这个测试会执行</span></span><br><span class="line">    <span class="meta">@IgnoreRest</span></span><br><span class="line">    <span class="comment">//这个测试使用了模拟的方法，会正常执行</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;模拟信用卡扣款&quot;</span>()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这个测试使用了真正的信用卡服务，将被略过</span></span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;信用卡免费-集成测试&quot;</span>()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-11-根据环境跳过Spock测试"><a href="#8-11-根据环境跳过Spock测试" class="headerlink" title="8.11 根据环境跳过Spock测试"></a>8.11 根据环境跳过Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleConditionalSpec</span> <span class="keyword">extends</span> <span class="title">spock</span>.<span class="title">lang</span>.<span class="title">Specification</span>&#123;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//在Java9.中，这个测试将会被跳过</span></span><br><span class="line">    <span class="meta">@IgnoreIf</span>(&#123;jvm.java9 &#125;)</span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;信用卡扣款快乐之路&quot;</span>()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//若在Windows系统下，这个测试将会被跳过</span></span><br><span class="line">     <span class="meta">@IgnoreIf</span>(&#123;os.windows &#125;)</span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;信用卡扣款快乐之路-支路1&quot;</span>()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//若SKIP_SPOCK_TESTS的Properties类被定义，这个测试将会被跳过</span></span><br><span class="line">    <span class="comment">//Properties（Java.util.Properties），该类主要用于读取Java的配置文件。在Java中，其配置文件常为.properties文件，是以键值对的形式进行参数配置的。</span></span><br><span class="line">     <span class="meta">@IgnoreIf</span>(&#123;env.containsKey(<span class="string">&quot;SKIP_SPOCK_TESTS&quot;</span>) &#125;)</span><br><span class="line">    <span class="keyword">def</span> <span class="string">&quot;信用卡扣款快乐之路-支路2&quot;</span>()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-12-基于动态前提条件跳过Spock测试"><a href="#8-12-基于动态前提条件跳过Spock测试" class="headerlink" title="8.12  基于动态前提条件跳过Spock测试"></a>8.12  基于动态前提条件跳过Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//只有当信用卡服务online()方法执行结果为true，这个测试才会被执行</span></span><br><span class="line"><span class="meta">@IgnoreIf</span> (&#123; !<span class="keyword">new</span> CreditCardProcessor().online() &#125;)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡扣款快乐之路-支路1&quot;</span>()&#123;</span><br><span class="line">    <span class="symbol">given:</span><span class="string">&quot;一个购物车，一位顾客和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">    Customer customer = <span class="keyword">new</span>         Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">    <span class="comment">//CreditCardProcessor类是一个外部服务</span></span><br><span class="line">    CreditCardProcessor creditCardSevice = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line">    basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;顾客查看了电视&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    <span class="comment">//这个操作涉及了信用卡服务</span></span><br><span class="line">    <span class="keyword">boolean</span> success = basket.checkout(customer)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span><span class="string">&quot;信用卡扣款&quot;</span></span><br><span class="line">    success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-13-Requires——IgnoreIf的反义词"><a href="#8-13-Requires——IgnoreIf的反义词" class="headerlink" title="8.13  Requires——IgnoreIf的反义词"></a>8.13  Requires——IgnoreIf的反义词</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//只有当信用卡服务online()方法执行结果为true，这个测试才会被执行</span></span><br><span class="line"><span class="meta">@Requires</span>(&#123; <span class="keyword">new</span> CreditCardProcessor().online() &#125;)</span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;信用卡收费快乐之路&quot;</span>()&#123;</span><br><span class="line">    <span class="symbol">given:</span><span class="string">&quot;一个购物车，一位顾客和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">    Customer customer = <span class="keyword">new</span>     Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">    <span class="comment">//CreditCardProcessor类是一个外部服务</span></span><br><span class="line">    CreditCardProcessor creditCardSevice = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line">    basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;顾客查看了电视&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    <span class="comment">//这个操作涉及了信用卡服务</span></span><br><span class="line">    <span class="keyword">boolean</span> success = basket.checkout(customer)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span><span class="string">&quot;信用卡扣款&quot;</span></span><br><span class="line">    success</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Requires声明在语义上与@IgnoreIf相同，但行为正好相反，如果闭包内的代码计算结果不为真，则Spock将跳过测试，使用哪一个看个人偏好。</p>
<h3 id="8-14-使用AutoCleanup释放资源"><a href="#8-14-使用AutoCleanup释放资源" class="headerlink" title="8.14  使用AutoCleanup释放资源"></a>8.14  使用AutoCleanup释放资源</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在测试最后，信用卡服务的shutdown()方法将被唤起</span></span><br><span class="line"><span class="meta">@AutoCleanup</span>(<span class="string">&quot;shutdown&quot;</span>)</span><br><span class="line"><span class="keyword">private</span> CreditCardProcessor creditCardSevice = <span class="keyword">new</span> CreditCardProcessor()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="string">&quot;最后关闭信用卡连接&quot;</span>()&#123;</span><br><span class="line">    <span class="symbol">given:</span><span class="string">&quot;一个购物车，一位顾客和一台电视&quot;</span></span><br><span class="line">    Product tv = <span class="keyword">new</span> Product(<span class="attr">name:</span><span class="string">&quot;bravia&quot;</span>,<span class="attr">price:</span><span class="number">1200</span>,<span class="attr">weight:</span><span class="number">18</span>)</span><br><span class="line">    BillableBasket basket = <span class="keyword">new</span> BillableBasket()</span><br><span class="line">    Customer customer = <span class="keyword">new</span>     Customer(<span class="attr">name:</span><span class="string">&quot;John&quot;</span>,<span class="attr">vip:</span><span class="literal">false</span>,<span class="attr">creditCard:</span><span class="string">&quot;testCard&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;信用卡服务&quot;</span></span><br><span class="line">    basket.setCreditCardProcessor(creditCardSevice)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;顾客查看了电视&quot;</span></span><br><span class="line">    basket.addProduct tv</span><br><span class="line">    <span class="keyword">boolean</span> success = basket.checkout(customer)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span><span class="string">&quot;信用卡扣款&quot;</span></span><br><span class="line">    success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-15-不要花长时间设置一个Spock测试"><a href="#8-15-不要花长时间设置一个Spock测试" class="headerlink" title="8.15 不要花长时间设置一个Spock测试"></a>8.15 不要花长时间设置一个Spock测试</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;拥有3张信用卡的银行客户永远贷不了款&quot;</span>()&#123;</span><br><span class="line">    <span class="symbol">given:</span><span class="string">&quot;有一位顾客想要贷款&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John Doe&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个糟糕的and:设计块，包含了太多代码</span></span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;他的信用卡&quot;</span></span><br><span class="line">    BankAccount account1 = <span class="keyword">new</span> BankAccount()</span><br><span class="line">    account1.with&#123;</span><br><span class="line">        setNumber(<span class="string">&quot;234234&quot;</span>)</span><br><span class="line">        setHolder(<span class="string">&quot;John doe&quot;</span>)</span><br><span class="line">        balance = <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">    CreditCard card1 = <span class="keyword">new</span> CreditCard(<span class="string">&quot;447978956666&quot;</span>)</span><br><span class="line">    card1.with&#123;</span><br><span class="line">        setHolder(<span class="string">&quot;John Doe&quot;</span>)</span><br><span class="line">        assign(account1)</span><br><span class="line">    &#125;</span><br><span class="line">    customer.owns(card1)</span><br><span class="line">    BankAccount account2 = <span class="keyword">new</span> BankAccount()</span><br><span class="line">    account2.with&#123;</span><br><span class="line">        setNumber(<span class="string">&quot;3435676&quot;</span>)</span><br><span class="line">        setHolder(<span class="string">&quot;John doe&quot;</span>)</span><br><span class="line">        balance = <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">    CreditCard card2 = <span class="keyword">new</span> CreditCard(<span class="string">&quot;4443543354&quot;</span>)</span><br><span class="line">    card2.with&#123;</span><br><span class="line">        setHolder(<span class="string">&quot;John Doe&quot;</span>)</span><br><span class="line">        assign(account2)</span><br><span class="line">    &#125;</span><br><span class="line">    customer.owns(card2)</span><br><span class="line">    BankAccount account3 = <span class="keyword">new</span> BankAccount()</span><br><span class="line">    account2.with&#123;</span><br><span class="line">        setNumber(<span class="string">&quot;45465&quot;</span>)</span><br><span class="line">        setHolder(<span class="string">&quot;John doe&quot;</span>)</span><br><span class="line">        balance = <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">    CreditCard card3 = <span class="keyword">new</span> CreditCard(<span class="string">&quot;444455556666&quot;</span>)</span><br><span class="line">    card3.with&#123;</span><br><span class="line">        setHolder(<span class="string">&quot;John Doe&quot;</span>)</span><br><span class="line">        assign(account3)</span><br><span class="line">    &#125;</span><br><span class="line">    customer.owns(card3)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个好的when:设计模块，代码很短</span></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    Loan loan = <span class="keyword">new</span> Loan()</span><br><span class="line">    customer.requests(loan)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//一个好的then:设计模块，代码很短</span></span><br><span class="line">    <span class="symbol">then:</span><span class="string">&quot;贷款申请不通过&quot;</span></span><br><span class="line">    !loan.approved</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-16-Spock测试的帮助器"><a href="#8-16-Spock测试的帮助器" class="headerlink" title="8.16  Spock测试的帮助器"></a>8.16  Spock测试的帮助器</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;拥有3张信用卡的银行客户永远贷不了款-方式1&quot;</span>()&#123;</span><br><span class="line">    <span class="symbol">given:</span><span class="string">&quot;有一位顾客想要贷款&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John Doe&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span><span class="string">&quot;他的信用卡&quot;</span></span><br><span class="line">    <span class="comment">//现在设置的代码清楚简短</span></span><br><span class="line">    customer.owns(createSampleCreditCard(<span class="string">&quot;447978956666&quot;</span>,<span class="string">&quot;John Doe&quot;</span>))</span><br><span class="line">    customer.owns(createSampleCreditCard(<span class="string">&quot;4443543354&quot;</span>,<span class="string">&quot;John Doe&quot;</span>))</span><br><span class="line">    customer.owns(createSampleCreditCard(<span class="string">&quot;444455556666&quot;</span>,<span class="string">&quot;John Doe&quot;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    Loan loan = <span class="keyword">new</span> Loan()</span><br><span class="line">    customer.requests(loan)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">then:</span><span class="string">&quot;贷款申请不通过&quot;</span></span><br><span class="line">    !loan.approved</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//与信用卡有关的一个帮助器</span></span><br><span class="line"><span class="keyword">private</span> CreditCard createSampleCreditCard(String number,String holder)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//helper方法中隐含了每张信用卡都需要一个银行账户</span></span><br><span class="line">    BankAccount account = <span class="keyword">new</span> BankAccount()</span><br><span class="line">    account.with&#123;</span><br><span class="line">        setNumber(<span class="string">&quot;45465&quot;</span>)</span><br><span class="line">        setHolder(holder)</span><br><span class="line">        balance = <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">    CreditCard card = <span class="keyword">new</span> CreditCard(number)</span><br><span class="line">    card.with&#123;</span><br><span class="line">        setHolder(holder)</span><br><span class="line">        assign(account)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这个helper方法生成了一张信用卡</span></span><br><span class="line">    <span class="keyword">return</span> card</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-17-在测试中用参数来体现重要性"><a href="#8-17-在测试中用参数来体现重要性" class="headerlink" title="8.17  在测试中用参数来体现重要性"></a>8.17  在测试中用参数来体现重要性</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;拥有3张信用卡的银行客户永远贷不了款-方式2&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;有一位顾客想要贷款&quot;</span></span><br><span class="line">    <span class="comment">//同一位客户即要贷款有信用卡业务</span></span><br><span class="line">    String customerName =<span class="string">&quot;doesNotMatter&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span>customerName)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;他的信用卡&quot;</span></span><br><span class="line">    <span class="comment">//弄清楚贷款审批中未使用信用卡卡号</span></span><br><span class="line">    customer.owns(createSampleCreditCard(<span class="string">&quot;anything&quot;</span>,customerName))</span><br><span class="line">    customer.owns(createSampleCreditCard(<span class="string">&quot;whatever&quot;</span>,customerName))</span><br><span class="line">    customer.owns(createSampleCreditCard(<span class="string">&quot;notImportant&quot;</span>,customerName))</span><br><span class="line"></span><br><span class="line">    <span class="symbol">expect:</span> <span class="string">&quot;顾客已有三张信用卡&quot;</span></span><br><span class="line">    <span class="comment">//明确验证设置的结果</span></span><br><span class="line">    customer.getCards().size() == <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    Loan loan = new Loan()</span></span><br><span class="line"><span class="string">    customer.requests(loan)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    then: &quot;</span>贷款申请不通过<span class="string">&quot;</span></span><br><span class="line"><span class="string">    !loan.approved</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="8-18-Spock测试中不确定的then：模块"><a href="#8-18-Spock测试中不确定的then：模块" class="headerlink" title="8.18 Spock测试中不确定的then：模块"></a>8.18 Spock测试中不确定的then：模块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;对贷款的正常审批&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一位银行客户&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John</span></span><br><span class="line"><span class="string">Doe&quot;</span>,<span class="attr">city:</span><span class="string">&quot;London&quot;</span>,<span class="attr">address:</span><span class="string">&quot;10 Bakers&quot;</span>,<span class="attr">phone:</span><span class="string">&quot;32434&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;他/她需要买房&quot;</span></span><br><span class="line">    Loan loan = <span class="keyword">new</span> Loan(<span class="attr">years:</span><span class="number">5</span>, <span class="attr">amount:</span><span class="number">200.000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    customer.requests(loan)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;贷款已根据这些条件审批&quot;</span></span><br><span class="line">    <span class="comment">//所有这些信息用于贷款审查审批</span></span><br><span class="line">    loan.approved</span><br><span class="line">    loan.amount == <span class="number">200.000</span></span><br><span class="line">    loan.years == <span class="number">5</span></span><br><span class="line">    loan.instalments == <span class="number">60</span></span><br><span class="line">    <span class="comment">//这些核对是次要的</span></span><br><span class="line">    loan.getContactDetails().getPhone() == <span class="string">&quot;32434&quot;</span></span><br><span class="line">    loan.getContactDetails().getAddress() == <span class="string">&quot;10 Bakers&quot;</span></span><br><span class="line">    loan.getContactDetails().getCity() == <span class="string">&quot;London&quot;</span></span><br><span class="line">    loan.getContactDetails().getName() == <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">    customer.activeLoans == <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-19-有明确分区检查的Spock测试进阶版"><a href="#8-19-有明确分区检查的Spock测试进阶版" class="headerlink" title="8.19  有明确分区检查的Spock测试进阶版"></a>8.19  有明确分区检查的Spock测试进阶版</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;对贷款的正常审批-方法1 &quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一位银行客户&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John</span></span><br><span class="line"><span class="string">Doe&quot;</span>,<span class="attr">city:</span><span class="string">&quot;London&quot;</span>,<span class="attr">address:</span><span class="string">&quot;10 Bakers&quot;</span>,<span class="attr">phone:</span><span class="string">&quot;32434&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;他/她需要买房&quot;</span></span><br><span class="line">    <span class="comment">//明确预期结果之间的联系</span></span><br><span class="line">    <span class="keyword">int</span> sampleTimeSpan=<span class="number">5</span></span><br><span class="line">    <span class="keyword">int</span> sampleAmount = <span class="number">200.000</span></span><br><span class="line">    Loan loan = <span class="keyword">new</span> Loan(<span class="attr">years:</span>sampleTimeSpan, <span class="attr">amount:</span>sampleAmount)</span><br><span class="line">   </span><br><span class="line">      <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    customer.requests(loan)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;贷款已根据这些条件审批&quot;</span></span><br><span class="line">    <span class="comment">//对主要的贷款检查进行分组</span></span><br><span class="line">    with(loan)</span><br><span class="line">    &#123;</span><br><span class="line">        approved</span><br><span class="line">        amount == sampleAmount</span><br><span class="line">        years == sampleTimeSpan</span><br><span class="line">        <span class="comment">//明确预期结果</span></span><br><span class="line">        installments == sampleTimeSpan * <span class="number">12</span></span><br><span class="line">    &#125;</span><br><span class="line">    customer.activeLoans == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//次要的检查列为不同的模块</span></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;保留或记录联系方式&quot;</span></span><br><span class="line">    with(loan.contactDetails)</span><br><span class="line">    &#123;</span><br><span class="line">        getPhone() == <span class="string">&quot;32434&quot;</span></span><br><span class="line">        getAddress() == <span class="string">&quot;10 Bakers&quot;</span></span><br><span class="line">        getCity() == <span class="string">&quot;London&quot;</span></span><br><span class="line">        getName() == <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;                                   </span><br></pre></td></tr></table></figure>
<h3 id="8-20-使用帮助器认定"><a href="#8-20-使用帮助器认定" class="headerlink" title="8.20  使用帮助器认定"></a>8.20  使用帮助器认定</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;对贷款的正常审批-提高版&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一位银行客户&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John</span></span><br><span class="line"><span class="string">Doe&quot;</span>,<span class="attr">city:</span><span class="string">&quot;London&quot;</span>,<span class="attr">address:</span><span class="string">&quot;10 Bakers&quot;</span>,<span class="attr">phone:</span><span class="string">&quot;32434&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;他/她需要买房&quot;</span></span><br><span class="line">    <span class="keyword">int</span> sampleTimeSpan=<span class="number">5</span></span><br><span class="line">    <span class="keyword">int</span> sampleAmount = <span class="number">200.000</span></span><br><span class="line">    Loan loan = <span class="keyword">new</span> Loan(<span class="attr">years:</span>sampleTimeSpan, <span class="attr">amount:</span>sampleAmount)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    customer.requests(loan)</span><br><span class="line"> </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;贷款已根据这些条件审批&quot;</span>  </span><br><span class="line">    <span class="comment">//有描述性名字的帮助器                     </span></span><br><span class="line">                                                                                   loanApprovedAsRequested(customer,loan,sampleTimeSpan,sampleAmount)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;保留或记录联系方式&quot;</span></span><br><span class="line">    <span class="comment">//有描述性名字的帮助器</span></span><br><span class="line">    contactDetailsMatchCustomer(customer,loan)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> loanApprovedAsRequested(Customer customer,Loan loan,<span class="keyword">int</span></span><br><span class="line">originalYears,<span class="keyword">int</span> originalAmount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//在帮助器中，with()方法按照预期执行</span></span><br><span class="line">    with(loan)</span><br><span class="line">    &#123;</span><br><span class="line">        approved</span><br><span class="line">        amount == originalAmount</span><br><span class="line">        loan.years == originalYears</span><br><span class="line">        loan.instalments == originalYears * <span class="number">12</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//在帮助器中，需要认定关键字</span></span><br><span class="line">    <span class="keyword">assert</span> customer.activeLoans == <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">                                     </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> contactDetailsMatchCustomer(Customer customer,Loan loan )</span><br><span class="line">&#123;</span><br><span class="line">    with(loan.contactDetails)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//需要明确贷款和申请人之间的关系</span></span><br><span class="line">        phone == customer.phone</span><br><span class="line">        address == customer.address</span><br><span class="line">        city == customer.city</span><br><span class="line">        name== customer.name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-21-Spock测试中有问题的then：模块"><a href="#8-21-Spock测试中有问题的then：模块" class="headerlink" title="8.21 Spock测试中有问题的then：模块"></a>8.21 Spock测试中有问题的then：模块</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;对贷款的正常审批&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一位银行客户&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John</span></span><br><span class="line"><span class="string">Doe&quot;</span>,<span class="attr">city:</span><span class="string">&quot;London&quot;</span>,<span class="attr">address:</span><span class="string">&quot;10 Bakers&quot;</span>,<span class="attr">phone:</span><span class="string">&quot;32434&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;他/她需要买房&quot;</span></span><br><span class="line">    Loan loan = Mock(Loan)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    customer.requests(loan)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;贷款已根据这些条件审批&quot;</span></span><br><span class="line">    <span class="comment">//申请贷款时的主要检查项</span></span><br><span class="line">    <span class="number">1</span> * loan.setApproved(<span class="literal">true</span>)</span><br><span class="line">    <span class="number">0</span> * loan.setAmount(_)</span><br><span class="line">    <span class="number">0</span> * loan.setYears(_)</span><br><span class="line">    <span class="comment">//测试正确的功能所需要的方法存根</span></span><br><span class="line">    _ * loan.getYears() &gt;&gt; <span class="number">5</span></span><br><span class="line">    _ * loan.getAmount() &gt;&gt; <span class="number">200.000</span></span><br><span class="line">    _ * loan.getContactDetails() &gt;&gt; <span class="keyword">new</span> ContactDetails()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-22-在交互时明确声明使用的帮助器方法"><a href="#8-22-在交互时明确声明使用的帮助器方法" class="headerlink" title="8.22  在交互时明确声明使用的帮助器方法"></a>8.22  在交互时明确声明使用的帮助器方法</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;对贷款的正常审批-方法1&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一位银行客户&quot;</span></span><br><span class="line">    Customer customer = <span class="keyword">new</span> Customer(<span class="attr">name:</span><span class="string">&quot;John</span></span><br><span class="line"><span class="string">Doe&quot;</span>,<span class="attr">city:</span><span class="string">&quot;London&quot;</span>,<span class="attr">address:</span><span class="string">&quot;10 Bakers&quot;</span>,<span class="attr">phone:</span><span class="string">&quot;32434&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;他/她需要买房&quot;</span></span><br><span class="line">    Loan loan = Mock(Loan)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;申请贷款&quot;</span></span><br><span class="line">    customer.requests(loan)</span><br><span class="line">                                     </span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;对贷款需求进行评估&quot;</span></span><br><span class="line">    <span class="comment">//包含模拟的帮助器方法需要交互块。</span></span><br><span class="line">    interaction &#123;</span><br><span class="line">        <span class="comment">//以业务检查命名的帮助器方法</span></span><br><span class="line">        loanDetailsWereExamined(loan)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;贷款已根据这些条件审批&quot;</span></span><br><span class="line">    <span class="comment">//包含模拟的帮助器方法需要交互块。</span></span><br><span class="line">    interaction &#123;</span><br><span class="line">        <span class="comment">//以业务检查命名的帮助器方法</span></span><br><span class="line">        loanWasApprovedWithNoChanges(loan)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">                                     </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> loanWasApprovedWithNoChanges(Loan loan)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">1</span> * loan.setApproved(<span class="literal">true</span>)</span><br><span class="line">    <span class="number">0</span> * loan.setAmount(_)</span><br><span class="line">    <span class="number">0</span> * loan.setYears(_)</span><br><span class="line">&#125;</span><br><span class="line">                                     </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> loanDetailsWereExamined(Loan loan)</span><br><span class="line">&#123;</span><br><span class="line">    _ * loan.getYears() &gt;&gt; <span class="number">5</span></span><br><span class="line">    _ * loan.getAmount() &gt;&gt; <span class="number">200.000</span></span><br><span class="line">    _ * loan.getContactDetails() &gt;&gt; <span class="keyword">new</span> ContactDetails()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-23-设计有问题的Java代码"><a href="#8-23-设计有问题的Java代码" class="headerlink" title="8.23  设计有问题的Java代码"></a>8.23  设计有问题的Java代码</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从摄像机获取帧</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraFeed</span> &#123;</span></span><br><span class="line">    </span><br><span class="line">    [...为了简洁，不列具体代码...]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setCurrentFrame(Image image)&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//负责硬盘的删除</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HardDriveNuker</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//立即删除硬盘驱动器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> deleteHardDriveNow()&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//包含复杂的图像识别逻辑</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmartHardDriveNuker</span> <span class="keyword">extends</span> <span class="title">HardDriveNuker</span>&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//幕后称之为deleteHardDriveNow()方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> activate(CameraFeed cameraFeed)&#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-24-用spock生成一个监控"><a href="#8-24-用spock生成一个监控" class="headerlink" title="8.24  用spock生成一个监控"></a>8.24  用spock生成一个监控</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;代理商在的时候，自动删除硬盘&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一种相机原料&quot;</span></span><br><span class="line">    CameraFeed cameraFeed = <span class="keyword">new</span> CameraFeed()</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;自动销毁程序&quot;</span></span><br><span class="line">    <span class="comment">//生成一个对SmartHardDriveNuker类的监控</span></span><br><span class="line">    SmartHardDriveNuker nuker = Spy(SmartHardDriveNuker)</span><br><span class="line">    <span class="comment">//模拟危险的方法—其他所有方法都是真实的</span></span><br><span class="line">    nuker.deleteHardDriveNow() &gt;&gt; &#123;println <span class="string">&quot;硬盘被清除&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;代理商在敲门&quot;</span></span><br><span class="line">    cameraFeed.setCurrentFrame(ImageIO.read(getClass().getResourceAsStream(</span><br><span class="line"><span class="string">&quot;agents.jpg&quot;</span>)))</span><br><span class="line">    <span class="comment">//运行真正的人脸识别代码</span></span><br><span class="line">    nuker.activate(cameraFeed);</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;硬盘上的所有文件都删除&quot;</span></span><br><span class="line">    <span class="comment">//检验模拟方法</span></span><br><span class="line">    <span class="number">1</span> * nuker.deleteHardDriveNow()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-25-重构Java代码避免监控"><a href="#8-25-重构Java代码避免监控" class="headerlink" title="8.25  重构Java代码避免监控"></a>8.25  重构Java代码避免监控</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//没有使用继承</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmartHardDriveNuker</span>&#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过组合重用代码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HardDriveNuker hardDriveNuker;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SmartHardDriveNuker(<span class="keyword">final</span> HardDriveNuker hardDriveNuker)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//通过构造函数销毁硬盘</span></span><br><span class="line">        <span class="built_in">this</span>.hardDriveNuker = hardDriveNuker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> activate(CameraFeed cameraFeed)</span><br><span class="line">    &#123;</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">        <span class="comment">//称之为外部依赖关系的危险方法</span></span><br><span class="line">        hardDriveNuker.deleteHardDriveNow();</span><br><span class="line">        [...为了简洁，不列具体代码...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-26-用模拟代替监控"><a href="#8-26-用模拟代替监控" class="headerlink" title="8.26  用模拟代替监控"></a>8.26  用模拟代替监控</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="string">&quot;代理商在的时候，自动删除硬盘&quot;</span>() &#123;</span><br><span class="line">    <span class="symbol">given:</span> <span class="string">&quot;一种相机原料和一个假的核&quot;</span></span><br><span class="line">    CameraFeed cameraFeed = <span class="keyword">new</span> CameraFeed()</span><br><span class="line">    <span class="comment">//用模拟代替监控</span></span><br><span class="line">    HardDriveNuker nuker = Mock(HardDriveNuker)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">and:</span> <span class="string">&quot;自动销毁程序&quot;</span></span><br><span class="line">    <span class="comment">//模拟作为依赖传递</span></span><br><span class="line">    SmartHardDriveNuker smartNuker = <span class="keyword">new</span> SmartHardDriveNuker(nuker)</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span><span class="string">&quot;代理商在敲门&quot;</span></span><br><span class="line">    cameraFeed.setCurrentFrame(ImageIO.read(getClass().getResourceAsStream(</span><br><span class="line"><span class="string">&quot;agents.jpg&quot;</span>)))</span><br><span class="line">    <span class="comment">//称之为幕后的模拟销毁类</span></span><br><span class="line">    smartNuker.activate(cameraFeed);</span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span> <span class="string">&quot;硬盘上的所有文件都删除&quot;</span></span><br><span class="line">    <span class="comment">//检验模拟的交互</span></span><br><span class="line">    <span class="number">1</span> * nuker.deleteHardDriveNow()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">jbrr_gbxf</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.jbrrgbxf.com/2020/10/10/SPOCK_FUNCTIONALITY/">https://www.jbrrgbxf.com/2020/10/10/SPOCK_FUNCTIONALITY/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.jbrrgbxf.com" target="_blank">jbrrgbxf-</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/10/10/spring_boot_vue/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">《Spring Boot+Vue全栈开发实战》</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/10/Sentinel/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Sentinel</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">jbrr_gbxf</div><div class="author-info__description">jbrrgbxf---</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spock%E5%BC%80%E5%8F%91%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">Spock开发实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Spock%E6%B5%8B%E8%AF%95%E6%89%80%E4%BD%BF%E7%94%A8%E7%9A%84Groovy%E8%AF%AD%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">2. Spock测试所使用的Groovy语言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Groovy-%E7%B1%BB%E7%9A%84%E9%A3%8E%E6%A0%BC"><span class="toc-number">1.1.1.</span> <span class="toc-text">2.1 Groovy 类的风格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Groovy%E7%B1%BB%E7%9A%84%E7%BA%A6%E5%AE%9A"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.2 Groovy类的约定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84Grogy%E8%84%9A%E6%9C%AC"><span class="toc-number">1.1.3.</span> <span class="toc-text">2.3 一个简单的Grogy脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%94%A8Groovy%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99%E7%9A%84%E4%B8%80%E4%B8%AASpock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.4.</span> <span class="toc-text">2.4 用Groovy代码编写的一个Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%88%9B%E5%BB%BA%E5%B9%B6%E4%BD%BF%E7%94%A8Groovy%E4%B8%AD%E7%9A%84Java%E7%B1%BB"><span class="toc-number">1.1.5.</span> <span class="toc-text">2.5 创建并使用Groovy中的Java类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Groovy%E7%9A%84def%E6%9D%A5%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.6.</span> <span class="toc-text">2.6 Groovy的def来定义变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Groovy%E7%9A%84def%E6%9D%A5%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.7.</span> <span class="toc-text">2.7 Groovy的def来定义方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E5%9C%A8Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.8.</span> <span class="toc-text">2.8 在Spock测试中使用动态类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E5%9C%A8Groovy%E4%B8%AD%E4%B8%87%E7%89%A9%E7%9A%86%E5%8F%AFboolean"><span class="toc-number">1.1.9.</span> <span class="toc-text">2.9 在Groovy中万物皆可boolean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-%E5%9C%A8Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8java%E7%9A%84boolean"><span class="toc-number">1.1.10.</span> <span class="toc-text">2.10 在Spock测试中使用java的boolean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-%E5%85%B7%E6%9C%89%E5%A4%9A%E4%B8%AA%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E8%AF%AD%E5%8F%A5%E7%9A%84JUnit%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.11.</span> <span class="toc-text">2.11 具有多个对象创建语句的JUnit测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-%E6%B5%8B%E8%AF%95%E5%9F%BA%E4%BA%8EMAP%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E7%9A%84Spock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.12.</span> <span class="toc-text">2.12 测试基于MAP构造方法的Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-13-Groovy%E5%AF%B9%E6%AF%94%E4%B8%8A%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.13.</span> <span class="toc-text">2.13 Groovy对比上个例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-14-Groovy-Map%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.14.</span> <span class="toc-text">2.14 Groovy Map类的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-15-Groovy%E5%AF%B9%E6%AF%94java%E5%88%97%E8%A1%A8"><span class="toc-number">1.1.15.</span> <span class="toc-text">2.15 Groovy对比java列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-16-%E5%88%9B%E5%BB%BAGroovy%E5%88%97%E8%A1%A8%E5%92%8CMap%E7%9A%84%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.16.</span> <span class="toc-text">2.16 创建Groovy列表和Map的测试代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-17-%E4%BD%BF%E7%94%A8Groovy%E5%88%97%E8%A1%A8"><span class="toc-number">1.1.17.</span> <span class="toc-text">2.17 使用Groovy列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-18-%E4%BD%BF%E7%94%A8Groovy-MAP"><span class="toc-number">1.1.18.</span> <span class="toc-text">2.18 使用Groovy MAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-19-%E4%BD%BF%E7%94%A8Groovy-strings"><span class="toc-number">1.1.19.</span> <span class="toc-text">2.19 使用Groovy strings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-20-%E4%BD%BF%E7%94%A8Groovy%E5%A4%9A%E8%A1%8C%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.1.20.</span> <span class="toc-text">2.20 使用Groovy多行字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-21-%E4%BB%8E%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AF%BB%E5%8F%96Spock%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.21.</span> <span class="toc-text">2.21 从文件中读取Spock测试数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-22-%E7%94%A8Groovy%E8%AF%BB%E5%8F%96XML%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.22.</span> <span class="toc-text">2.22 用Groovy读取XML文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-23-%E7%94%A8Groovy%E8%AF%BB%E5%8F%96JSON%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.23.</span> <span class="toc-text">2.23 用Groovy读取JSON文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-24-Groovy%E9%97%AD%E5%8C%85"><span class="toc-number">1.1.24.</span> <span class="toc-text">2.24 Groovy闭包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-25-%E5%9C%A8Spoke%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8Groovy%E9%97%AD%E5%8C%85"><span class="toc-number">1.1.25.</span> <span class="toc-text">2.25 在Spoke测试中使用Groovy闭包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-26-Java%E4%B8%AD%E7%9A%84%E5%9F%9F%E7%B1%BB"><span class="toc-number">1.1.26.</span> <span class="toc-text">2.26 Java中的域类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-27-%E4%BD%BF%E7%94%A8Groovy%E6%9E%84%E5%BB%BA%E5%99%A8%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.27.</span> <span class="toc-text">2.27 使用Groovy构建器快速创建对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-28-%E4%BD%BF%E7%94%A8Expando%E6%A8%A1%E6%8B%9F%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.1.28.</span> <span class="toc-text">2.28 使用Expando模拟接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-29-%E4%BD%BF%E7%94%A8%E4%B8%80%E4%B8%AAGroovy-Expando%E4%BD%9C%E4%B8%BA%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">1.1.29.</span> <span class="toc-text">2.29 使用一个Groovy Expando作为测试数据生成器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Spock%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text">3. Spock的功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%B8%80%E4%B8%AAJava%E7%9A%84%E7%81%AB%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">3.1 一个Java的火控系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%81%AB%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84JUnit%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">3.2 火控系统的JUnit测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%85%B7%E6%9C%89%E5%A4%8D%E6%9D%82%E7%BB%93%E6%9E%84%E7%9A%84JUnit%E6%B5%8B%E8%AF%95-%E5%AE%9E%E9%99%85%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.3 具有复杂结构的JUnit测试(实际示例)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-JUnit%E6%B5%8B%E8%AF%95%E6%B5%8B%E8%AF%95%E4%B8%A4%E4%BB%B6%E4%BA%8B%E2%80%94%E2%80%94%E4%B8%8D%E8%A6%81%E8%BF%99%E6%A0%B7%E5%81%9A"><span class="toc-number">1.2.4.</span> <span class="toc-text">3.4 JUnit测试测试两件事——不要这样做</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E7%81%AB%E6%8E%A7%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%85%A8%E9%83%A8Spock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.5.</span> <span class="toc-text">3.5 火控系统的全部Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%BD%BF%E7%94%A8JUnit%E6%B5%8B%E8%AF%95%E6%A0%B8%E5%8F%8D%E5%BA%94%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.6.</span> <span class="toc-text">3.6 使用JUnit测试核反应的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E4%BD%BF%E7%94%A8Spock%E6%B5%8B%E8%AF%95%E6%A0%B8%E5%8F%8D%E5%BA%94%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.7.</span> <span class="toc-text">3.7 使用Spock测试核反应的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E6%B8%A9%E5%BA%A6%E7%9B%91%E6%8E%A7%E5%99%A8%E5%92%8C%E8%AF%BB%E5%8F%96%E5%99%A8%E7%9A%84Java%E7%B1%BB"><span class="toc-number">1.2.8.</span> <span class="toc-text">3.8 温度监控器和读取器的Java类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-%E4%BD%BF%E7%94%A8Spock%E7%9A%84Stubbing"><span class="toc-number">1.2.9.</span> <span class="toc-text">3.9 使用Spock的Stubbing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-10-%E6%B8%A9%E5%BA%A6%E7%9B%91%E6%8E%A7%E5%99%A8%E3%80%81%E8%AF%BB%E5%8F%96%E5%99%A8%E5%92%8C%E5%8F%8D%E5%BA%94%E6%8E%A7%E5%88%B6%E7%9A%84Java%E7%B1%BB"><span class="toc-number">1.2.10.</span> <span class="toc-text">3.10 温度监控器、读取器和反应控制的Java类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-%E4%BD%BF%E7%94%A8Spock%E7%9A%84mocking%E5%92%8Cstubbing"><span class="toc-number">1.2.11.</span> <span class="toc-text">3.11 使用Spock的mocking和stubbing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-12-Spock%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84mocking-stubbing"><span class="toc-number">1.2.12.</span> <span class="toc-text">3.12 Spock参数化测试中的mocking&#x2F;stubbing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8Spock%E7%BC%96%E5%86%99%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">4.使用Spock编写单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E4%B8%AD%E7%9A%84Spock%E5%9D%97"><span class="toc-number">1.3.1.</span> <span class="toc-text">4.1  测试方法中的Spock块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E7%94%B5%E5%AD%90%E8%B4%AD%E7%89%A9%E7%AF%AE%E7%9A%84Java%E6%A1%86%E6%9E%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">4.2 电子购物篮的Java框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-given-when-then-%E4%B8%89%E5%90%88%E4%BC%9A"><span class="toc-number">1.3.3.</span> <span class="toc-text">4.3 given-when-then 三合会</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BD%BF%E7%94%A8setup%E5%88%AB%E5%90%8D"><span class="toc-number">1.3.4.</span> <span class="toc-text">4.4 使用setup别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E4%B8%8D%E5%B9%B3%E5%87%A1%E7%9A%84when%E5%9D%97%E2%80%94%E2%80%94%E8%AF%B7%E5%8B%BF%E8%BF%99%E6%A0%B7%E5%81%9A"><span class="toc-number">1.3.5.</span> <span class="toc-text">4.5 不平凡的when块——请勿这样做</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E6%8F%8F%E8%BF%B0%E6%80%A7when%E5%9D%97"><span class="toc-number">1.3.6.</span> <span class="toc-text">4.6 描述性when块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E6%97%A0%E6%95%88%E7%9A%84then%E5%9D%97"><span class="toc-number">1.3.7.</span> <span class="toc-text">4.7 无效的then块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8%E4%BD%BF%E7%94%A8and%E5%88%86%E5%89%B2when%E5%9D%97"><span class="toc-number">1.3.8.</span> <span class="toc-text">4.8使用and分割when块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9-%E4%BD%BF%E7%94%A8and%E6%8B%86%E5%88%86when%E5%9D%97"><span class="toc-number">1.3.9.</span> <span class="toc-text">4.9 使用and拆分when块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-10-%E4%BD%BF%E7%94%A8and%E4%BD%9C%E4%B8%BAthen%E5%9D%97%E7%9A%84%E6%89%A9%E5%B1%95"><span class="toc-number">1.3.10.</span> <span class="toc-text">4.10 使用and作为then块的扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-11-%E5%85%B7%E6%9C%89expect%E5%9D%97%E7%9A%84%E7%90%90%E7%A2%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.11.</span> <span class="toc-text">4.11 具有expect块的琐碎测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-12-expect%E5%9D%97%E6%9B%BF%E6%8D%A2when%E5%92%8Cthen"><span class="toc-number">1.3.12.</span> <span class="toc-text">4.12 expect块替换when和then</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-13-%E4%BD%BF%E7%94%A8expect%E4%BD%9C%E4%B8%BA%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.13.</span> <span class="toc-text">4.13 使用expect作为前提条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-14-%E5%8D%B3%E4%BD%BF%E6%B5%8B%E8%AF%95%E5%A4%B1%E8%B4%A5%E4%BD%BF%E7%94%A8cleanup%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%87%8A%E6%94%BE%E8%B5%84%E6%BA%90"><span class="toc-number">1.3.14.</span> <span class="toc-text">4.14 即使测试失败使用cleanup也可以释放资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-15-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E5%87%86%E7%A1%AE%E6%8F%8F%E8%BF%B0%E4%BA%86%E8%A6%81%E6%B5%8B%E8%AF%95%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.3.15.</span> <span class="toc-text">4.15 测试方法准确描述了要测试的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-16-%E6%A0%87%E8%AE%B0%E8%A2%AB%E6%B5%8B%E8%AF%BE%E7%A8%8B"><span class="toc-number">1.3.16.</span> <span class="toc-text">4.16 标记被测课程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-17-%E7%BC%96%E5%86%99Spock%E8%A7%84%E8%8C%83"><span class="toc-number">1.3.17.</span> <span class="toc-text">4.17 编写Spock规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-18-%E7%BC%96%E5%86%99%E5%AE%8C%E6%95%B4%E7%9A%84Spock%E8%A7%84%E8%8C%83"><span class="toc-number">1.3.18.</span> <span class="toc-text">4.18 编写完整的Spock规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-19-%E6%8F%90%E5%8F%96%E9%80%9A%E7%94%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.19.</span> <span class="toc-text">4.19 提取通用初始化代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-20-%E6%8F%90%E5%8F%96%E5%B8%B8%E8%A7%81%E7%9A%84%E5%89%8D%E5%90%8E%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.20.</span> <span class="toc-text">4.20 提取常见的前后条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-21-%E6%89%80%E6%9C%89Spock%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.21.</span> <span class="toc-text">4.21 所有Spock生命周期方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-22-%E4%BD%BF%E7%94%A8-Shared%E6%B3%A8%E5%85%A5"><span class="toc-number">1.3.22.</span> <span class="toc-text">4.22 使用@Shared注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-23-%E4%BD%BF%E7%94%A8old-%E6%96%B9%E6%B3%95%E6%96%AD%E8%A8%80"><span class="toc-number">1.3.23.</span> <span class="toc-text">4.23 使用old() 方法断言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-24-%E5%A4%9A%E4%B8%AAwhen-then%E5%9D%97"><span class="toc-number">1.3.24.</span> <span class="toc-text">4.24  多个when-then块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-25-%E9%81%BF%E5%85%8D%E7%BC%BA%E5%B0%91%E5%9D%97%E6%B3%A8%E9%87%8A"><span class="toc-number">1.3.25.</span> <span class="toc-text">4.25  避免缺少块注释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-26-%E5%B0%86%E6%9F%90%E4%B8%AA%E5%95%86%E5%93%81%E5%9C%A8%E8%B4%AD%E7%89%A9%E8%BD%A6%E6%B7%BB%E5%8A%A0%E4%B8%A4%E6%AC%A1"><span class="toc-number">1.3.26.</span> <span class="toc-text">4.26  将某个商品在购物车添加两次</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-27-%E5%B8%AE%E5%8A%A9%E5%91%88%E7%8E%B0toString-%E6%96%B9%E6%B3%95%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E9%A1%B9"><span class="toc-number">1.3.27.</span> <span class="toc-text">4.27  帮助呈现toString() 方法中的错误项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-28-Spock%E5%AF%B9Hamcrest-matchers%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">1.3.28.</span> <span class="toc-text">4.28 Spock对Hamcrest matchers的支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-29-Hamcrest-matchers%E4%B8%AD%E5%8F%AF%E9%80%89%E6%8B%A9%E7%9A%84Spock%E6%94%AF%E6%8C%81%E9%80%89%E9%A1%B9"><span class="toc-number">1.3.29.</span> <span class="toc-text">4.29 Hamcrest matchers中可选择的Spock支持选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-30-%E5%9C%A8Spock%E6%96%AD%E8%A8%80%E4%B8%AD%E4%BD%BF%E7%94%A8Groovy%E9%97%AD%E5%8C%85"><span class="toc-number">1.3.30.</span> <span class="toc-text">4.30  在Spock断言中使用Groovy闭包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-31-%E4%B8%80%E4%B8%AA%E5%81%87%E8%AE%BE%E7%9A%84%E4%BB%93%E5%BA%93"><span class="toc-number">1.3.31.</span> <span class="toc-text">4.31 一个假设的仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-32-%E4%B8%80%E4%B8%AA%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-number">1.3.32.</span> <span class="toc-text">4.32 一个企业级购物车</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-33-%E5%90%8C%E4%B8%80%E5%AF%B9%E8%B1%A1%E4%B8%8A%E7%9A%84%E6%96%AD%E8%A8%80%E5%92%8C%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.3.33.</span> <span class="toc-text">4.33 同一对象上的断言和设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-34-%E7%94%A8Groovy%E5%92%8CSpock%E5%AF%B9%E7%9B%B8%E4%BC%BC%E4%BB%A3%E7%A0%81%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84"><span class="toc-number">1.3.34.</span> <span class="toc-text">4.34 用Groovy和Spock对相似代码进行分组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.</span> <span class="toc-text">5. 参数化测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E9%81%BF%E5%85%8D%E5%81%9A%E9%87%8D%E5%A4%8D%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.1.</span> <span class="toc-text">5.1 避免做重复测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E7%AE%80%E5%8D%95%E7%9A%84Spock%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.2.</span> <span class="toc-text">5.2 简单的Spock参数化测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-given-when-then-where%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.3.</span> <span class="toc-text">5.3 given-when-then-where结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%9C%A8Spock%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text">5.4 在Spock中使用数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%9C%A8Spock%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%B8%A6%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">1.4.5.</span> <span class="toc-text">5.5  在Spock中使用带参数类型的数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E4%B8%80%E5%88%97%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">1.4.6.</span> <span class="toc-text">5.6  一列数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-%E5%9C%A8%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%B8%AD%E6%8D%95%E8%8E%B7%E4%B8%9A%E5%8A%A1%E9%9C%80%E6%B1%82"><span class="toc-number">1.4.7.</span> <span class="toc-text">5.7  在数据表中捕获业务需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.4.8.</span> <span class="toc-text">5.8 参数化测试的生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-9-%E5%B1%95%E5%BC%80%E5%8F%82%E6%95%B0%E5%8C%96%E5%9C%BA%E6%99%AF"><span class="toc-number">1.4.9.</span> <span class="toc-text">5.9 展开参数化场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-10-%E6%89%93%E5%8D%B0%E6%AF%8F%E4%B8%AA%E5%9C%BA%E6%99%AF%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.10.</span> <span class="toc-text">5.10  打印每个场景的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-11-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E4%B8%8A%E7%9A%84%E5%8F%82%E6%95%B0%E5%91%88%E7%8E%B0"><span class="toc-number">1.4.11.</span> <span class="toc-text">5.11 测试方法上的参数呈现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-12-%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%B8%AD%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.4.12.</span> <span class="toc-text">5.12 数据表中的自定义表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-13-%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E7%AE%A1%E9%81%93%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.4.13.</span> <span class="toc-text">5.13 简单的数据管道示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-14-%E7%94%A8Groovy-rangs%E5%81%9A%E4%B8%BA%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">1.4.14.</span> <span class="toc-text">5.14 用Groovy rangs做为数据生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-15-%E4%BD%BF%E7%94%A8groovy%E7%BB%84%E5%90%88"><span class="toc-number">1.4.15.</span> <span class="toc-text">5.15 使用groovy组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-16-Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E5%B8%B8%E9%87%8F%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.16.</span> <span class="toc-text">5.16 Spock测试中的常量参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-17-Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E6%B4%BE%E7%94%9F%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.17.</span> <span class="toc-text">5.17 Spock测试中的派生参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-18-%E4%BD%BF%E7%94%A8%E7%8E%B0%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">1.4.18.</span> <span class="toc-text">5.18 使用现存的数据生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-19-%E4%BD%BF%E7%94%A8%E4%B8%93%E7%94%A8%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">1.4.19.</span> <span class="toc-text">5.19 使用专用数据生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-20-Spock%E4%B8%AD%E4%BD%BF%E7%94%A8Java%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.4.20.</span> <span class="toc-text">5.20 Spock中使用Java迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-21-Spock%E4%B8%AD%E4%BD%BF%E7%94%A8Java%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.4.21.</span> <span class="toc-text">5.21 Spock中使用Java迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-22-Spock%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E5%80%BC%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-number">1.4.22.</span> <span class="toc-text">5.22 Spock中使用多值迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-23-Spock%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E5%80%BC%E5%88%86%E9%85%8D"><span class="toc-number">1.4.23.</span> <span class="toc-text">5.23 Spock中使用多值分配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Mocking-and-stubbing"><span class="toc-number">1.5.</span> <span class="toc-text">6. Mocking and stubbing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%8B%9F%E5%90%88%E4%BD%9C%E8%80%85"><span class="toc-number">1.5.1.</span> <span class="toc-text">6.1 使用模拟合作者</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8stub%E6%8E%A7%E5%88%B6%E5%AF%B9%E8%A2%AB%E6%B5%8B%E7%B1%BB%E7%9A%84%E8%BE%93%E5%85%A5"><span class="toc-number">1.5.2.</span> <span class="toc-text">6.2 使用stub控制对被测类的输入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Stub%E7%89%B9%E5%AE%9A%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.3.</span> <span class="toc-text">6.3 Stub特定的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%9F%BA%E4%BA%8E%E5%8F%82%E6%95%B0%E7%9A%84stub%E5%8C%BA%E5%88%86"><span class="toc-number">1.5.4.</span> <span class="toc-text">6.4 基于参数的stub区分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E5%AF%B9%E6%89%80%E6%9C%89%E7%9A%84stub%E6%96%B9%E6%B3%95%E5%88%86%E7%BB%84"><span class="toc-number">1.5.5.</span> <span class="toc-text">6.5 对所有的stub方法分组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E5%9C%A8stub%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%8F%82%E6%95%B0%E5%8C%B9%E9%85%8D%E5%99%A8"><span class="toc-number">1.5.6.</span> <span class="toc-text">6.6 在stub中使用参数匹配器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%97%B6%EF%BC%8C%E5%BF%BD%E7%95%A5stub%E6%96%B9%E6%B3%95%E7%9A%84%E6%89%80%E6%9C%89%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.7.</span> <span class="toc-text">6.7 返回结果时，忽略stub方法的所有参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-Stub%E5%90%8E%E7%BB%AD%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="toc-number">1.5.8.</span> <span class="toc-text">6.8 Stub后续方法调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-9-%E6%8C%87%E7%A4%BAstub%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8"><span class="toc-number">1.5.9.</span> <span class="toc-text">6.9 指示stub抛出异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-10-%E6%A0%B9%E6%8D%AE%E5%8F%82%E6%95%B0%E5%93%8D%E5%BA%94%E7%9A%84stub"><span class="toc-number">1.5.10.</span> <span class="toc-text">6.10 根据参数响应的stub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-10-%E6%A0%B9%E6%8D%AE%E5%8F%82%E6%95%B0%E5%93%8D%E5%BA%94%E7%9A%84stub-1"><span class="toc-number">1.5.11.</span> <span class="toc-text">6.10 根据参数响应的stub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-11-%E6%99%BA%E8%83%BDstub-%E6%9F%A5%E7%9C%8B%E5%AE%83%E7%9A%84%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.12.</span> <span class="toc-text">6.11 智能stub:查看它的两个参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-12-%E7%94%A8%E5%85%B6%E4%BB%96stub%E5%AF%B9%E5%93%8D%E5%BA%94%E8%BF%9B%E8%A1%8Cstub"><span class="toc-number">1.5.13.</span> <span class="toc-text">6.12 用其他stub对响应进行stub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-13-stubbing%E5%92%8Cmock"><span class="toc-number">1.5.14.</span> <span class="toc-text">6.13 stubbing和mock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-14-%E4%BF%A1%E7%94%A8%E5%8D%A1%E6%94%B6%E8%B4%B9%E7%9A%84Java%E6%A1%86%E6%9E%B6"><span class="toc-number">1.5.15.</span> <span class="toc-text">6.14 信用卡收费的Java框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-15-mock%E6%96%B9%E6%B3%95%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="toc-number">1.5.16.</span> <span class="toc-text">6.15 mock方法的验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-16-mock%E6%96%B9%E6%B3%95%E7%9A%84%E7%89%B9%E5%AE%9A%E9%A1%BA%E5%BA%8F%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="toc-number">1.5.17.</span> <span class="toc-text">6.16 mock方法的特定顺序的验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-17-%E4%BA%A4%E4%BA%92%E7%9A%84%E6%98%8E%E7%A1%AE%E5%A3%B0%E6%98%8E"><span class="toc-number">1.5.18.</span> <span class="toc-text">6.17 交互的明确声明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-18-%E9%AA%8C%E8%AF%81%E7%B1%BB%E4%B8%AD%E6%89%80%E6%9C%89%E6%96%B9%E6%B3%95%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="toc-number">1.5.19.</span> <span class="toc-text">6.18 验证类中所有方法的交互</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-19-%E9%AA%8C%E8%AF%81%E6%89%80%E6%9C%89mock%E7%9A%84%E9%9D%9E%E4%BA%A4%E4%BA%92%E6%80%A7"><span class="toc-number">1.5.20.</span> <span class="toc-text">6.19 验证所有mock的非交互性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-20-%E5%BD%93%E8%B0%83%E7%94%A8mock%E7%9A%84%E6%96%B9%E6%B3%95%E6%97%B6%EF%BC%8C%E9%AA%8C%E8%AF%81%E5%8F%82%E6%95%B0%E4%B8%8D%E4%B8%BA%E7%A9%BA"><span class="toc-number">1.5.21.</span> <span class="toc-text">6.20 当调用mock的方法时，验证参数不为空</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-21-%E9%AA%8C%E8%AF%81%E5%8F%82%E6%95%B0%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.5.22.</span> <span class="toc-text">6.21 验证参数的类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-22-%E9%AA%8C%E8%AF%81mock%E6%96%B9%E6%B3%95%E7%9A%84%E7%B2%BE%E7%A1%AE%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.23.</span> <span class="toc-text">6.22 验证mock方法的精确参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-23-%E9%AA%8C%E8%AF%81%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%E7%94%A8%E4%BD%9Cmock%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.24.</span> <span class="toc-text">6.23 验证对象实例的一部分用作mock参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-24-%E4%BD%BF%E7%94%A8%E5%AE%8C%E6%95%B4%E7%9A%84Groovy%E9%97%AD%E5%8C%85%E8%BF%9B%E8%A1%8C%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81"><span class="toc-number">1.5.25.</span> <span class="toc-text">6.24 使用完整的Groovy闭包进行参数验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-25-%E5%9C%A8%E5%90%8C%E4%B8%80%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8mock%E5%92%8Cstub"><span class="toc-number">1.5.26.</span> <span class="toc-text">6.25 在同一测试中使用mock和stub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-26-%E9%AA%8C%E8%AF%81%E4%BA%8B%E4%BB%B6%E7%9A%84%E9%A1%BA%E5%BA%8F%E4%B8%8E%E4%BA%92%E8%BF%9E%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="toc-number">1.5.27.</span> <span class="toc-text">6.26 验证事件的顺序与互连方法调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Spock%E7%9A%84%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E5%92%8C%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.</span> <span class="toc-text">7. Spock的集成测试和功能测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E4%BB%8ESpock%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AESpring%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.6.1.</span> <span class="toc-text">7.1 从Spock测试访问Spring上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E8%87%AA%E5%8A%A8%E5%9B%9E%E6%BB%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E6%9B%B4%E6%94%B9"><span class="toc-number">1.6.2.</span> <span class="toc-text">7.2 自动回滚数据库的更改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E4%BD%BF%E7%94%A8%E7%AE%80%E5%8C%96%E7%9A%84Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.3.</span> <span class="toc-text">7.3 使用简化的Spring上下文进行单元测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E5%9C%A8Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8Groovy-SQL%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="toc-number">1.6.4.</span> <span class="toc-text">7.4 在Spock测试中使用Groovy SQL准备数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E5%9C%A8Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8Groovy-SQL%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE-%E6%94%B9%E8%BF%9B%E7%89%88"><span class="toc-number">1.6.5.</span> <span class="toc-text">7.5 在Spock测试中使用Groovy SQL准备数据 - 改进版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BASpring%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.6.6.</span> <span class="toc-text">7.6 手动创建Spring上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-%E4%BD%BF%E7%94%A8Spock%E5%92%8Cspring-ResTemplate%E6%B5%8B%E8%AF%95REST%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.7.</span> <span class="toc-text">7.7 使用Spock和spring ResTemplate测试REST服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-8-%E6%8C%89%E9%A1%BA%E5%BA%8F%E8%BF%90%E8%A1%8C%E5%A4%9A%E4%B8%AA%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">1.6.8.</span> <span class="toc-text">7.8 按顺序运行多个测试方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-9-%E5%9C%A8Spock-test-%E4%B8%AD%E4%BD%BF%E7%94%A8Groovy-RESTClient"><span class="toc-number">1.6.9.</span> <span class="toc-text">7.9 在Spock test 中使用Groovy RESTClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-10-%E5%90%8C%E6%97%B6%E4%BD%BF%E7%94%A8Geb%E5%92%8CSpock%EF%BC%8C%E5%8A%A0%E8%BD%BDWeb%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-number">1.6.10.</span> <span class="toc-text">7.10 同时使用Geb和Spock，加载Web浏览器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-11-%E4%BD%BF%E7%94%A8Geb%E8%8E%B7%E5%8F%96%E9%A1%B5%E9%9D%A2%E5%86%85%E5%AE%B9"><span class="toc-number">1.6.11.</span> <span class="toc-text">7.11 使用Geb获取页面内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-12-%E4%BD%BF%E7%94%A8Geb%E6%9D%A5%E6%8F%90%E4%BA%A4HTML%E8%A1%A8%E5%8D%95"><span class="toc-number">1.6.12.</span> <span class="toc-text">7.12 使用Geb来提交HTML表单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-13-%E5%9C%A8Tomcat%E4%B8%AD%E8%BF%90%E8%A1%8CSpock%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.13.</span> <span class="toc-text">7.13 在Tomcat中运行Spock功能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-14-%E5%9C%A8Spock%E4%B8%AD%E4%BD%BF%E7%94%A8JaCoCo"><span class="toc-number">1.6.14.</span> <span class="toc-text">7.14 在Spock中使用JaCoCo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Spock%E5%9C%A8%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.7.</span> <span class="toc-text">8 Spock在企业级测试中的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-Spock%E4%B8%AD%E5%AF%B9%E5%BC%82%E5%B8%B8%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.1.</span> <span class="toc-text">8.1 Spock中对异常的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E4%B8%80%E4%B8%AA%E9%A2%84%E6%9C%9F%E5%BC%82%E5%B8%B8%E7%9A%84%E7%BB%86%E8%8A%82%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">8.2 一个预期异常的细节测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E6%98%8E%E7%A1%AE%E7%9A%84%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA%E5%BC%82%E5%B8%B8%E4%B8%8D%E5%BA%94%E8%AF%A5%E6%8A%9B%E5%87%BA"><span class="toc-number">1.7.3.</span> <span class="toc-text">8.3 明确的声明一个异常不应该抛出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E6%A0%87%E8%AE%B0%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E6%89%80%E8%A7%A3%E5%86%B3%E7%9A%84%E7%BC%BA%E9%99%B7%E6%88%96%E9%97%AE%E9%A2%98"><span class="toc-number">1.7.4.</span> <span class="toc-text">8.4 标记一个测试方法所解决的缺陷或问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-%E6%A0%87%E8%AE%B0%E4%B8%80%E4%B8%AASpock%E6%89%80%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98%E7%9A%84%E9%93%BE%E6%8E%A5"><span class="toc-number">1.7.5.</span> <span class="toc-text">8.5 标记一个Spock所解决问题的链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-%E7%94%A8%E5%A4%9A%E4%B8%AAissues%E6%A0%87%E8%AE%B0Spock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.6.</span> <span class="toc-text">8.6 用多个issues标记Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-%E5%A3%B0%E6%98%8E%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%9A%84%E6%9C%80%E5%A4%A7%E6%97%B6%E9%95%BF"><span class="toc-number">1.7.7.</span> <span class="toc-text">8.7 声明一个测试的最大时长</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-8-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%E8%80%97%E6%97%B6%E9%99%90%E5%88%B6"><span class="toc-number">1.7.8.</span> <span class="toc-text">8.8 自定义一个测试耗时限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-9-%E5%BF%BD%E7%95%A5%E6%9F%90%E4%B8%AA%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.9.</span> <span class="toc-text">8.9 忽略某个测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-10-%E5%8F%AA%E6%89%A7%E8%A1%8C%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%EF%BC%8C%E5%BF%BD%E7%95%A5%E5%85%B6%E4%BB%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.10.</span> <span class="toc-text">8.10  只执行一个测试，忽略其他测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-11-%E6%A0%B9%E6%8D%AE%E7%8E%AF%E5%A2%83%E8%B7%B3%E8%BF%87Spock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.11.</span> <span class="toc-text">8.11 根据环境跳过Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-12-%E5%9F%BA%E4%BA%8E%E5%8A%A8%E6%80%81%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BF%87Spock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.12.</span> <span class="toc-text">8.12  基于动态前提条件跳过Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-13-Requires%E2%80%94%E2%80%94IgnoreIf%E7%9A%84%E5%8F%8D%E4%B9%89%E8%AF%8D"><span class="toc-number">1.7.13.</span> <span class="toc-text">8.13  Requires——IgnoreIf的反义词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-14-%E4%BD%BF%E7%94%A8AutoCleanup%E9%87%8A%E6%94%BE%E8%B5%84%E6%BA%90"><span class="toc-number">1.7.14.</span> <span class="toc-text">8.14  使用AutoCleanup释放资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-15-%E4%B8%8D%E8%A6%81%E8%8A%B1%E9%95%BF%E6%97%B6%E9%97%B4%E8%AE%BE%E7%BD%AE%E4%B8%80%E4%B8%AASpock%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.15.</span> <span class="toc-text">8.15 不要花长时间设置一个Spock测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-16-Spock%E6%B5%8B%E8%AF%95%E7%9A%84%E5%B8%AE%E5%8A%A9%E5%99%A8"><span class="toc-number">1.7.16.</span> <span class="toc-text">8.16  Spock测试的帮助器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-17-%E5%9C%A8%E6%B5%8B%E8%AF%95%E4%B8%AD%E7%94%A8%E5%8F%82%E6%95%B0%E6%9D%A5%E4%BD%93%E7%8E%B0%E9%87%8D%E8%A6%81%E6%80%A7"><span class="toc-number">1.7.17.</span> <span class="toc-text">8.17  在测试中用参数来体现重要性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-18-Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%B8%8D%E7%A1%AE%E5%AE%9A%E7%9A%84then%EF%BC%9A%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.18.</span> <span class="toc-text">8.18 Spock测试中不确定的then：模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-19-%E6%9C%89%E6%98%8E%E7%A1%AE%E5%88%86%E5%8C%BA%E6%A3%80%E6%9F%A5%E7%9A%84Spock%E6%B5%8B%E8%AF%95%E8%BF%9B%E9%98%B6%E7%89%88"><span class="toc-number">1.7.19.</span> <span class="toc-text">8.19  有明确分区检查的Spock测试进阶版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-20-%E4%BD%BF%E7%94%A8%E5%B8%AE%E5%8A%A9%E5%99%A8%E8%AE%A4%E5%AE%9A"><span class="toc-number">1.7.20.</span> <span class="toc-text">8.20  使用帮助器认定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-21-Spock%E6%B5%8B%E8%AF%95%E4%B8%AD%E6%9C%89%E9%97%AE%E9%A2%98%E7%9A%84then%EF%BC%9A%E6%A8%A1%E5%9D%97"><span class="toc-number">1.7.21.</span> <span class="toc-text">8.21 Spock测试中有问题的then：模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-22-%E5%9C%A8%E4%BA%A4%E4%BA%92%E6%97%B6%E6%98%8E%E7%A1%AE%E5%A3%B0%E6%98%8E%E4%BD%BF%E7%94%A8%E7%9A%84%E5%B8%AE%E5%8A%A9%E5%99%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.22.</span> <span class="toc-text">8.22  在交互时明确声明使用的帮助器方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-23-%E8%AE%BE%E8%AE%A1%E6%9C%89%E9%97%AE%E9%A2%98%E7%9A%84Java%E4%BB%A3%E7%A0%81"><span class="toc-number">1.7.23.</span> <span class="toc-text">8.23  设计有问题的Java代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-24-%E7%94%A8spock%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E7%9B%91%E6%8E%A7"><span class="toc-number">1.7.24.</span> <span class="toc-text">8.24  用spock生成一个监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-25-%E9%87%8D%E6%9E%84Java%E4%BB%A3%E7%A0%81%E9%81%BF%E5%85%8D%E7%9B%91%E6%8E%A7"><span class="toc-number">1.7.25.</span> <span class="toc-text">8.25  重构Java代码避免监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-26-%E7%94%A8%E6%A8%A1%E6%8B%9F%E4%BB%A3%E6%9B%BF%E7%9B%91%E6%8E%A7"><span class="toc-number">1.7.26.</span> <span class="toc-text">8.26  用模拟代替监控</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/03/DatabaseRidder/" title="Database Rider入门（入坑）指南"><img src="https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=4188144618,2898836995&amp;fm=26&amp;gp=0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Database Rider入门（入坑）指南"/></a><div class="content"><a class="title" href="/2020/12/03/DatabaseRidder/" title="Database Rider入门（入坑）指南">Database Rider入门（入坑）指南</a><time datetime="2020-12-03T06:12:35.606Z" title="发表于 2020-12-03 14:12:35">2020-12-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/03/emoji/" title="emoji集合"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="emoji集合"/></a><div class="content"><a class="title" href="/2020/12/03/emoji/" title="emoji集合">emoji集合</a><time datetime="2020-12-03T01:59:43.691Z" title="发表于 2020-12-03 09:59:43">2020-12-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/01/repositoryTest/" title="仓库测试操作步骤"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="仓库测试操作步骤"/></a><div class="content"><a class="title" href="/2020/12/01/repositoryTest/" title="仓库测试操作步骤">仓库测试操作步骤</a><time datetime="2020-12-01T02:59:25.037Z" title="发表于 2020-12-01 10:59:25">2020-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/23/ControllerTest/" title="Controller Test"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Controller Test"/></a><div class="content"><a class="title" href="/2020/11/23/ControllerTest/" title="Controller Test">Controller Test</a><time datetime="2020-11-23T04:00:50.570Z" title="发表于 2020-11-23 12:00:50">2020-11-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/11/15/2020.11.15/" title="2020.11.15"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2020.11.15"/></a><div class="content"><a class="title" href="/2020/11/15/2020.11.15/" title="2020.11.15">2020.11.15</a><time datetime="2020-11-15T00:55:09.666Z" title="发表于 2020-11-15 08:55:09">2020-11-15</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By jbrr_gbxf</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"width":160,"height":320,"bottom":-120},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>